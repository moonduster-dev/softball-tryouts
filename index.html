
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Lady of Good Counsel High School 2026 Softball Tryouts</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    <!-- Password Protection Screen -->
    <div id="passwordScreen" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <!-- Logo on password screen -->
                <img
                    src="GClogo.jpg"
                    alt="Logo"
                    class="h-20 w-20 object-contain mx-auto mb-4"
                    id="passwordLogo"
                />
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üîí Softball Tryout Scorer</h1>
                <p class="text-gray-600">Enter password to access</p>
            </div>
            <div class="space-y-4">
                <input
                    type="password"
                    id="passwordInput"
                    placeholder="Enter password"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg"
                    onkeypress="if(event.key === 'Enter') checkPassword()"
                    autofocus
                />
                <button
                    onclick="checkPassword()"
                    class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-lg"
                >
                    Unlock
                </button>
                <div id="passwordError" class="text-red-600 text-center text-sm" style="display: none;">
                    ‚ùå Incorrect password. Please try again.
                </div>
            </div>
            <div class="mt-6 text-center text-sm text-gray-500">
                Contact your coach if you don't have the password
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto" id="appContent" style="display: none;">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col gap-4">
                <!-- Logo Image -->
                <div class="flex justify-center">
                    <img
                        src="GClogo.jpg"
                        alt="Logo"
                        class="h-24 w-24 object-contain"
                        id="appLogo"
                    />
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Our Lady of Good Counsel High School 2026 Softball Tryouts</h1>
                    <p class="text-gray-600">Track Player Performance Across Key Categories</p>
                </div>
                <div class="flex gap-2 flex-wrap justify-center">
                    <button
                        onclick="clearAllData()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"
                    >
                        üóëÔ∏è Clear All Data
                    </button>
                    <button
                        onclick="document.getElementById('advancedOptions').classList.toggle('hidden')"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2"
                    >
                        ‚öôÔ∏è Advanced Options
                    </button>
                </div>

                <!-- Advanced Options (Hidden by default) -->
                <div id="advancedOptions" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">Add Player</h3>
                    <div class="flex gap-3 flex-wrap mb-6">
                        <input
                            type="text"
                            id="playerName"
                            placeholder="Player Name"
                            class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        />
                        <input
                            type="text"
                            id="playerNumber"
                            placeholder="Jersey # (optional)"
                            class="w-40 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        />
                        <button
                            onclick="addPlayer()"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                        >
                            <span>‚ûï</span> Add Player
                        </button>
                    </div>

                    <h3 class="text-lg font-semibold mb-3">Manual Sync Options</h3>
                    <p class="text-sm text-gray-600 mb-3">Auto-sync is always active</p>
                    <div class="flex gap-2 flex-wrap justify-center">
                        <button
                            onclick="uploadToSheets()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                            title="Manually upload current data to Google Sheets"
                        >
                            ‚¨ÜÔ∏è Upload to Sheets
                        </button>
                        <button
                            onclick="downloadFromSheets()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                            title="Manually download data from Google Sheets"
                        >
                            ‚¨áÔ∏è Download from Sheets
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-sm text-green-600 flex items-center gap-2" id="saveStatus">
                üîÑ Auto-syncing with Google Sheets
            </div>
        </div>

        <!-- View Navigation Buttons -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex gap-3 flex-wrap justify-center">
                <button
                    onclick="showPlayersView()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                    id="playersViewBtn"
                >
                    üë§ Players
                </button>
                <button
                    onclick="showStationsView()"
                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center gap-2"
                    id="stationsViewBtn"
                >
                    üéØ Stations
                </button>
                <button
                    onclick="showAllPlayers()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                >
                    üìä View All
                </button>
                <button
                    onclick="showCatcherScores()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                >
                    üß§ Catcher Scores
                </button>
                <button
                    onclick="showPitcherScores()"
                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center gap-2"
                >
                    ‚öæ Pitcher Scores
                </button>
            </div>
        </div>

        <!-- Single Player View -->
        <div id="singlePlayerView" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <!-- Navigation -->
                <div class="mb-6 pb-4 border-b">
                    <div class="flex justify-between items-center mb-4">
                        <button
                            onclick="previousPlayer()"
                            id="prevBtn"
                            tabindex="-1"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            ‚¨ÖÔ∏è Previous
                        </button>
                        <div class="text-center">
                            <div class="text-sm text-gray-500" id="playerCounter">Player 1 of 1</div>
                            <div class="text-xs text-gray-400 mt-1">Use arrow keys to navigate</div>
                        </div>
                        <button
                            onclick="nextPlayer()"
                            id="nextBtn"
                            tabindex="-1"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            Next ‚û°Ô∏è
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Jump to player:</label>
                        <select
                            id="playerDropdown"
                            onchange="jumpToPlayer(this.value)"
                            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                        </select>
                    </div>
                </div>

                <!-- Player Card -->
                <div id="currentPlayerCard"></div>
            </div>
        </div>

        <!-- Stations View -->
        <div id="stationsView" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Station-Based Scoring</h2>
                <p class="text-gray-600 mb-6">Select your station, then score players as they come through</p>

                <!-- Station Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Step 1: Select Your Station</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        <button
                            onclick="selectStation('fielding')"
                            id="station-fielding"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ‚öæ Fielding
                        </button>
                        <button
                            onclick="selectStation('throwing')"
                            id="station-throwing"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            üéØ Throwing
                        </button>
                        <button
                            onclick="selectStation('attitude')"
                            id="station-attitude"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ‚≠ê Attitude
                        </button>
                        <button
                            onclick="selectStation('runsonoff')"
                            id="station-runsonoff"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            üèÉ Runs on/off Field
                        </button>
                        <button
                            onclick="selectStation('cheers')"
                            id="station-cheers"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            üì£ Cheers
                        </button>
                        <button
                            onclick="selectStation('dives')"
                            id="station-dives"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ü§∏ Dives
                        </button>
                        <button
                            onclick="selectStation('baserunning')"
                            id="station-baserunning"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ‚ö° Baserunning
                        </button>
                        <button
                            onclick="selectStation('hitting')"
                            id="station-hitting"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            üèè Hitting
                        </button>
                        <button
                            onclick="selectStation('speed')"
                            id="station-speed"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ‚ö° Speed
                        </button>
                        <button
                            onclick="selectStation('catcher')"
                            id="station-catcher"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            üß§ Catcher
                        </button>
                        <button
                            onclick="selectStation('pitching')"
                            id="station-pitching"
                            class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-blue-100 hover:text-blue-700 font-medium border-2 border-transparent transition"
                        >
                            ‚öæ Pitching
                        </button>
                    </div>
                </div>

                <!-- Player Selection -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg" id="stationPlayerSelector" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Step 2: Select Player to Score</label>
                    <select
                        id="stationPlayerDropdown"
                        onchange="selectStationPlayer(this.value)"
                        class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
                    >
                        <option value="">-- Select a player --</option>
                    </select>
                </div>

                <!-- Station Content Area -->
                <div id="stationContent" class="mt-6">
                    <div class="text-center text-gray-500 py-12">
                        <p class="text-lg">Select your station to begin</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Players View -->
        <div id="allPlayersView" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">All Players - Ranked by Total Score</h2>
                    <div class="flex gap-2">
                        <button
                            onclick="exportData()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                        >
                            <span>‚¨áÔ∏è</span> Export CSV
                        </button>
                        <button
                            onclick="showPlayersView()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                        >
                            üë§ Players View
                        </button>
                    </div>
                </div>
                <div id="playersList"></div>
            </div>
        </div>

        <!-- Catcher Scores View -->
        <div id="catcherScoresView" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üß§ Catcher Scores - Ranked by Catcher Total</h2>
                    <button
                        onclick="showAllPlayers()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                    >
                        üìä View All Players
                    </button>
                </div>
                <div id="catcherScoresList"></div>
            </div>
        </div>

        <!-- Pitcher Scores View -->
        <div id="pitcherScoresView" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">‚öæ Pitcher Scores - Ranked by Pitching Total</h2>
                    <button
                        onclick="showAllPlayers()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                    >
                        üìä View All Players
                    </button>
                </div>
                <div id="pitcherScoresList"></div>
            </div>
        </div>

        <div id="emptyState" class="bg-white rounded-lg shadow-lg p-12 text-center text-gray-500">
            <p class="text-lg">No players added yet. Add your first player to start scoring!</p>
        </div>
    </div>

    <script>
        // ============================================
        // PASSWORD PROTECTION
        // ============================================
        // CHANGE THIS PASSWORD to something secure!
        const APP_PASSWORD = 'nick2026';

        // Check if user is already authenticated
        function initPasswordProtection() {
            const isAuthenticated = sessionStorage.getItem('appAuthenticated');
            if (isAuthenticated === 'true') {
                unlockApp();
            } else {
                showPasswordScreen();
            }
        }

        function showPasswordScreen() {
            document.getElementById('passwordScreen').style.display = 'flex';
            document.getElementById('appContent').style.display = 'none';
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }

        function unlockApp() {
            document.getElementById('passwordScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            // Initialize the app
            autoDownloadFromSheets().then(() => {
                render();
            });
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('passwordError');

            if (input.value === APP_PASSWORD) {
                // Correct password
                sessionStorage.setItem('appAuthenticated', 'true');
                errorDiv.style.display = 'none';
                unlockApp();
            } else {
                // Wrong password
                errorDiv.style.display = 'block';
                input.value = '';
                input.focus();
                // Shake animation
                input.classList.add('animate-shake');
                setTimeout(() => {
                    input.classList.remove('animate-shake');
                }, 500);
            }
        }

        // Initialize password protection on page load
        window.addEventListener('DOMContentLoaded', initPasswordProtection);
        // ============================================

        // ============================================
        // GOOGLE SHEETS CONFIGURATION
        // ============================================
        // IMPORTANT: Replace this URL with your Google Apps Script Web App URL
        // Instructions in google-apps-script.js file
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBHrnFROHXG2Hg0sQ5l-v4eUHhqCrdKIjXNUbqVWHAQLR27I6PEQseD-heGi9QW7MFQA/exec';
        // ============================================

        let players = [];
        let currentPlayerIndex = 0;
        let viewMode = 'stations'; // 'players', 'stations', or 'all'
        let selectedStationPlayer = null; // Player ID for station view
        let selectedStation = null; // Current station: 'fielding', 'throwing', 'attitude', 'hitting', 'speed'
        let isSyncing = false;
        let autoUploadTimer = null; // Timer for debouncing auto-upload

        const STORAGE_KEY = 'softball_tryout_data';
        const AUTO_UPLOAD_DELAY = 2000; // 2 seconds debounce

        const categories = [
            { id: 'fielding', name: 'Fielding', max: 10 },
            { id: 'throwing', name: 'Throwing', max: 10 }
        ];

        const hustleEnergyCategories = [
            { id: 'attitude', name: 'Attitude', max: 5 },
            { id: 'runsonoff', name: 'Runs on/off Field', max: 5 },
            { id: 'cheers', name: 'Cheers for Teammates', max: 5 },
            { id: 'dives', name: 'Dives for Balls', max: 5 },
            { id: 'baserunning', name: 'Aggressive Baserunning', max: 5 }
        ];

        const hittingDrills = [
            { id: 'batspeed', name: 'Bat Speed (mph)', attempts: 3, type: 'number' },
            { id: 'exitvel', name: 'Exit Velocity (mph)', attempts: 3, type: 'number' },
            { id: 'bunt1b', name: 'Bunt ‚Üí 1B', attempts: 3, type: 'yesno' },
            { id: 'buntp', name: 'Bunt ‚Üí P', attempts: 3, type: 'yesno' },
            { id: 'bunt3b', name: 'Bunt ‚Üí 3B', attempts: 3, type: 'yesno' },
            { id: 'pitchrecog', name: 'Pitch Recognition', attempts: 5, type: 'yesno_sum' },
            { id: 'strikerecog', name: 'Strikezone Recognition', attempts: 5, type: 'yesno_sum' }
        ];

        const speedDrills = [
            { id: 'h1b', name: 'H‚Üí1B', attempts: 3 },
            { id: 'h2b', name: 'H‚Üí2B', attempts: 3 },
            { id: 'hh', name: 'H‚ÜíH', attempts: 3 }
        ];

        const catcherDrills = [
            { id: 'poptime', name: 'Pop Time (seconds)', attempts: 3, type: 'number' },
            { id: 'throwaccuracy', name: 'Throwing Accuracy (2B)', attempts: 3, type: 'accuracy' },
            { id: 'throwspeed', name: 'Throwing Speed to 2B (mph)', attempts: 3, type: 'number' },
            { id: 'popfly', name: 'Pop Fly', attempts: 3, type: 'popfly' },
            { id: 'blocking', name: 'Blocking Balls in the Dirt', attempts: 1, type: 'overall' },
            { id: 'buntfielding', name: 'Bunt Fielding Throws to 1B', attempts: 1, type: 'overall' }
        ];

        const pitchingDrills = [
            { id: 'fastballspeed', name: 'Fastball Speed (mph)', attempts: 3, type: 'number' },
            { id: 'spinlocation', name: 'Spin & Location', attempts: 8, type: 'spinlocation' }
        ];

        const pitchTypes = [
            'Curve',
            'Drop Outside',
            'Rise Inside',
            'Change',
            'Screw',
            'Rise Outside',
            'Drop Inside'
        ];

        // Local storage functions
        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    players = JSON.parse(saved);
                    showSaveStatus('‚úì Data loaded from browser');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showSaveStatus('‚ö†Ô∏è Could not load saved data');
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
                showSaveStatus('‚úì Saved locally');

                // Trigger auto-upload with debouncing
                if (autoUploadTimer) {
                    clearTimeout(autoUploadTimer);
                }
                autoUploadTimer = setTimeout(() => {
                    autoUploadToSheets();
                }, AUTO_UPLOAD_DELAY);
            } catch (error) {
                console.error('Error saving data:', error);
                showSaveStatus('‚ö†Ô∏è Save failed');
            }
        }

        // Google Sheets sync functions
        function uploadToSheets() {
            if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR')) {
                alert('Please configure your Google Apps Script URL first.\nSee google-apps-script.js for instructions.');
                return;
            }

            if (isSyncing) return;
            isSyncing = true;

            showSaveStatus('‚è≥ Uploading to Google Sheets...');

            // Create a hidden form to POST data (avoids CORS and URL length limits)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'upload-iframe';
            form.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(players);
            form.appendChild(input);

            // Create hidden iframe to receive response
            let iframe = document.getElementById('upload-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'upload-iframe';
                iframe.name = 'upload-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            // Handle response
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const responseText = iframeDoc.body.textContent;

                    if (responseText) {
                        const result = JSON.parse(responseText);
                        console.log('Upload response:', result);
                        if (result.success) {
                            showSaveStatus('‚úì Uploaded to Google Sheets!');
                            alert(`Successfully uploaded ${players.length} player(s) to Google Sheets!\n\nCheck the "Players (Readable)" tab in your spreadsheet.`);
                        } else {
                            showSaveStatus('‚ö†Ô∏è Upload failed');
                            alert('Upload failed: ' + (result.error || 'Unknown error'));
                        }
                    } else {
                        showSaveStatus('‚úì Uploaded to Google Sheets!');
                        alert(`Upload completed! Check the "Players (Readable)" tab in your spreadsheet.`);
                    }
                } catch (error) {
                    console.error('Error processing upload response:', error);
                    // Assume success if we can't read the response (cross-origin)
                    showSaveStatus('‚úì Upload sent to Google Sheets!');
                    alert(`Upload sent to Google Sheets!\n\nCheck your spreadsheet to verify the data.`);
                }
                isSyncing = false;
                document.body.removeChild(form);
            };

            document.body.appendChild(form);
            form.submit();
        }

        // Auto-upload function (silent, no alerts)
        function autoUploadToSheets() {
            if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR')) {
                console.log('Google Apps Script URL not configured');
                return;
            }

            if (isSyncing) {
                console.log('Already syncing, skipping auto-upload');
                return;
            }

            isSyncing = true;
            showSaveStatus('‚è≥ Auto-uploading to Google Sheets...');

            // Create a hidden form to POST data (avoids CORS and URL length limits)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'upload-iframe';
            form.style.display = 'none';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(players);
            form.appendChild(input);

            // Create hidden iframe to receive response
            let iframe = document.getElementById('upload-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'upload-iframe';
                iframe.name = 'upload-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            // Handle response
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const responseText = iframeDoc.body.textContent;

                    if (responseText) {
                        const result = JSON.parse(responseText);
                        console.log('Auto-upload response:', result);
                        if (result.success) {
                            showSaveStatus('‚úì Auto-synced to Google Sheets');
                        } else {
                            showSaveStatus('‚ö†Ô∏è Auto-upload failed');
                            console.error('Auto-upload error:', result.error);
                        }
                    } else {
                        showSaveStatus('‚úì Auto-synced to Google Sheets');
                    }
                } catch (error) {
                    console.log('Auto-upload sent (cross-origin response)');
                    showSaveStatus('‚úì Auto-synced to Google Sheets');
                }
                isSyncing = false;
                document.body.removeChild(form);
            };

            document.body.appendChild(form);
            form.submit();
        }

        async function downloadFromSheets() {
            if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR')) {
                alert('Please configure your Google Apps Script URL first.\nSee google-apps-script.js for instructions.');
                return;
            }

            if (isSyncing) return;
            isSyncing = true;

            try {
                showSaveStatus('‚è≥ Downloading from Google Sheets...');
                const response = await fetch(GOOGLE_SCRIPT_URL);

                if (!response.ok) {
                    throw new Error('Failed to download from Google Sheets');
                }

                const data = await response.json();
                if (Array.isArray(data) && data.length > 0) {
                    const proceed = confirm(`Found ${data.length} player(s) in Google Sheets.\n\nThis will replace your current local data. Continue?`);
                    if (proceed) {
                        players = data;
                        saveData(); // Save to local storage
                        render();
                        showSaveStatus('‚úì Downloaded from Google Sheets!');
                        alert(`Successfully downloaded ${players.length} player(s) from Google Sheets!`);
                    } else {
                        showSaveStatus('Download cancelled');
                    }
                } else {
                    showSaveStatus('No data found in Google Sheets');
                    alert('No player data found in Google Sheets.');
                }
            } catch (error) {
                console.error('Error downloading from Google Sheets:', error);
                showSaveStatus('‚ö†Ô∏è Download from Google Sheets failed');
                alert('Error downloading from Google Sheets. Check console for details.');
            } finally {
                isSyncing = false;
            }
        }

        // Auto-download function (silent, on page load)
        async function autoDownloadFromSheets() {
            if (GOOGLE_SCRIPT_URL.includes('PASTE_YOUR')) {
                console.log('Google Apps Script URL not configured, loading from local storage');
                loadData(); // Fall back to local storage
                return;
            }

            if (isSyncing) {
                console.log('Already syncing, loading from local storage');
                loadData();
                return;
            }

            isSyncing = true;

            try {
                showSaveStatus('‚è≥ Auto-loading from Google Sheets...');
                const response = await fetch(GOOGLE_SCRIPT_URL);

                if (!response.ok) {
                    throw new Error('Failed to download from Google Sheets');
                }

                const data = await response.json();
                if (Array.isArray(data) && data.length > 0) {
                    players = data;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(players)); // Save to local storage without triggering auto-upload
                    showSaveStatus('‚úì Auto-loaded from Google Sheets');
                    console.log(`Auto-loaded ${players.length} player(s) from Google Sheets`);
                } else {
                    showSaveStatus('No data in Google Sheets, loading local data');
                    loadData(); // Fall back to local storage
                }
            } catch (error) {
                console.error('Error auto-downloading from Google Sheets:', error);
                showSaveStatus('‚ö†Ô∏è Auto-load failed, using local data');
                loadData(); // Fall back to local storage
            } finally {
                isSyncing = false;
            }
        }

        function showSaveStatus(message) {
            const status = document.getElementById('saveStatus');
            const originalMessage = 'üîÑ Auto-syncing with Google Sheets';
            status.textContent = message;
            if (message !== originalMessage) {
                setTimeout(() => {
                    status.textContent = originalMessage;
                }, 3000);
            }
        }

        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const numberInput = document.getElementById('playerNumber');
            const name = nameInput.value.trim();
            
            if (name) {
                const newPlayer = {
                    id: Date.now(),
                    name: name,
                    number: numberInput.value.trim(),
                    scores: {},
                    hittingData: {
                        batspeed: [null, null, null],
                        exitvel: [null, null, null],
                        bunt1b: [null, null, null],
                        buntp: [null, null, null],
                        bunt3b: [null, null, null],
                        pitchrecog: [null, null, null, null, null],
                        strikerecog: [null, null, null, null, null]
                    },
                    speedTimes: {
                        h1b: [null, null, null],
                        h2b: [null, null, null],
                        hh: [null, null, null]
                    },
                    catcherData: {
                        poptime: [null, null, null],
                        throwaccuracy: [null, null, null],
                        throwspeed: [null, null, null],
                        popfly: [null, null, null],
                        blocking: null,
                        buntfielding: null
                    },
                    pitchingData: {
                        fastballspeed: [null, null, null],
                        spinlocation: Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }))
                    },
                    notes: ''
                };
                
                categories.forEach(cat => {
                    newPlayer.scores[cat.id] = 0;
                });

                hustleEnergyCategories.forEach(cat => {
                    newPlayer.scores[cat.id] = 0;
                });
                
                players.push(newPlayer);
                currentPlayerIndex = players.length - 1;
                nameInput.value = '';
                numberInput.value = '';
                saveData();
                render();
            }
        }

        function removePlayer(id) {
            if (confirm('Are you sure you want to remove this player?')) {
                const index = players.findIndex(p => p.id === id);
                players = players.filter(p => p.id !== id);
                
                if (currentPlayerIndex >= players.length && currentPlayerIndex > 0) {
                    currentPlayerIndex = players.length - 1;
                }
                
                saveData();
                render();
            }
        }

        function updateScore(playerId, category, value) {
            // Find the max value for this category
            let maxValue = 10; // default
            const regularCat = categories.find(c => c.id === category);
            const hustleCat = hustleEnergyCategories.find(c => c.id === category);
            if (regularCat) maxValue = regularCat.max;
            if (hustleCat) maxValue = hustleCat.max;

            const numValue = Math.max(0, Math.min(maxValue, parseInt(value) || 0));
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.scores[category] = numValue;
                saveData();
                updateScoresOnly(playerId);
            }
        }

        function updateNotes(playerId, notes) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.notes = notes;
                saveData();
            }
        }

        function updatePlayerInfo(playerId, name, number) {
            const player = players.find(p => p.id === playerId);
            if (player && name.trim()) {
                player.name = name.trim();
                player.number = number.trim();
                saveData();
                render();
            }
        }

        function editPlayerInfo(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const newName = prompt('Enter player name:', player.name);
            if (newName === null) return; // User cancelled

            const newNumber = prompt('Enter jersey number (optional):', player.number || '');
            if (newNumber === null) return; // User cancelled

            if (newName.trim()) {
                updatePlayerInfo(playerId, newName, newNumber);
            } else {
                alert('Player name cannot be empty!');
            }
        }

        function updateHittingData(playerId, drill, attemptIndex, value) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                if (!player.hittingData) {
                    player.hittingData = {};
                }

                // Ensure the drill array exists
                const drillInfo = hittingDrills.find(d => d.id === drill);
                if (!player.hittingData[drill]) {
                    player.hittingData[drill] = Array(drillInfo ? drillInfo.attempts : 3).fill(null);
                }

                // For yes/no drills, convert to boolean
                if (drillInfo && (drillInfo.type === 'yesno' || drillInfo.type === 'yesno_sum')) {
                    player.hittingData[drill][attemptIndex] = value === '' ? null : (value === 'Y' || value === true);
                } else {
                    const numValue = value === '' ? null : parseFloat(value);
                    player.hittingData[drill][attemptIndex] = numValue;
                }

                saveData();
                updateScoresOnly(playerId);
            }
        }

        function updateSpeedTime(playerId, drill, attemptIndex, time) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                if (!player.speedTimes) {
                    player.speedTimes = {};
                }

                // Ensure the drill array exists
                if (!player.speedTimes[drill]) {
                    player.speedTimes[drill] = [null, null, null];
                }

                const numTime = time === '' ? null : parseFloat(time);
                player.speedTimes[drill][attemptIndex] = numTime;
                saveData();
                updateScoresOnly(playerId);
            }
        }

        function calculateHittingScore(drill, values) {
            if (!values) return 0;
            const validValues = values.filter(v => v !== null && v !== undefined && v !== '');
            if (validValues.length === 0) return 0;
            
            // For recognition drills (sum of Y's)
            if (drill === 'pitchrecog' || drill === 'strikerecog') {
                return validValues.filter(v => v === true || v === 'Y').length;
            }
            
            // For bunting drills (2+ Y's = 1 point)
            if (drill === 'bunt1b' || drill === 'buntp' || drill === 'bunt3b') {
                const yesCount = validValues.filter(v => v === true || v === 'Y').length;
                return yesCount >= 2 ? 1 : 0;
            }
            
            // For numeric drills (bat speed, exit velocity)
            const numericValues = validValues.map(v => parseFloat(v)).filter(v => !isNaN(v));
            if (numericValues.length === 0) return 0;
            
            const avgValue = numericValues.reduce((sum, v) => sum + v, 0) / numericValues.length;
            
            if (drill === 'batspeed') {
                if (avgValue <= 40) return 0;
                if (avgValue <= 50) return 1;
                if (avgValue <= 55) return 2;
                if (avgValue <= 60) return 3;
                if (avgValue <= 65) return 4;
                return 5;
            } else if (drill === 'exitvel') {
                if (avgValue <= 50) return 0;
                if (avgValue <= 55) return 1;
                if (avgValue <= 60) return 2;
                if (avgValue <= 65) return 3;
                if (avgValue <= 70) return 4;
                return 5;
            }
            return 0;
        }

        function getHittingScore(player) {
            if (!player.hittingData) return 0;
            const batspeedScore = calculateHittingScore('batspeed', player.hittingData.batspeed);
            const exitvelScore = calculateHittingScore('exitvel', player.hittingData.exitvel);
            const bunt1bScore = calculateHittingScore('bunt1b', player.hittingData.bunt1b);
            const buntpScore = calculateHittingScore('buntp', player.hittingData.buntp);
            const bunt3bScore = calculateHittingScore('bunt3b', player.hittingData.bunt3b);
            const pitchrecogScore = calculateHittingScore('pitchrecog', player.hittingData.pitchrecog || [null, null, null, null, null]);
            const strikerecogScore = calculateHittingScore('strikerecog', player.hittingData.strikerecog || [null, null, null, null, null]);
            return batspeedScore + exitvelScore + bunt1bScore + buntpScore + bunt3bScore + pitchrecogScore + strikerecogScore;
        }

        function calculateSpeedScore(drill, times) {
            const validTimes = times.filter(t => t !== null && !isNaN(t));
            if (validTimes.length === 0) return 0;
            
            const avgTime = validTimes.reduce((sum, t) => sum + t, 0) / validTimes.length;
            
            if (drill === 'h1b') {
                if (avgTime >= 5.2) return 1;
                if (avgTime >= 4.6) return 2;
                if (avgTime >= 3.8) return 3;
                if (avgTime >= 3.1) return 4;
                return 5;
            } else if (drill === 'h2b') {
                if (avgTime >= 8) return 1;
                if (avgTime >= 7) return 2;
                if (avgTime >= 6.25) return 3;
                if (avgTime >= 5.75) return 4;
                return 5;
            } else if (drill === 'hh') {
                // H‚ÜíH scoring
                if (avgTime < 11.8) return 5;
                if (avgTime < 13.3) return 4;
                if (avgTime < 15.0) return 3;
                if (avgTime < 17.0) return 2;
                return 1;
            }
            return 0;
        }

        function getSpeedScore(player) {
            if (!player.speedTimes) return 0;
            const h1bScore = calculateSpeedScore('h1b', player.speedTimes.h1b);
            const h2bScore = calculateSpeedScore('h2b', player.speedTimes.h2b);
            const hhScore = calculateSpeedScore('hh', player.speedTimes.hh);
            return h1bScore + h2bScore + hhScore;
        }

        function updateCatcherData(playerId, drill, attemptIndex, value) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                if (!player.catcherData) {
                    player.catcherData = {
                        poptime: [null, null, null],
                        throwaccuracy: [null, null, null],
                        throwspeed: [null, null, null],
                        blocking: null,
                        buntfielding: null
                    };
                }

                const drillInfo = catcherDrills.find(d => d.id === drill);
                if (!drillInfo) return;

                if (drillInfo.type === 'overall') {
                    // Single overall score (1-5)
                    const numValue = value === '' ? null : parseInt(value);
                    player.catcherData[drill] = numValue;
                } else if (drillInfo.type === 'accuracy') {
                    // Accuracy values: 0, 1, or 3
                    if (!player.catcherData[drill]) {
                        player.catcherData[drill] = [null, null, null];
                    }
                    const numValue = value === '' ? null : parseInt(value);
                    player.catcherData[drill][attemptIndex] = numValue;
                } else {
                    // Number type (poptime, throwspeed)
                    if (!player.catcherData[drill]) {
                        player.catcherData[drill] = [null, null, null];
                    }
                    const numValue = value === '' ? null : parseFloat(value);
                    player.catcherData[drill][attemptIndex] = numValue;
                }

                saveData();
                updateScoresOnly(playerId);
            }
        }

        function calculateCatcherScore(drill, values) {
            if (drill === 'blocking' || drill === 'buntfielding') {
                // Overall score (1-5)
                return values !== null && values !== undefined ? values : 0;
            }

            if (!values || !Array.isArray(values)) return 0;
            const validValues = values.filter(v => v !== null && v !== undefined && v !== '');
            if (validValues.length === 0) return 0;

            if (drill === 'throwaccuracy') {
                // Sum of accuracy scores (0, 1, or 3 per attempt)
                return validValues.reduce((sum, v) => sum + parseInt(v), 0);
            }

            if (drill === 'popfly') {
                // Sum of pop fly scores (0, 1, or 2 per attempt)
                return validValues.reduce((sum, v) => sum + parseInt(v), 0);
            }

            // For poptime and throwspeed, calculate average and score
            const numericValues = validValues.map(v => parseFloat(v)).filter(v => !isNaN(v));
            if (numericValues.length === 0) return 0;

            const avgValue = numericValues.reduce((sum, v) => sum + v, 0) / numericValues.length;

            if (drill === 'poptime') {
                if (avgValue > 4) return 1;
                if (avgValue >= 3.15) return 2;
                if (avgValue >= 2.51) return 3;
                if (avgValue >= 2.31) return 4;
                return 5;
            } else if (drill === 'throwspeed') {
                if (avgValue < 40) return 1;
                if (avgValue < 45) return 2;
                if (avgValue < 52) return 3;
                if (avgValue <= 65) return 4;
                return 5;
            }

            return 0;
        }

        function getCatcherScore(player) {
            if (!player.catcherData) return 0;
            const poptimeScore = calculateCatcherScore('poptime', player.catcherData.poptime);
            const accuracyScore = calculateCatcherScore('throwaccuracy', player.catcherData.throwaccuracy);
            const throwspeedScore = calculateCatcherScore('throwspeed', player.catcherData.throwspeed);
            const popflyScore = calculateCatcherScore('popfly', player.catcherData.popfly);
            const blockingScore = calculateCatcherScore('blocking', player.catcherData.blocking);
            const buntfieldingScore = calculateCatcherScore('buntfielding', player.catcherData.buntfielding);
            return poptimeScore + accuracyScore + throwspeedScore + popflyScore + blockingScore + buntfieldingScore;
        }

        function updatePitchingData(playerId, drill, attemptIndex, value, field = null) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                if (!player.pitchingData) {
                    player.pitchingData = {
                        fastballspeed: [null, null, null],
                        spinlocation: Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }))
                    };
                }

                if (drill === 'fastballspeed') {
                    const numValue = value === '' ? null : parseFloat(value);
                    player.pitchingData.fastballspeed[attemptIndex] = numValue;
                } else if (drill === 'spinlocation') {
                    if (field === 'pitchType') {
                        player.pitchingData.spinlocation[attemptIndex].pitchType = value;
                    } else if (field === 'spin') {
                        player.pitchingData.spinlocation[attemptIndex].spin = value === '' ? null : (value === 'true' || value === true);
                    } else if (field === 'location') {
                        player.pitchingData.spinlocation[attemptIndex].location = value === '' ? null : (value === 'true' || value === true);
                    }
                }

                saveData();
                updateScoresOnly(playerId);
            }
        }

        function calculatePitchingScore(drill, values) {
            if (drill === 'fastballspeed') {
                if (!values || !Array.isArray(values)) return 0;
                const validValues = values.filter(v => v !== null && !isNaN(v));
                if (validValues.length === 0) return 0;

                const avgValue = validValues.reduce((sum, v) => sum + v, 0) / validValues.length;

                if (avgValue <= 42) return 1;
                if (avgValue < 47) return 2;
                if (avgValue < 52) return 3;
                if (avgValue < 57) return 4;
                if (avgValue >= 60) return 5;
                return 4; // 57-59
            } else if (drill === 'spinlocation') {
                if (!values || !Array.isArray(values)) return 0;
                let totalScore = 0;
                values.forEach(attempt => {
                    if (!attempt || !attempt.pitchType) return;
                    const spinCorrect = attempt.spin === true;
                    const locationCorrect = attempt.location === true;

                    if (spinCorrect && locationCorrect) {
                        totalScore += 2;
                    } else if (spinCorrect || locationCorrect) {
                        totalScore += 1;
                    }
                    // else 0 points
                });
                return totalScore;
            }
            return 0;
        }

        function getPitchingScore(player) {
            if (!player.pitchingData) return 0;
            const fastballspeedScore = calculatePitchingScore('fastballspeed', player.pitchingData.fastballspeed);
            const spinlocationScore = calculatePitchingScore('spinlocation', player.pitchingData.spinlocation);
            return fastballspeedScore + spinlocationScore;
        }

        function getTotalScore(player) {
            const regularScore = Object.values(player.scores).reduce((sum, score) => sum + score, 0);
            const hittingScore = getHittingScore(player);
            const speedScore = getSpeedScore(player);
            const catcherScore = getCatcherScore(player);
            // Note: Pitching score is NOT included in total - kept separate since not all players are pitchers
            return regularScore + hittingScore + speedScore + catcherScore;
        }

        function previousPlayer() {
            if (currentPlayerIndex > 0) {
                currentPlayerIndex--;
                render();
            }
        }

        function nextPlayer() {
            if (currentPlayerIndex < players.length - 1) {
                currentPlayerIndex++;
                render();
            }
        }

        function jumpToPlayer(index) {
            currentPlayerIndex = parseInt(index);
            render();
        }

        function showPlayersView() {
            viewMode = 'players';
            render();
        }

        function showStationsView() {
            viewMode = 'stations';
            render();
        }

        function showAllPlayers() {
            viewMode = 'all';
            render();
        }

        function showCatcherScores() {
            viewMode = 'catcherScores';
            render();
        }

        function showPitcherScores() {
            viewMode = 'pitcherScores';
            render();
        }

        function selectStationPlayer(playerId) {
            selectedStationPlayer = playerId ? parseInt(playerId) : null;
            renderStationContent();
        }

        function selectStation(stationId) {
            selectedStation = stationId;
            // Update button styles
            document.querySelectorAll('[id^="station-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            const selectedBtn = document.getElementById(`station-${stationId}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-100', 'text-gray-700');
                selectedBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }

            // Show player selector
            const playerSelector = document.getElementById('stationPlayerSelector');
            if (playerSelector) {
                playerSelector.style.display = 'block';
            }

            // Populate player dropdown if not already done
            if (viewMode === 'stations') {
                const stationDropdown = document.getElementById('stationPlayerDropdown');
                stationDropdown.innerHTML = `
                    <option value="">-- Select a player --</option>
                    ${players.map(p => `
                        <option value="${p.id}" ${p.id === selectedStationPlayer ? 'selected' : ''}>
                            ${p.name}${p.number ? ' (#' + p.number + ')' : ''} - Score: ${getTotalScore(p)}/118
                        </option>
                    `).join('')}
                `;
            }

            renderStationContent();
        }

        function renderStationContent() {
            const contentDiv = document.getElementById('stationContent');

            if (!selectedStation) {
                contentDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <p class="text-lg">Select your station to begin</p>
                    </div>
                `;
                return;
            }

            if (!selectedStationPlayer) {
                contentDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <p class="text-lg">Select a player to score at this station</p>
                    </div>
                `;
                return;
            }

            const player = players.find(p => p.id === selectedStationPlayer);
            if (!player) {
                contentDiv.innerHTML = `
                    <div class="text-center text-red-500 py-12">
                        <p class="text-lg">Player not found</p>
                    </div>
                `;
                return;
            }

            // Render station-specific content
            let stationHTML = '';

            if (selectedStation === 'fielding' || selectedStation === 'throwing') {
                const category = categories.find(c => c.id === selectedStation);
                stationHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-8">
                        <div class="max-w-md mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${category.name}</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-blue-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>
                            <div class="bg-white rounded-lg p-6 shadow-md">
                                <label class="block text-lg font-medium text-gray-700 mb-3">Score (0-${category.max}):</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="${category.max}"
                                    value="${player.scores[category.id]}"
                                    onchange="updateScore(${player.id}, '${category.id}', this.value); renderStationContent();"
                                    class="w-full px-6 py-4 text-3xl font-bold text-center border-4 border-blue-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500"
                                    autofocus
                                />
                                <div class="mt-4 text-center">
                                    <span class="text-2xl font-bold text-blue-600" id="stationScoreDisplay">${player.scores[category.id]}/${category.max}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (selectedStation === 'attitude' || selectedStation === 'runsonoff' || selectedStation === 'cheers' || selectedStation === 'dives' || selectedStation === 'baserunning') {
                const category = hustleEnergyCategories.find(c => c.id === selectedStation);
                stationHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-8">
                        <div class="max-w-md mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${category.name}</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-blue-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>
                            <div class="bg-white rounded-lg p-6 shadow-md">
                                <label class="block text-lg font-medium text-gray-700 mb-3">Score (0-${category.max}):</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="${category.max}"
                                    value="${player.scores[category.id]}"
                                    onchange="updateScore(${player.id}, '${category.id}', this.value); renderStationContent();"
                                    class="w-full px-6 py-4 text-3xl font-bold text-center border-4 border-blue-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500"
                                    autofocus
                                />
                                <div class="mt-4 text-center">
                                    <span class="text-2xl font-bold text-blue-600" id="stationScoreDisplay">${player.scores[category.id]}/${category.max}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (selectedStation === 'hitting') {
                stationHTML = `
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-8">
                        <div class="max-w-4xl mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Hitting Drills</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-green-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>
                            ${hittingDrills.map(drill => {
                                const values = player.hittingData[drill.id] || Array(drill.attempts).fill(null);
                                const score = calculateHittingScore(drill.id, values);

                                if (drill.type === 'yesno_sum') {
                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <span class="text-lg font-bold text-green-600">Score: ${score}/5</span>
                                            </div>
                                            <div class="grid grid-cols-5 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <select
                                                            onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                                                        >
                                                            <option value="" ${val === null ? 'selected' : ''}>-</option>
                                                            <option value="Y" ${val === true || val === 'Y' ? 'selected' : ''}>Y</option>
                                                            <option value="N" ${val === false || val === 'N' ? 'selected' : ''}>N</option>
                                                        </select>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else if (drill.type === 'yesno') {
                                    const yesCount = values.filter(v => v === true || v === 'Y').length;
                                    const noCount = values.filter(v => v === false || v === 'N').length;
                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <div class="text-right">
                                                    <span class="text-sm text-gray-500">Y: ${yesCount} | N: ${noCount}</span>
                                                    <span class="ml-3 text-lg font-bold text-green-600">Score: ${score}/1</span>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <select
                                                            onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                                                        >
                                                            <option value="" ${val === null ? 'selected' : ''}>-</option>
                                                            <option value="Y" ${val === true || val === 'Y' ? 'selected' : ''}>Y</option>
                                                            <option value="N" ${val === false || val === 'N' ? 'selected' : ''}>N</option>
                                                        </select>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    const validVals = values.filter(v => v !== null && !isNaN(v));
                                    const avgValue = validVals.length > 0
                                        ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(1)
                                        : 'N/A';
                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <div class="text-right">
                                                    <span class="text-sm text-gray-500">Avg: ${avgValue} mph</span>
                                                    <span class="ml-3 text-lg font-bold text-green-600">Score: ${score}/5</span>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <input
                                                            type="number"
                                                            step="0.1"
                                                            min="0"
                                                            placeholder="0.0"
                                                            value="${val !== null ? val : ''}"
                                                            onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                                                        />
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (selectedStation === 'speed') {
                stationHTML = `
                    <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-8">
                        <div class="max-w-4xl mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Speed Drills</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-orange-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>
                            ${speedDrills.map(drill => {
                                const times = player.speedTimes[drill.id];
                                const score = calculateSpeedScore(drill.id, times);
                                const avgTime = times.filter(t => t !== null && !isNaN(t)).length > 0
                                    ? (times.filter(t => t !== null && !isNaN(t)).reduce((sum, t) => sum + t, 0) / times.filter(t => t !== null && !isNaN(t)).length).toFixed(2)
                                    : 'N/A';

                                return `
                                    <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                        <div class="flex justify-between items-center mb-3">
                                            <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="text-sm text-gray-500">Avg: ${avgTime}s</span>
                                                <span class="ml-3 text-lg font-bold text-orange-600">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-3">
                                            ${times.map((time, idx) => `
                                                <div>
                                                    <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        placeholder="0.00"
                                                        value="${time !== null ? time : ''}"
                                                        onchange="updateSpeedTime(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-center"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (selectedStation === 'catcher') {
                // Initialize catcherData if needed
                if (!player.catcherData) {
                    player.catcherData = {
                        poptime: [null, null, null],
                        throwaccuracy: [null, null, null],
                        throwspeed: [null, null, null],
                        popfly: [null, null, null],
                        blocking: null,
                        buntfielding: null
                    };
                }

                stationHTML = `
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-8">
                        <div class="max-w-4xl mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Catcher Drills</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-purple-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>
                            ${catcherDrills.map(drill => {
                                if (drill.type === 'overall') {
                                    const value = player.catcherData[drill.id];
                                    const score = calculateCatcherScore(drill.id, value);

                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <span class="text-lg font-bold text-purple-600">Score: ${score}/5</span>
                                            </div>
                                            <select
                                                onchange="updateCatcherData(${player.id}, '${drill.id}', 0, this.value); renderStationContent();"
                                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-lg"
                                            >
                                                <option value="">-</option>
                                                <option value="1" ${value === 1 ? 'selected' : ''}>1</option>
                                                <option value="2" ${value === 2 ? 'selected' : ''}>2</option>
                                                <option value="3" ${value === 3 ? 'selected' : ''}>3</option>
                                                <option value="4" ${value === 4 ? 'selected' : ''}>4</option>
                                                <option value="5" ${value === 5 ? 'selected' : ''}>5</option>
                                            </select>
                                        </div>
                                    `;
                                } else if (drill.type === 'accuracy') {
                                    const values = player.catcherData[drill.id] || [null, null, null];
                                    const score = calculateCatcherScore(drill.id, values);

                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <span class="text-lg font-bold text-purple-600">Score: ${score}/9</span>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <select
                                                            onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center"
                                                        >
                                                            <option value="">-</option>
                                                            <option value="0" ${val === 0 ? 'selected' : ''}>Off (0)</option>
                                                            <option value="1" ${val === 1 ? 'selected' : ''}>1 Bounce (1)</option>
                                                            <option value="3" ${val === 3 ? 'selected' : ''}>On Mark (3)</option>
                                                        </select>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else if (drill.type === 'popfly') {
                                    const values = player.catcherData[drill.id] || [null, null, null];
                                    const score = calculateCatcherScore(drill.id, values);

                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <span class="text-lg font-bold text-purple-600">Score: ${score}/6</span>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <select
                                                            onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center"
                                                        >
                                                            <option value="">-</option>
                                                            <option value="0" ${val === 0 ? 'selected' : ''}>Bad Read (0)</option>
                                                            <option value="1" ${val === 1 ? 'selected' : ''}>Good Attempt (1)</option>
                                                            <option value="2" ${val === 2 ? 'selected' : ''}>Caught (2)</option>
                                                        </select>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    const values = player.catcherData[drill.id] || [null, null, null];
                                    const score = calculateCatcherScore(drill.id, values);
                                    const validVals = values.filter(v => v !== null && !isNaN(v));
                                    const avgValue = validVals.length > 0
                                        ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(2)
                                        : 'N/A';

                                    return `
                                        <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="text-lg font-semibold text-gray-800">${drill.name}</label>
                                                <div class="text-right">
                                                    <span class="text-sm text-gray-500">Avg: ${avgValue}</span>
                                                    <span class="ml-3 text-lg font-bold text-purple-600">Score: ${score}/5</span>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-3 gap-3">
                                                ${values.map((val, idx) => `
                                                    <div>
                                                        <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            min="0"
                                                            placeholder="0.00"
                                                            value="${val !== null ? val : ''}"
                                                            onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value); renderStationContent();"
                                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center"
                                                        />
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (selectedStation === 'pitching') {
                // Initialize pitchingData if needed
                if (!player.pitchingData) {
                    player.pitchingData = {
                        fastballspeed: [null, null, null],
                        spinlocation: Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }))
                    };
                }

                stationHTML = `
                    <div class="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg p-8">
                        <div class="max-w-4xl mx-auto">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Pitching Drills</h3>
                            <p class="text-gray-600 mb-6">Scoring for: <span class="font-semibold text-orange-700">${player.name}${player.number ? ' (#' + player.number + ')' : ''}</span></p>

                            <!-- Fastball Speed -->
                            ${(() => {
                                const values = player.pitchingData.fastballspeed || [null, null, null];
                                const score = calculatePitchingScore('fastballspeed', values);
                                const validVals = values.filter(v => v !== null && !isNaN(v));
                                const avgValue = validVals.length > 0
                                    ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(1)
                                    : 'N/A';

                                return `
                                    <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                        <div class="flex justify-between items-center mb-3">
                                            <label class="text-lg font-semibold text-gray-800">Fastball Speed (mph)</label>
                                            <div class="text-right">
                                                <span class="text-sm text-gray-500">Avg: ${avgValue} mph</span>
                                                <span class="ml-3 text-lg font-bold text-orange-600">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-3">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-sm text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        min="0"
                                                        placeholder="0.0"
                                                        value="${val !== null ? val : ''}"
                                                        onchange="updatePitchingData(${player.id}, 'fastballspeed', ${idx}, this.value); renderStationContent();"
                                                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-center"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}

                            <!-- Spin & Location -->
                            ${(() => {
                                const attempts = player.pitchingData.spinlocation || Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }));
                                const score = calculatePitchingScore('spinlocation', attempts);

                                return `
                                    <div class="bg-white p-6 rounded-lg mb-4 shadow-md">
                                        <div class="flex justify-between items-center mb-3">
                                            <label class="text-lg font-semibold text-gray-800">Spin & Location</label>
                                            <span class="text-lg font-bold text-orange-600">Score: ${score}/16</span>
                                        </div>
                                        <div class="text-xs text-gray-600 mb-3">Score: 0 if neither correct, 1 if either correct, 2 if both correct</div>
                                        <div class="space-y-3">
                                            ${attempts.map((attempt, idx) => {
                                                const attemptScore = (attempt.spin && attempt.location) ? 2 : ((attempt.spin || attempt.location) ? 1 : 0);
                                                return `
                                                    <div class="grid grid-cols-12 gap-3 items-center bg-gray-50 p-3 rounded-lg">
                                                        <div class="col-span-1 text-sm text-gray-600 font-medium text-center">#${idx + 1}</div>
                                                        <div class="col-span-4">
                                                            <select
                                                                onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.value, 'pitchType'); renderStationContent();"
                                                                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                            >
                                                                <option value="">Select pitch...</option>
                                                                ${pitchTypes.map(type => `
                                                                    <option value="${type}" ${attempt.pitchType === type ? 'selected' : ''}>${type}</option>
                                                                `).join('')}
                                                            </select>
                                                        </div>
                                                        <div class="col-span-3">
                                                            <label class="flex items-center cursor-pointer bg-white px-3 py-2 rounded-lg border-2 border-gray-300 hover:border-orange-300">
                                                                <input
                                                                    type="checkbox"
                                                                    ${attempt.spin === true ? 'checked' : ''}
                                                                    onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.checked, 'spin'); renderStationContent();"
                                                                    class="mr-2"
                                                                />
                                                                <span class="text-sm font-medium">Spin ‚úì</span>
                                                            </label>
                                                        </div>
                                                        <div class="col-span-3">
                                                            <label class="flex items-center cursor-pointer bg-white px-3 py-2 rounded-lg border-2 border-gray-300 hover:border-orange-300">
                                                                <input
                                                                    type="checkbox"
                                                                    ${attempt.location === true ? 'checked' : ''}
                                                                    onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.checked, 'location'); renderStationContent();"
                                                                    class="mr-2"
                                                                />
                                                                <span class="text-sm font-medium">Location ‚úì</span>
                                                            </label>
                                                        </div>
                                                        <div class="col-span-1 text-center">
                                                            <span class="text-lg font-bold ${attemptScore === 2 ? 'text-green-600' : (attemptScore === 1 ? 'text-yellow-600' : 'text-gray-400')}">${attemptScore}</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = stationHTML;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL player data? This cannot be undone!')) {
                players = [];
                currentPlayerIndex = 0;
                localStorage.removeItem(STORAGE_KEY);
                render();
                showSaveStatus('‚úì All data cleared');
            }
        }

        function exportData() {
            if (players.length === 0) {
                alert('No players to export! Please add players first.');
                return;
            }

            try {
                const sortedPlayers = [...players].sort((a, b) => getTotalScore(b) - getTotalScore(a));
                const headers = ['Rank', 'Name', 'Number', 'Bat Speed Avg', 'Bat Speed Score', 'Exit Vel Avg', 'Exit Vel Score', 'Bunt‚Üí1B Y/N', 'Bunt‚Üí1B Score', 'Bunt‚ÜíP Y/N', 'Bunt‚ÜíP Score', 'Bunt‚Üí3B Y/N', 'Bunt‚Üí3B Score', 'Hitting Total', ...categories.map(c => c.name), 'H‚Üí1B Avg', 'H‚Üí1B Score', 'H‚Üí2B Avg', 'H‚Üí2B Score', 'H‚ÜíH Avg', 'H‚ÜíH Score', 'Speed Total', 'Total Score', 'Notes'];
                const rows = sortedPlayers.map((p, idx) => {
                    const batspeedVals = p.hittingData?.batspeed || [null, null, null];
                    const exitvelVals = p.hittingData?.exitvel || [null, null, null];
                    const bunt1bVals = p.hittingData?.bunt1b || [null, null, null];
                    const buntpVals = p.hittingData?.buntp || [null, null, null];
                    const bunt3bVals = p.hittingData?.bunt3b || [null, null, null];
                    const h1bTimes = p.speedTimes?.h1b || [null, null, null];
                    const h2bTimes = p.speedTimes?.h2b || [null, null, null];
                    const hhTimes = p.speedTimes?.hh || [null, null, null];
                    
                    const batspeedAvg = batspeedVals.filter(v => v !== null).length > 0
                        ? (batspeedVals.filter(v => v !== null).reduce((sum, v) => sum + v, 0) / batspeedVals.filter(v => v !== null).length).toFixed(1)
                        : '';
                    const exitvelAvg = exitvelVals.filter(v => v !== null).length > 0
                        ? (exitvelVals.filter(v => v !== null).reduce((sum, v) => sum + v, 0) / exitvelVals.filter(v => v !== null).length).toFixed(1)
                        : '';
                    
                    const bunt1bYes = bunt1bVals.filter(v => v === true || v === 'Y').length;
                    const buntpYes = buntpVals.filter(v => v === true || v === 'Y').length;
                    const bunt3bYes = bunt3bVals.filter(v => v === true || v === 'Y').length;
                    
                    const h1bAvg = h1bTimes.filter(t => t !== null).length > 0
                        ? (h1bTimes.filter(t => t !== null).reduce((sum, t) => sum + t, 0) / h1bTimes.filter(t => t !== null).length).toFixed(2)
                        : '';
                    const h2bAvg = h2bTimes.filter(t => t !== null).length > 0
                        ? (h2bTimes.filter(t => t !== null).reduce((sum, t) => sum + t, 0) / h2bTimes.filter(t => t !== null).length).toFixed(2)
                        : '';
                    const hhAvg = hhTimes.filter(t => t !== null).length > 0
                        ? (hhTimes.filter(t => t !== null).reduce((sum, t) => sum + t, 0) / hhTimes.filter(t => t !== null).length).toFixed(2)
                        : '';
                    
                    return [
                        idx + 1,
                        `"${p.name}"`,
                        p.number || '',
                        batspeedAvg,
                        calculateHittingScore('batspeed', batspeedVals),
                        exitvelAvg,
                        calculateHittingScore('exitvel', exitvelVals),
                        `${bunt1bYes}/3`,
                        calculateHittingScore('bunt1b', bunt1bVals),
                        `${buntpYes}/3`,
                        calculateHittingScore('buntp', buntpVals),
                        `${bunt3bYes}/3`,
                        calculateHittingScore('bunt3b', bunt3bVals),
                        getHittingScore(p),
                        ...categories.map(c => p.scores[c.id]),
                        h1bAvg,
                        calculateSpeedScore('h1b', h1bTimes),
                        h2bAvg,
                        calculateSpeedScore('h2b', h2bTimes),
                        hhAvg,
                        calculateSpeedScore('hh', hhTimes),
                        getSpeedScore(p),
                        getTotalScore(p),
                        `"${p.notes.replace(/"/g, '""')}"`
                    ];
                });
                
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `softball_tryout_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showSaveStatus('‚úì CSV exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting CSV. Please try again.');
            }
        }


        function renderPlayerCard(player, showDelete = true) {
            if (!player.hittingData) {
                player.hittingData = {
                    batspeed: [null, null, null],
                    exitvel: [null, null, null],
                    bunt1b: [null, null, null],
                    buntp: [null, null, null],
                    bunt3b: [null, null, null],
                    pitchrecog: [null, null, null, null, null],
                    strikerecog: [null, null, null, null, null]
                };
            }
            if (!player.speedTimes) {
                player.speedTimes = {
                    h1b: [null, null, null],
                    h2b: [null, null, null],
                    hh: [null, null, null]
                };
            }

            const hittingScore = getHittingScore(player);
            const speedScore = getSpeedScore(player);
            const catcherScore = getCatcherScore(player);
            const regularScore = Object.values(player.scores).reduce((sum, score) => sum + score, 0);

            return `
                <div class="border-2 border-blue-200 rounded-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${player.name}</h3>
                            ${player.number ? `<p class="text-gray-500">Jersey #${player.number}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Total Score</div>
                                <div class="text-3xl font-bold text-green-600" data-total-score>${getTotalScore(player)}/118</div>
                                <div class="text-xs text-gray-400" data-subscore>Hitting: ${hittingScore}/23 | Speed: ${speedScore}/15 | Catcher: ${catcherScore}/35 | Pitching: ${getPitchingScore(player)}/21</div>
                            </div>
                            ${showDelete ? `
                            <button
                                onclick="editPlayerInfo(${player.id})"
                                tabindex="-1"
                                class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                title="Edit player name/number"
                            >
                                ‚úèÔ∏è
                            </button>
                            <button
                                onclick="removePlayer(${player.id})"
                                tabindex="-1"
                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                title="Remove player"
                            >
                                üóëÔ∏è
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Hitting Drills</h4>
                        ${hittingDrills.map(drill => {
                            const values = player.hittingData[drill.id] || Array(drill.attempts).fill(null);
                            const score = calculateHittingScore(drill.id, values);
                            
                            if (drill.type === 'yesno_sum') {
                                const yesCount = values.filter(v => v === true || v === 'Y').length;
                                
                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="ml-3 text-sm font-bold text-green-600" data-score-display data-drill-id="${drill.id}" data-drill-type="hitting" data-max-score="5">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-5 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <select
                                                        onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="" ${val === null ? 'selected' : ''}>-</option>
                                                        <option value="Y" ${val === true || val === 'Y' ? 'selected' : ''}>Y</option>
                                                        <option value="N" ${val === false || val === 'N' ? 'selected' : ''}>N</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else if (drill.type === 'yesno') {
                                const yesCount = values.filter(v => v === true || v === 'Y').length;
                                const noCount = values.filter(v => v === false || v === 'N').length;
                                
                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="text-xs text-gray-500" data-avg-display="${drill.id}">Y: ${yesCount} | N: ${noCount}</span>
                                                <span class="ml-3 text-sm font-bold text-green-600" data-score-display data-drill-id="${drill.id}" data-drill-type="hitting" data-max-score="1">Score: ${score}/1</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <select
                                                        onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="" ${val === null ? 'selected' : ''}>-</option>
                                                        <option value="Y" ${val === true || val === 'Y' ? 'selected' : ''}>Y</option>
                                                        <option value="N" ${val === false || val === 'N' ? 'selected' : ''}>N</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else {
                                const validVals = values.filter(v => v !== null && !isNaN(v));
                                const avgValue = validVals.length > 0
                                    ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(1)
                                    : 'N/A';
                                
                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="text-xs text-gray-500" data-avg-display="${drill.id}">Avg: ${avgValue} mph</span>
                                                <span class="ml-3 text-sm font-bold text-green-600" data-score-display data-drill-id="${drill.id}" data-drill-type="hitting" data-max-score="5">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        min="0"
                                                        placeholder="0.0"
                                                        value="${val !== null ? val : ''}"
                                                        onchange="updateHittingData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        ${categories.map(cat => `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">${cat.name}</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="${cat.max}"
                                    value="${player.scores[cat.id]}"
                                    onchange="updateScore(${player.id}, '${cat.id}', this.value)"
                                    class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                />
                            </div>
                        `).join('')}
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Hustle & Energy</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${hustleEnergyCategories.map(cat => `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">${cat.name}</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="${cat.max}"
                                        value="${player.scores[cat.id] !== undefined ? player.scores[cat.id] : 0}"
                                        onchange="updateScore(${player.id}, '${cat.id}', this.value)"
                                        class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    />
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Speed Drills (enter times in seconds)</h4>
                        ${speedDrills.map(drill => {
                            const times = player.speedTimes[drill.id];
                            const score = calculateSpeedScore(drill.id, times);
                            const avgTime = times.filter(t => t !== null && !isNaN(t)).length > 0
                                ? (times.filter(t => t !== null && !isNaN(t)).reduce((sum, t) => sum + t, 0) / times.filter(t => t !== null && !isNaN(t)).length).toFixed(2)
                                : 'N/A';
                            
                            return `
                                <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                        <div class="text-right">
                                            <span class="text-xs text-gray-500" data-avg-display="${drill.id}">Avg: ${avgTime}s</span>
                                            <span class="ml-3 text-sm font-bold text-green-600" data-score-display data-drill-id="${drill.id}" data-drill-type="speed">Score: ${score}/5</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${times.map((time, idx) => `
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    min="0"
                                                    placeholder="0.00"
                                                    value="${time !== null ? time : ''}"
                                                    onchange="updateSpeedTime(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                />
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Catcher Drills</h4>
                        ${catcherDrills.map(drill => {
                            if (!player.catcherData) {
                                player.catcherData = {
                                    poptime: [null, null, null],
                                    throwaccuracy: [null, null, null],
                                    throwspeed: [null, null, null],
                                    popfly: [null, null, null],
                                    blocking: null,
                                    buntfielding: null
                                };
                            }

                            if (drill.type === 'overall') {
                                // Single overall score (1-5)
                                const value = player.catcherData[drill.id];
                                const score = calculateCatcherScore(drill.id, value);

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <span class="text-sm font-bold text-green-600">Score: ${score}/5</span>
                                        </div>
                                        <select
                                            onchange="updateCatcherData(${player.id}, '${drill.id}', 0, this.value)"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">-</option>
                                            <option value="1" ${value === 1 ? 'selected' : ''}>1</option>
                                            <option value="2" ${value === 2 ? 'selected' : ''}>2</option>
                                            <option value="3" ${value === 3 ? 'selected' : ''}>3</option>
                                            <option value="4" ${value === 4 ? 'selected' : ''}>4</option>
                                            <option value="5" ${value === 5 ? 'selected' : ''}>5</option>
                                        </select>
                                    </div>
                                `;
                            } else if (drill.type === 'accuracy') {
                                // Throwing accuracy: 0, 1, or 3 per attempt
                                const values = player.catcherData[drill.id] || [null, null, null];
                                const score = calculateCatcherScore(drill.id, values);

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <span class="text-sm font-bold text-green-600">Score: ${score}/9</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <select
                                                        onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="">-</option>
                                                        <option value="0" ${val === 0 ? 'selected' : ''}>Off (0)</option>
                                                        <option value="1" ${val === 1 ? 'selected' : ''}>1 Bounce (1)</option>
                                                        <option value="3" ${val === 3 ? 'selected' : ''}>On Mark (3)</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else if (drill.type === 'popfly') {
                                // Pop Fly: 0 = bad read, 1 = good attempt, 2 = caught
                                const values = player.catcherData[drill.id] || [null, null, null];
                                const score = calculateCatcherScore(drill.id, values);

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <span class="text-sm font-bold text-green-600">Score: ${score}/6</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <select
                                                        onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="">-</option>
                                                        <option value="0" ${val === 0 ? 'selected' : ''}>Bad Read (0)</option>
                                                        <option value="1" ${val === 1 ? 'selected' : ''}>Good Attempt (1)</option>
                                                        <option value="2" ${val === 2 ? 'selected' : ''}>Caught (2)</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Number type (poptime, throwspeed)
                                const values = player.catcherData[drill.id] || [null, null, null];
                                const score = calculateCatcherScore(drill.id, values);
                                const validVals = values.filter(v => v !== null && !isNaN(v));
                                const avgValue = validVals.length > 0
                                    ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(2)
                                    : 'N/A';

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="text-xs text-gray-500">Avg: ${avgValue}</span>
                                                <span class="ml-3 text-sm font-bold text-green-600">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        placeholder="0.00"
                                                        value="${val !== null ? val : ''}"
                                                        onchange="updateCatcherData(${player.id}, '${drill.id}', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Pitching Drills</h4>
                        ${pitchingDrills.map(drill => {
                            if (!player.pitchingData) {
                                player.pitchingData = {
                                    fastballspeed: [null, null, null],
                                    spinlocation: Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }))
                                };
                            }

                            if (drill.id === 'fastballspeed') {
                                // Fastball Speed: 3 attempts, scored 1-5
                                const values = player.pitchingData.fastballspeed || [null, null, null];
                                const score = calculatePitchingScore('fastballspeed', values);
                                const validVals = values.filter(v => v !== null && !isNaN(v));
                                const avgValue = validVals.length > 0
                                    ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(1)
                                    : 'N/A';

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <div class="text-right">
                                                <span class="text-xs text-gray-500">Avg: ${avgValue} mph</span>
                                                <span class="ml-3 text-sm font-bold text-green-600">Score: ${score}/5</span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${values.map((val, idx) => `
                                                <div>
                                                    <label class="block text-xs text-gray-600 mb-1">Attempt ${idx + 1}</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        min="0"
                                                        placeholder="0.0"
                                                        value="${val !== null ? val : ''}"
                                                        onchange="updatePitchingData(${player.id}, 'fastballspeed', ${idx}, this.value)"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    />
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else if (drill.id === 'spinlocation') {
                                // Spin & Location: 8 attempts with pitch type, spin, and location
                                const attempts = player.pitchingData.spinlocation || Array(8).fill(null).map(() => ({ pitchType: '', spin: null, location: null }));
                                const score = calculatePitchingScore('spinlocation', attempts);

                                return `
                                    <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-sm font-medium text-gray-700">${drill.name}</label>
                                            <span class="text-sm font-bold text-green-600">Score: ${score}/16</span>
                                        </div>
                                        <div class="text-xs text-gray-600 mb-2">Score: 0 if neither correct, 1 if either correct, 2 if both correct</div>
                                        <div class="space-y-2">
                                            ${attempts.map((attempt, idx) => {
                                                const attemptScore = (attempt.spin && attempt.location) ? 2 : ((attempt.spin || attempt.location) ? 1 : 0);
                                                return `
                                                    <div class="grid grid-cols-12 gap-2 items-center bg-white p-2 rounded">
                                                        <div class="col-span-1 text-xs text-gray-500 text-center">#${idx + 1}</div>
                                                        <div class="col-span-4">
                                                            <select
                                                                onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.value, 'pitchType')"
                                                                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                            >
                                                                <option value="">Select pitch...</option>
                                                                ${pitchTypes.map(type => `
                                                                    <option value="${type}" ${attempt.pitchType === type ? 'selected' : ''}>${type}</option>
                                                                `).join('')}
                                                            </select>
                                                        </div>
                                                        <div class="col-span-3">
                                                            <label class="flex items-center cursor-pointer">
                                                                <input
                                                                    type="checkbox"
                                                                    ${attempt.spin === true ? 'checked' : ''}
                                                                    onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.checked, 'spin')"
                                                                    class="mr-1"
                                                                />
                                                                <span class="text-xs">Spin ‚úì</span>
                                                            </label>
                                                        </div>
                                                        <div class="col-span-3">
                                                            <label class="flex items-center cursor-pointer">
                                                                <input
                                                                    type="checkbox"
                                                                    ${attempt.location === true ? 'checked' : ''}
                                                                    onchange="updatePitchingData(${player.id}, 'spinlocation', ${idx}, this.checked, 'location')"
                                                                    class="mr-1"
                                                                />
                                                                <span class="text-xs">Location ‚úì</span>
                                                            </label>
                                                        </div>
                                                        <div class="col-span-1 text-center">
                                                            <span class="text-xs font-bold ${attemptScore === 2 ? 'text-green-600' : (attemptScore === 1 ? 'text-yellow-600' : 'text-gray-400')}">${attemptScore}</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea
                            onchange="updateNotes(${player.id}, this.value)"
                            placeholder="Add observations, positions tried, etc..."
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none"
                            rows="3"
                        >${player.notes}</textarea>
                    </div>
                </div>
            `;
        }

        function updateScoresOnly(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            // Update all score displays in the current player's card
            document.querySelectorAll('[data-score-display]').forEach(el => {
                const drillId = el.getAttribute('data-drill-id');
                const drillType = el.getAttribute('data-drill-type');

                if (drillType === 'hitting') {
                    const score = calculateHittingScore(drillId, player.hittingData[drillId]);
                    el.textContent = `Score: ${score}/${el.getAttribute('data-max-score')}`;

                    // Update averages and counts
                    const avgEl = document.querySelector(`[data-avg-display="${drillId}"]`);
                    if (avgEl) {
                        const values = player.hittingData[drillId] || [];
                        const drillInfo = hittingDrills.find(d => d.id === drillId);

                        if (drillInfo && drillInfo.type === 'yesno') {
                            const yesCount = values.filter(v => v === true || v === 'Y').length;
                            const noCount = values.filter(v => v === false || v === 'N').length;
                            avgEl.textContent = `Y: ${yesCount} | N: ${noCount}`;
                        } else if (drillInfo && drillInfo.type !== 'yesno_sum') {
                            const validVals = values.filter(v => v !== null && !isNaN(v));
                            const avgValue = validVals.length > 0
                                ? (validVals.reduce((sum, v) => sum + v, 0) / validVals.length).toFixed(1)
                                : 'N/A';
                            avgEl.textContent = `Avg: ${avgValue} mph`;
                        }
                    }
                } else if (drillType === 'speed') {
                    const score = calculateSpeedScore(drillId, player.speedTimes[drillId]);
                    el.textContent = `Score: ${score}/5`;

                    // Update average
                    const avgEl = document.querySelector(`[data-avg-display="${drillId}"]`);
                    if (avgEl) {
                        const times = player.speedTimes[drillId] || [];
                        const validTimes = times.filter(t => t !== null && !isNaN(t));
                        const avgTime = validTimes.length > 0
                            ? (validTimes.reduce((sum, t) => sum + t, 0) / validTimes.length).toFixed(2)
                            : 'N/A';
                        avgEl.textContent = `Avg: ${avgTime}s`;
                    }
                }
            });

            // Update total score
            const hittingScore = getHittingScore(player);
            const speedScore = getSpeedScore(player);
            const catcherScore = getCatcherScore(player);
            const regularScore = Object.values(player.scores).reduce((sum, score) => sum + score, 0);
            const totalScore = getTotalScore(player);

            const totalScoreEl = document.querySelector('[data-total-score]');
            if (totalScoreEl) {
                totalScoreEl.textContent = `${totalScore}/118`;
            }

            const pitchingScore = getPitchingScore(player);
            const subscoreEl = document.querySelector('[data-subscore]');
            if (subscoreEl) {
                subscoreEl.textContent = `Hitting: ${hittingScore}/23 | Speed: ${speedScore}/15 | Catcher: ${catcherScore}/35 | Pitching: ${pitchingScore}/21`;
            }

            // Update dropdown
            const dropdown = document.getElementById('playerDropdown');
            if (dropdown && viewMode === 'single') {
                const option = dropdown.querySelector(`option[value="${currentPlayerIndex}"]`);
                if (option) {
                    option.textContent = `${player.name}${player.number ? ' (#' + player.number + ')' : ''} - Score: ${totalScore}/118`;
                }
            }
        }

        function renderWithFocus() {
            // Save the currently focused element
            const activeElement = document.activeElement;
            const tagName = activeElement ? activeElement.tagName : null;
            const tabIndex = activeElement ? Array.from(document.querySelectorAll('input, select, textarea')).indexOf(activeElement) : -1;

            render();

            // Restore focus to the next input element
            if (tabIndex >= 0) {
                const allInputs = document.querySelectorAll('input, select, textarea');
                if (allInputs[tabIndex]) {
                    setTimeout(() => {
                        allInputs[tabIndex].focus();
                    }, 0);
                }
            }
        }

        function render() {
            const singleView = document.getElementById('singlePlayerView');
            const stationsView = document.getElementById('stationsView');
            const allView = document.getElementById('allPlayersView');
            const catcherView = document.getElementById('catcherScoresView');
            const pitcherView = document.getElementById('pitcherScoresView');
            const emptyState = document.getElementById('emptyState');

            if (players.length === 0) {
                singleView.classList.add('hidden');
                stationsView.classList.add('hidden');
                allView.classList.add('hidden');
                catcherView.classList.add('hidden');
                pitcherView.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            if (viewMode === 'players') {
                singleView.classList.remove('hidden');
                stationsView.classList.add('hidden');
                allView.classList.add('hidden');
                catcherView.classList.add('hidden');
                pitcherView.classList.add('hidden');

                const player = players[currentPlayerIndex];
                document.getElementById('currentPlayerCard').innerHTML = renderPlayerCard(player);
                document.getElementById('playerCounter').textContent = `Player ${currentPlayerIndex + 1} of ${players.length}`;

                // Update dropdown
                const dropdown = document.getElementById('playerDropdown');
                dropdown.innerHTML = players.map((p, idx) =>
                    `<option value="${idx}" ${idx === currentPlayerIndex ? 'selected' : ''}>
                        ${p.name}${p.number ? ' (#' + p.number + ')' : ''} - Score: ${getTotalScore(p)}/97
                    </option>`
                ).join('');

                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                prevBtn.disabled = currentPlayerIndex === 0;
                nextBtn.disabled = currentPlayerIndex === players.length - 1;

            } else if (viewMode === 'stations') {
                singleView.classList.add('hidden');
                stationsView.classList.remove('hidden');
                allView.classList.add('hidden');
                catcherView.classList.add('hidden');
                pitcherView.classList.add('hidden');

                // Show/hide player selector based on whether station is selected
                const playerSelector = document.getElementById('stationPlayerSelector');
                if (selectedStation) {
                    playerSelector.style.display = 'block';

                    // Populate station player dropdown
                    const stationDropdown = document.getElementById('stationPlayerDropdown');
                    stationDropdown.innerHTML = `
                        <option value="">-- Select a player --</option>
                        ${players.map(p => `
                            <option value="${p.id}" ${p.id === selectedStationPlayer ? 'selected' : ''}>
                                ${p.name}${p.number ? ' (#' + p.number + ')' : ''} - Score: ${getTotalScore(p)}/118
                            </option>
                        `).join('')}
                    `;
                } else {
                    playerSelector.style.display = 'none';
                }

                // Render station content
                renderStationContent();

            } else if (viewMode === 'all') {
                singleView.classList.add('hidden');
                stationsView.classList.add('hidden');
                allView.classList.remove('hidden');
                catcherView.classList.add('hidden');
                pitcherView.classList.add('hidden');

                const sortedPlayers = [...players].sort((a, b) => getTotalScore(b) - getTotalScore(a));
                const playersList = document.getElementById('playersList');

                playersList.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Rank</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Jersey #</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Fielding</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Throwing</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Attitude</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Hitting</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Speed</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b bg-green-50">Total Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map((player, index) => {
                                    const hittingScore = getHittingScore(player);
                                    const speedScore = getSpeedScore(player);
                                    const totalScore = getTotalScore(player);

                                    return `
                                        <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                                            <td class="px-4 py-3 text-center border-b">
                                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-200 text-gray-700 font-bold">
                                                    ${index + 1}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 border-b font-medium text-gray-800">${player.name}</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-600">${player.number || '-'}</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-700">${player.scores.fielding}/10</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-700">${player.scores.throwing}/10</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-700">${player.scores.attitude}/10</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-700">${hittingScore}/23</td>
                                            <td class="px-4 py-3 text-center border-b text-gray-700">${speedScore}/15</td>
                                            <td class="px-4 py-3 text-center border-b bg-green-50">
                                                <span class="text-lg font-bold text-green-600">${totalScore}/118</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (viewMode === 'catcherScores') {
                singleView.classList.add('hidden');
                stationsView.classList.add('hidden');
                allView.classList.add('hidden');
                catcherView.classList.remove('hidden');
                pitcherView.classList.add('hidden');

                const sortedPlayers = [...players]
                    .filter(p => p.catcherData && (
                        (p.catcherData.poptime && p.catcherData.poptime.some(v => v !== null)) ||
                        (p.catcherData.throwaccuracy && p.catcherData.throwaccuracy.some(v => v !== null)) ||
                        (p.catcherData.throwspeed && p.catcherData.throwspeed.some(v => v !== null)) ||
                        (p.catcherData.popfly && p.catcherData.popfly.some(v => v !== null)) ||
                        p.catcherData.blocking !== null ||
                        p.catcherData.buntfielding !== null
                    ))
                    .sort((a, b) => getCatcherScore(b) - getCatcherScore(a));

                const catcherScoresList = document.getElementById('catcherScoresList');

                if (sortedPlayers.length === 0) {
                    catcherScoresList.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <p class="text-lg">No catcher data recorded yet.</p>
                        </div>
                    `;
                } else {
                    catcherScoresList.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-purple-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Rank</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Name</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Jersey #</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Pop Time</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Throw Accuracy</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Throw Speed</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Pop Fly</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Blocking</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Bunt Fielding</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b bg-purple-50">Total Catcher</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedPlayers.map((player, index) => {
                                        const catcherData = player.catcherData || {};
                                        const poptime = catcherData.poptime || [null, null, null];
                                        const throwaccuracy = catcherData.throwaccuracy || [null, null, null];
                                        const throwspeed = catcherData.throwspeed || [null, null, null];
                                        const popfly = catcherData.popfly || [null, null, null];

                                        const poptimeAvg = poptime.filter(v => v !== null && !isNaN(v)).length > 0
                                            ? (poptime.filter(v => v !== null && !isNaN(v)).reduce((s, v) => s + v, 0) / poptime.filter(v => v !== null && !isNaN(v)).length).toFixed(2)
                                            : '-';
                                        const throwspeedAvg = throwspeed.filter(v => v !== null && !isNaN(v)).length > 0
                                            ? (throwspeed.filter(v => v !== null && !isNaN(v)).reduce((s, v) => s + v, 0) / throwspeed.filter(v => v !== null && !isNaN(v)).length).toFixed(1)
                                            : '-';

                                        const catcherScore = getCatcherScore(player);

                                        return `
                                            <tr class="hover:bg-purple-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                                                <td class="px-4 py-3 text-center border-b">
                                                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-200 text-purple-700 font-bold">
                                                        ${index + 1}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 border-b font-medium text-gray-800">${player.name}</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-600">${player.number || '-'}</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${poptimeAvg}s (${calculateCatcherScore('poptime', poptime)}/5)</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${calculateCatcherScore('throwaccuracy', throwaccuracy)}/9</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${throwspeedAvg} mph (${calculateCatcherScore('throwspeed', throwspeed)}/5)</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${calculateCatcherScore('popfly', popfly)}/6</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${catcherData.blocking || '-'}/5</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${catcherData.buntfielding || '-'}/5</td>
                                                <td class="px-4 py-3 text-center border-b bg-purple-50">
                                                    <span class="text-lg font-bold text-purple-600">${catcherScore}/35</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } else if (viewMode === 'pitcherScores') {
                singleView.classList.add('hidden');
                stationsView.classList.add('hidden');
                allView.classList.add('hidden');
                catcherView.classList.add('hidden');
                pitcherView.classList.remove('hidden');

                const sortedPlayers = [...players]
                    .filter(p => p.pitchingData && (
                        (p.pitchingData.fastballspeed && p.pitchingData.fastballspeed.some(v => v !== null)) ||
                        (p.pitchingData.spinlocation && p.pitchingData.spinlocation.some(a => a.pitchType))
                    ))
                    .sort((a, b) => getPitchingScore(b) - getPitchingScore(a));

                const pitcherScoresList = document.getElementById('pitcherScoresList');

                if (sortedPlayers.length === 0) {
                    pitcherScoresList.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <p class="text-lg">No pitching data recorded yet.</p>
                        </div>
                    `;
                } else {
                    pitcherScoresList.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-orange-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Rank</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Name</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Jersey #</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Fastball Speed</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b">Spin & Location</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b bg-orange-50">Total Pitching</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedPlayers.map((player, index) => {
                                        const pitchingData = player.pitchingData || {};
                                        const fastballspeed = pitchingData.fastballspeed || [null, null, null];
                                        const spinlocation = pitchingData.spinlocation || [];

                                        const fastballAvg = fastballspeed.filter(v => v !== null && !isNaN(v)).length > 0
                                            ? (fastballspeed.filter(v => v !== null && !isNaN(v)).reduce((s, v) => s + v, 0) / fastballspeed.filter(v => v !== null && !isNaN(v)).length).toFixed(1)
                                            : '-';

                                        const fastballScore = calculatePitchingScore('fastballspeed', fastballspeed);
                                        const spinlocationScore = calculatePitchingScore('spinlocation', spinlocation);
                                        const pitchingScore = getPitchingScore(player);

                                        return `
                                            <tr class="hover:bg-orange-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                                                <td class="px-4 py-3 text-center border-b">
                                                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-orange-200 text-orange-700 font-bold">
                                                        ${index + 1}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 border-b font-medium text-gray-800">${player.name}</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-600">${player.number || '-'}</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${fastballAvg} mph (${fastballScore}/5)</td>
                                                <td class="px-4 py-3 text-center border-b text-gray-700">${spinlocationScore}/16</td>
                                                <td class="px-4 py-3 text-center border-b bg-orange-50">
                                                    <span class="text-lg font-bold text-orange-600">${pitchingScore}/21</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (viewMode === 'players' && players.length > 0) {
                if (e.key === 'ArrowLeft') {
                    previousPlayer();
                } else if (e.key === 'ArrowRight') {
                    nextPlayer();
                }
            }
        });

        // Allow Enter key to add player
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPlayer();
        });
        document.getElementById('playerNumber').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPlayer();
        });

        // Note: Auto-load from Google Sheets happens in unlockApp() after password check
    </script>
</body>
</html>
