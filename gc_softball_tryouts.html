<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GC Softball Tryouts 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .score-btn { transition: all 0.2s; }
        .score-btn:hover { transform: scale(1.05); }
        .score-btn.selected { ring: 2px; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-4">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <img src="GClogo.jpg" alt="Logo" class="h-20 w-20 object-contain mx-auto mb-4" />
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Softball Tryout Scorer</h1>
                <p class="text-gray-600">Select your account and enter password</p>
            </div>
            <div class="space-y-4">
                <select id="userSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg">
                    <option value="">-- Select Coach --</option>
                    <option value="nick">Nick</option>
                    <option value="bob">Bob</option>
                    <option value="sophia">Sophia</option>
                    <option value="amy">Amy</option>
                    <option value="bill">Bill</option>
                    <option value="gabby">Gabby</option>
                    <option value="guest">Guest</option>
                </select>
                <input
                    type="password"
                    id="passwordInput"
                    placeholder="Enter password"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg"
                    onkeypress="if(event.key === 'Enter') checkLogin()"
                />
                <button onclick="checkLogin()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-lg">
                    Login
                </button>
                <div id="loginError" class="text-red-600 text-center text-sm hidden">
                    Incorrect password or no coach selected.
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="max-w-5xl mx-auto hidden" id="appContent">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <img src="GClogo.jpg" alt="Logo" class="h-16 w-16 object-contain" />
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">GC Softball Tryouts 2026</h1>
                            <p class="text-gray-600">Logged in as: <span id="currentUserDisplay" class="font-semibold text-green-600"></span></p>
                        </div>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Logout
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-2 flex-wrap justify-center border-t pt-4">
                    <button onclick="toggleSection('advancedOptions')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        ‚öôÔ∏è Options
                    </button>
                    <button onclick="toggleSection('scoringConfigSection')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        üìä Scoring Thresholds
                    </button>
                    <button onclick="uploadToSheets()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        ‚¨ÜÔ∏è Sync to Sheets
                    </button>
                    <button onclick="downloadFromSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ‚¨áÔ∏è Download from Sheets
                    </button>
                    <button onclick="showUserGuideModal()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700">
                        üìñ User Guide
                    </button>
                </div>

                <!-- Advanced Options -->
                <div id="advancedOptions" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">Add Player</h3>
                    <div class="flex gap-3 flex-wrap mb-4">
                        <input type="text" id="playerName" placeholder="Player Name" class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                        <input type="text" id="playerNumber" placeholder="Jersey #" class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                        <button onclick="addPlayer()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ‚ûï Add Player
                        </button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ‚¨áÔ∏è Export CSV
                        </button>
                        <button onclick="showReportModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            üìä Generate Reports
                        </button>
                        <button onclick="clearAllData()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div>

                <!-- Scoring Configuration Section -->
                <div id="scoringConfigSection" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-3">üìä Scoring Thresholds Configuration</h3>
                    <p class="text-sm text-gray-600 mb-4">Customize scoring thresholds for all timed drills. Lower times = higher scores (except Broad Jump where higher distance = higher scores).</p>

                    <!-- Speed Drills Configuration -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-md mb-3">‚ö° Baserunning Speed Drills (seconds)</h4>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- H‚Üí1B -->
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-medium mb-2 block">H‚Üí1B (seconds)</label>
                                <div class="grid grid-cols-5 gap-2 text-xs">
                                    <div>
                                        <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                        <input type="number" step="0.1" id="h1b_t5" class="px-2 py-1 border rounded w-full text-center" title="5 points if less than this value">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                        <input type="number" step="0.1" id="h1b_t4" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                        <input type="number" step="0.1" id="h1b_t3" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                        <input type="number" step="0.1" id="h1b_t2" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                        <input type="number" step="0.1" id="h1b_t1" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â• this</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2B‚ÜíH -->
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-medium mb-2 block">2B‚ÜíH (seconds)</label>
                                <div class="grid grid-cols-5 gap-2 text-xs">
                                    <div>
                                        <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                        <input type="number" step="0.1" id="2bh_t5" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                        <input type="number" step="0.1" id="2bh_t4" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                        <input type="number" step="0.1" id="2bh_t3" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                        <input type="number" step="0.1" id="2bh_t2" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                        <input type="number" step="0.1" id="2bh_t1" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â• this</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Catching Drills Configuration -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-md mb-3 flex items-center gap-2">
                            <img src="catcher.jpg" alt="Catcher" class="w-5 h-5 object-contain"> Catching Drills (seconds)
                        </h4>

                        <div class="bg-white p-3 rounded border">
                            <label class="text-sm font-medium mb-2 block">Pop Time (seconds)</label>
                            <div class="grid grid-cols-5 gap-2 text-xs">
                                <div>
                                    <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                    <input type="number" step="0.01" id="poptime_t5" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                    <input type="number" step="0.01" id="poptime_t4" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                    <input type="number" step="0.01" id="poptime_t3" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                    <input type="number" step="0.01" id="poptime_t2" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                    <input type="number" step="0.01" id="poptime_t1" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&gt; this</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Explosiveness Drills Configuration -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-md mb-3">üí• Explosiveness Drills</h4>

                        <div class="grid grid-cols-1 gap-4">
                            <!-- Pro Agility -->
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-medium mb-2 block">Pro Agility (seconds)</label>
                                <div class="grid grid-cols-5 gap-2 text-xs">
                                    <div>
                                        <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                        <input type="number" step="0.1" id="proagility_t5" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                        <input type="number" step="0.1" id="proagility_t4" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                        <input type="number" step="0.1" id="proagility_t3" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                        <input type="number" step="0.1" id="proagility_t2" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â§ this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                        <input type="number" step="0.1" id="proagility_t1" class="px-2 py-1 border rounded w-full text-center">
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&gt; this</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Broad Jump - Feet and Inches -->
                            <div class="bg-white p-3 rounded border">
                                <label class="text-sm font-medium mb-2 block">Broad Jump (feet' inches") - Higher is better</label>
                                <div class="grid grid-cols-5 gap-2 text-xs">
                                    <div>
                                        <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                        <div class="flex gap-1">
                                            <input type="number" min="0" max="15" id="broadjump_t1_feet" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="ft">
                                            <input type="number" min="0" max="11" id="broadjump_t1_inches" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="in">
                                        </div>
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                        <div class="flex gap-1">
                                            <input type="number" min="0" max="15" id="broadjump_t2_feet" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="ft">
                                            <input type="number" min="0" max="11" id="broadjump_t2_inches" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="in">
                                        </div>
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                        <div class="flex gap-1">
                                            <input type="number" min="0" max="15" id="broadjump_t3_feet" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="ft">
                                            <input type="number" min="0" max="11" id="broadjump_t3_inches" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="in">
                                        </div>
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                        <div class="flex gap-1">
                                            <input type="number" min="0" max="15" id="broadjump_t4_feet" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="ft">
                                            <input type="number" min="0" max="11" id="broadjump_t4_inches" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="in">
                                        </div>
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                    </div>
                                    <div>
                                        <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                        <div class="flex gap-1">
                                            <input type="number" min="0" max="15" id="broadjump_t5_feet" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="ft">
                                            <input type="number" min="0" max="11" id="broadjump_t5_inches" class="px-1 py-1 border rounded w-1/2 text-center" placeholder="in">
                                        </div>
                                        <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â• this</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hitting Drills Configuration -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-md mb-3">üèè Hitting Drills (mph) - Higher is better</h4>

                        <div class="bg-white p-3 rounded border">
                            <label class="text-sm font-medium mb-2 block">Bat Speed (mph)</label>
                            <div class="grid grid-cols-5 gap-2 text-xs">
                                <div>
                                    <div class="text-center font-semibold text-red-600 mb-1">1 pt</div>
                                    <input type="number" step="1" id="batspeed_t1" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-orange-600 mb-1">2 pts</div>
                                    <input type="number" step="1" id="batspeed_t2" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-yellow-600 mb-1">3 pts</div>
                                    <input type="number" step="1" id="batspeed_t3" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-blue-600 mb-1">4 pts</div>
                                    <input type="number" step="1" id="batspeed_t4" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">&lt; this</div>
                                </div>
                                <div>
                                    <div class="text-center font-semibold text-green-600 mb-1">5 pts</div>
                                    <input type="number" step="1" id="batspeed_t5" class="px-2 py-1 border rounded w-full text-center">
                                    <div class="text-center text-gray-500 mt-1" style="font-size: 0.65em;">‚â• this</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2 justify-center">
                        <button onclick="loadScoringDefaults()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Reset to Defaults
                        </button>
                        <button onclick="saveScoringConfig()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            üíæ Save Thresholds
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-sm text-green-600" id="saveStatus">üîÑ Auto-syncing with Google Sheets</div>
        </div>

        <!-- Category Navigation -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex gap-2 flex-wrap justify-center">
                <button onclick="selectCategory('catching')" id="cat-catching" class="category-btn px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 font-medium flex items-center gap-1">
                    <img src="catcher.jpg" alt="Catcher" class="w-5 h-5 object-contain"> Catching
                </button>
                <button onclick="selectCategory('baserunning')" id="cat-baserunning" class="category-btn px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium">
                    üèÉ Baserunning
                </button>
                <button onclick="selectCategory('intangibles')" id="cat-intangibles" class="category-btn px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 font-medium">
                    ‚≠ê Intangibles
                </button>
                <button onclick="selectCategory('pitching')" id="cat-pitching" class="category-btn px-4 py-2 bg-pink-100 text-pink-700 rounded-lg hover:bg-pink-200 font-medium flex items-center gap-1">
                    <img src="pitching.jpg" alt="Pitching" class="w-5 h-5 object-contain"> Pitching
                </button>
                <button onclick="selectCategory('infield')" id="cat-infield" class="category-btn px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 font-medium flex items-center gap-1">
                    <img src="fielding.jpg" alt="Infield" class="w-5 h-5 object-contain"> Infield
                </button>
                <button onclick="selectCategory('outfield')" id="cat-outfield" class="category-btn px-4 py-2 bg-teal-100 text-teal-700 rounded-lg hover:bg-teal-200 font-medium flex items-center gap-1">
                    <img src="fielding.jpg" alt="Outfield" class="w-5 h-5 object-contain"> Outfield
                </button>
                <button onclick="selectCategory('throwing')" id="cat-throwing" class="category-btn px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-medium flex items-center gap-1">
                    <img src="softball fielding.JPG" alt="Throwing" class="w-5 h-5 object-contain"> Throwing
                </button>
                <button onclick="selectCategory('hitting')" id="cat-hitting" class="category-btn px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 font-medium flex items-center gap-1">
                    <img src="hitting.jpg" alt="Hitting" class="w-5 h-5 object-contain"> Hitting
                </button>
            </div>
        </div>

        <!-- Player Selection -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex gap-4 mb-2">
                <button onclick="setPlayerSelectMode('all')" id="selectMode-all" class="px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-medium">All Players</button>
                <button onclick="setPlayerSelectMode('groups')" id="selectMode-groups" class="px-3 py-1 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300">By Group</button>
            </div>
            <select id="playerSelect" onchange="selectPlayer(this.value)" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">-- Select a player --</option>
            </select>
        </div>

        <!-- Scoring Area -->
        <div id="scoringArea" class="hidden">
            <!-- Dynamic content based on category -->
        </div>

        <!-- All Players View -->
        <div id="allPlayersView" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">All Players</h2>
                <div class="flex gap-2">
                    <button onclick="setPlayerFilter('all')" id="filter-all" class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm">All Players</button>
                    <button onclick="setPlayerFilter('catchers')" id="filter-catchers" class="px-3 py-1 rounded-lg bg-purple-100 text-purple-700 text-sm hover:bg-purple-200">Catchers</button>
                    <button onclick="setPlayerFilter('pitchers')" id="filter-pitchers" class="px-3 py-1 rounded-lg bg-pink-100 text-pink-700 text-sm hover:bg-pink-200">Pitchers</button>
                </div>
            </div>
            <div id="playersList"></div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-start justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-indigo-600 text-white">
                    <h2 class="text-xl font-semibold">üìä Player Summary Reports</h2>
                    <button onclick="closeReportModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
                </div>
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex gap-4 items-center flex-wrap">
                        <label class="font-medium">Select Player:</label>
                        <select id="reportPlayerSelect" onchange="generateReport()" class="px-4 py-2 border rounded-lg">
                            <option value="">-- Choose a player --</option>
                        </select>
                        <button onclick="generateAllReports()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Generate All Players Report
                        </button>
                        <button onclick="exportCurrentReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üì• Export Report
                        </button>
                    </div>
                </div>
                <div id="reportContent" class="p-6 overflow-y-auto flex-1">
                    <p class="text-gray-500 text-center">Select a player to generate their summary report</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Guide Modal -->
    <div id="userGuideModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-start justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-amber-600 text-white">
                    <h2 class="text-xl font-semibold">üìñ Coach User Guide</h2>
                    <button onclick="closeUserGuideModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
                </div>
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex gap-4 items-center flex-wrap">
                        <button onclick="exportUserGuideHTML()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üì• Export as HTML
                        </button>
                        <button onclick="printUserGuide()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            üñ®Ô∏è Print Guide
                        </button>
                    </div>
                </div>
                <div id="userGuideContent" class="p-6 overflow-y-auto flex-1 prose max-w-none">
                    <!-- Guide content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkTRC_6ucRdv-PBiaNq4ybRGYzvUbhC0vBPJGrPf3xEHOmcs284Fij7TCRhUdvc6Z1/exec';
        const STORAGE_KEY = 'gc_softball_tryouts_2026';
        const APP_PASSWORD = 'nick2026';
        const VALID_USERS = ['nick', 'bob', 'sophia', 'amy', 'bill', 'gabby', 'guest'];

        // ============================================
        // STATE
        // ============================================
        let currentUser = null;
        let players = [];
        let selectedPlayerId = null;
        let selectedCategory = 'catching';
        let isSyncing = false;
        let autoUploadTimer = null;
        let pendingChanges = false;  // Track if changes happened during upload
        let lastSaveTimestamp = 0;   // Track when data was last saved
        let playerViewFilter = 'all';  // 'all', 'catchers', 'pitchers'
        let playerSelectMode = 'all';  // 'all' or 'groups'
        const AUTO_UPLOAD_DELAY = 500; // 0.5 second delay before auto-sync (reduced for faster saves)

        // Define catchers and pitchers
        const CATCHERS = ['Isabel', 'Sophia', 'Claire', 'Lauryn', 'Katelyn'];
        const PITCHERS = ['MDR', 'Cayla', 'Maddy', 'Ashley', 'Autumn'];

        // Define tryout groups
        const TRYOUT_GROUPS = {
            'A': ['Maggie', 'Sophia', 'Clara', 'Mairin', 'Aubrey', 'Autumn', 'Ashley', 'Louisa', 'Molly', 'London'],
            'B': ['Rebecca', 'Julia', 'MJ', 'Shana', 'Kelsey', 'Katelyn', 'Kayla', 'Natalie', 'Annie', 'Jolyn'],
            'C': ['Paige', 'Isabel', 'MDR', 'Liv', 'Cayla', 'Meghan M', 'Lauryn', 'Giselle', 'Lizzie', 'Claire'],
            'Pitchers': ['Autumn', 'Maddy', 'MDR', 'Ashley', 'Cayla'],
            'Catchers': ['Isabel', 'Sophia', 'Claire', 'Lauryn', 'Katelyn']
        };

        // Get player's group based on name (for A/B/C groups)
        function getPlayerGroup(playerName) {
            const letterGroups = ['A', 'B', 'C'];
            for (const group of letterGroups) {
                const names = TRYOUT_GROUPS[group];
                if (names.some(name => playerName.toLowerCase().includes(name.toLowerCase()) ||
                               name.toLowerCase().includes(playerName.toLowerCase()))) {
                    return group;
                }
            }
            return null; // Unassigned
        }

        // Check if player is in a special group (Pitchers/Catchers)
        function isPlayerInGroup(playerName, groupName) {
            const names = TRYOUT_GROUPS[groupName] || [];
            return names.some(name => playerName.toLowerCase().includes(name.toLowerCase()) ||
                                     name.toLowerCase().includes(playerName.toLowerCase()));
        }

        // ============================================
        // SCORING THRESHOLDS
        // ============================================
        const SCORING_CONFIG_KEY = 'gc_softball_scoring_config';

        // Default scoring thresholds - can be configured in Scoring Thresholds section
        // Time-based drills: t5=5pts, t4=4pts, t3=3pts, t2=2pts, t1=1pt (lower time = higher score)
        // Broad jump: t1=1pt, t2=2pts, t3=3pts, t4=4pts, t5=5pts (higher distance = higher score)
        let scoringConfig = {
            // Speed metrics (lower is better) - t5 is fastest (5pts), t1 is slowest (1pt)
            h1b: { t5: 3.1, t4: 3.8, t3: 4.6, t2: 5.2, t1: 6.0 },
            '2bh': { t5: 5.75, t4: 6.25, t3: 7, t2: 8, t1: 9 },  // 2B to Home
            // Pop time (lower is better)
            poptime: { t5: 2.3, t4: 2.5, t3: 2.7, t2: 3.0, t1: 3.5 },
            // Pro Agility (lower is better)
            proagility: { t5: 4.3, t4: 4.6, t3: 5.0, t2: 5.5, t1: 6.0 },
            // Broad jump (higher is better) - stored as { feet, inches } for each threshold
            broadjump: {
                t1: { feet: 4, inches: 0 },   // < this = 1 pt
                t2: { feet: 4, inches: 0 },   // >= this = 2 pts
                t3: { feet: 5, inches: 0 },   // >= this = 3 pts
                t4: { feet: 6, inches: 0 },   // >= this = 4 pts
                t5: { feet: 7, inches: 0 }    // >= this = 5 pts
            },
            // Bat speed (higher is better) - mph
            batspeed: { t5: 70, t4: 63, t3: 55, t2: 48, t1: 48 }
        };

        // Get default scoring config
        function getDefaultScoringConfig() {
            return {
                h1b: { t5: 3.1, t4: 3.8, t3: 4.6, t2: 5.2, t1: 6.0 },
                '2bh': { t5: 5.75, t4: 6.25, t3: 7, t2: 8, t1: 9 },
                poptime: { t5: 2.3, t4: 2.5, t3: 2.7, t2: 3.0, t1: 3.5 },
                proagility: { t5: 4.3, t4: 4.6, t3: 5.0, t2: 5.5, t1: 6.0 },
                broadjump: {
                    t1: { feet: 4, inches: 0 },
                    t2: { feet: 4, inches: 0 },
                    t3: { feet: 5, inches: 0 },
                    t4: { feet: 6, inches: 0 },
                    t5: { feet: 7, inches: 0 }
                },
                batspeed: { t5: 70, t4: 63, t3: 55, t2: 48, t1: 48 }
            };
        }

        // Load scoring configuration from localStorage
        function loadScoringConfig() {
            try {
                const saved = localStorage.getItem(SCORING_CONFIG_KEY);
                if (saved) {
                    scoringConfig = JSON.parse(saved);
                }
                populateScoringInputs();
            } catch (error) {
                console.error('Error loading scoring config:', error);
            }
        }

        // Save scoring configuration to localStorage
        function saveScoringConfig() {
            try {
                // Read all values from inputs for time-based drills
                const timeDrills = ['h1b', '2bh', 'poptime', 'proagility'];

                timeDrills.forEach(drill => {
                    const cfg = scoringConfig[drill];
                    ['t5', 't4', 't3', 't2', 't1'].forEach(threshold => {
                        const inputId = `${drill}_${threshold}`;
                        const input = document.getElementById(inputId);
                        if (input && input.value !== '') {
                            cfg[threshold] = parseFloat(input.value);
                        }
                    });
                });

                // Handle broad jump separately (feet and inches)
                ['t1', 't2', 't3', 't4', 't5'].forEach(threshold => {
                    const feetInput = document.getElementById(`broadjump_${threshold}_feet`);
                    const inchesInput = document.getElementById(`broadjump_${threshold}_inches`);
                    if (feetInput || inchesInput) {
                        scoringConfig.broadjump[threshold] = {
                            feet: feetInput && feetInput.value !== '' ? parseInt(feetInput.value) : 0,
                            inches: inchesInput && inchesInput.value !== '' ? parseInt(inchesInput.value) : 0
                        };
                    }
                });

                // Handle bat speed (higher is better)
                if (!scoringConfig.batspeed) scoringConfig.batspeed = {};
                ['t5', 't4', 't3', 't2', 't1'].forEach(threshold => {
                    const input = document.getElementById(`batspeed_${threshold}`);
                    if (input && input.value !== '') {
                        scoringConfig.batspeed[threshold] = parseFloat(input.value);
                    }
                });

                localStorage.setItem(SCORING_CONFIG_KEY, JSON.stringify(scoringConfig));
                showSaveStatus('‚úì Scoring thresholds saved');

                // Refresh the current view to show updated scores
                renderScoringArea();
                renderAllPlayers();
            } catch (error) {
                console.error('Error saving scoring config:', error);
                showSaveStatus('‚ö†Ô∏è Failed to save scoring config');
            }
        }

        // Reset scoring configuration to defaults
        function loadScoringDefaults() {
            scoringConfig = getDefaultScoringConfig();
            populateScoringInputs();
            saveScoringConfig();
            showSaveStatus('‚úì Reset to default thresholds');
        }

        // Populate input fields with current config values
        function populateScoringInputs() {
            // Populate time-based drills
            const timeDrills = ['h1b', '2bh', 'poptime', 'proagility'];
            timeDrills.forEach(drill => {
                const cfg = scoringConfig[drill];
                if (cfg) {
                    ['t5', 't4', 't3', 't2', 't1'].forEach(threshold => {
                        const input = document.getElementById(`${drill}_${threshold}`);
                        if (input && cfg[threshold] !== undefined) {
                            input.value = cfg[threshold];
                        }
                    });
                }
            });

            // Populate broad jump (feet and inches)
            const bjCfg = scoringConfig.broadjump;
            if (bjCfg) {
                ['t1', 't2', 't3', 't4', 't5'].forEach(threshold => {
                    const feetInput = document.getElementById(`broadjump_${threshold}_feet`);
                    const inchesInput = document.getElementById(`broadjump_${threshold}_inches`);
                    const val = bjCfg[threshold];
                    if (val) {
                        // Handle both old format (just a number) and new format ({ feet, inches })
                        if (typeof val === 'object') {
                            if (feetInput) feetInput.value = val.feet || 0;
                            if (inchesInput) inchesInput.value = val.inches || 0;
                        } else {
                            // Legacy format - convert number to feet/inches
                            if (feetInput) feetInput.value = Math.floor(val);
                            if (inchesInput) inchesInput.value = Math.round((val - Math.floor(val)) * 12);
                        }
                    }
                });
            }

            // Populate bat speed
            const bsCfg = scoringConfig.batspeed;
            if (bsCfg) {
                ['t5', 't4', 't3', 't2', 't1'].forEach(threshold => {
                    const input = document.getElementById(`batspeed_${threshold}`);
                    if (input && bsCfg[threshold] !== undefined) {
                        input.value = bsCfg[threshold];
                    }
                });
            }
        }

        // ============================================
        // LOGIN FUNCTIONS
        // ============================================
        function checkLogin() {
            const user = document.getElementById('userSelect').value;
            const password = document.getElementById('passwordInput').value;

            if (!user || !VALID_USERS.includes(user)) {
                showLoginError();
                return;
            }

            if (password !== APP_PASSWORD) {
                showLoginError();
                return;
            }

            currentUser = user;
            sessionStorage.setItem('gcSoftballUser', user);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('currentUserDisplay').textContent = user.charAt(0).toUpperCase() + user.slice(1);

            initApp();
        }

        function showLoginError() {
            document.getElementById('loginError').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
        }

        function logout() {
            sessionStorage.removeItem('gcSoftballUser');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('userSelect').value = '';
        }

        function checkSession() {
            const savedUser = sessionStorage.getItem('gcSoftballUser');
            if (savedUser && VALID_USERS.includes(savedUser)) {
                currentUser = savedUser;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('currentUserDisplay').textContent = savedUser.charAt(0).toUpperCase() + savedUser.slice(1);
                initApp();
            }
        }

        // ============================================
        // APP INITIALIZATION
        // ============================================
        function initApp() {
            loadData();
            loadScoringConfig();
            autoDownloadFromSheets().then(() => {
                renderPlayerSelect();
                renderAllPlayers();
            });
        }

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    players = JSON.parse(saved);
                    migratePlayerData();
                }
            } catch (e) {
                console.error('Error loading data:', e);
                players = [];
            }
        }

        // Migrate old data formats to new format
        function migratePlayerData() {
            let needsSave = false;
            players.forEach(player => {
                // Migrate fielding to infield (rename)
                if (player.fielding && !player.infield) {
                    // Copy fielding data to infield
                    player.infield = player.fielding;
                    delete player.fielding;
                    needsSave = true;
                }
                // Migrate old infield format to new simple evaluation format
                if (player.infield) {
                    // If using old complex format (has groundballs, flyball, etc.), reset to new format
                    if (player.infield.groundballs !== undefined ||
                        player.infield.flyball !== undefined ||
                        player.infield.thirdToFirstGrounders !== undefined) {
                        player.infield = createInfieldData();
                        needsSave = true;
                    }
                    // Ensure evaluation object exists
                    if (!player.infield.evaluation) {
                        player.infield.evaluation = {};
                        needsSave = true;
                    }
                }
                // Initialize outfield if missing
                if (!player.outfield) {
                    player.outfield = createOutfieldData();
                    needsSave = true;
                }
                // Initialize hitting if missing
                if (!player.hitting) {
                    player.hitting = createHittingData();
                    needsSave = true;
                }
                // Migrate old catching format to new simple evaluation format
                if (player.catching) {
                    // If using old complex format (has throwaccuracy, blocking, etc.), reset to new format
                    if (player.catching.throwaccuracy !== undefined ||
                        player.catching.blocking !== undefined ||
                        player.catching.footwork !== undefined ||
                        player.catching.mobility !== undefined ||
                        player.catching.explosiveness_throwing !== undefined ||
                        player.catching.explosiveness_bunts !== undefined) {
                        // Keep poptime, reset everything else
                        const oldPoptime = player.catching.poptime;
                        const oldNotes = player.catching.notes;
                        player.catching = createCatchingData();
                        player.catching.poptime = oldPoptime || [null, null];
                        player.catching.notes = oldNotes || [];
                        needsSave = true;
                    }
                    // Ensure evaluation object exists
                    if (!player.catching.evaluation) {
                        player.catching.evaluation = {};
                        needsSave = true;
                    }
                }
                // Migrate baserunning scrimmage to evaluation
                if (player.baserunning && player.baserunning.scrimmage && !player.baserunning.evaluation) {
                    player.baserunning.evaluation = player.baserunning.scrimmage;
                    delete player.baserunning.scrimmage;
                    needsSave = true;
                }
                // Migrate runningform to highmotor in baserunning evaluation
                if (player.baserunning && player.baserunning.evaluation) {
                    Object.keys(player.baserunning.evaluation).forEach(coachKey => {
                        const coachData = player.baserunning.evaluation[coachKey];
                        if (coachData && coachData.runningform !== undefined && coachData.highmotor === undefined) {
                            coachData.highmotor = coachData.runningform;
                            delete coachData.runningform;
                            needsSave = true;
                        }
                    });
                }
            });
            if (needsSave) {
                saveData();
                console.log('Migrated player data to new format');
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
                lastSaveTimestamp = Date.now();
                pendingChanges = true;  // Mark that we have unsaved changes
                showSaveStatus('‚úì Saved locally');
                scheduleAutoUpload();
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        function scheduleAutoUpload() {
            if (autoUploadTimer) clearTimeout(autoUploadTimer);
            autoUploadTimer = setTimeout(() => {
                autoUploadToSheets();
            }, AUTO_UPLOAD_DELAY);
        }

        // ============================================
        // PLAYER MANAGEMENT
        // ============================================
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const numberInput = document.getElementById('playerNumber');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a player name');
                return;
            }

            const newPlayer = {
                id: Date.now(),
                name: name,
                number: numberInput.value.trim(),
                catching: createCatchingData(),
                baserunning: createBaserunningData(),
                intangibles: createIntangiblesData(),
                notes: ''
            };

            players.push(newPlayer);
            saveData();
            renderPlayerSelect();
            renderAllPlayers();

            nameInput.value = '';
            numberInput.value = '';

            // Auto-select the new player
            selectedPlayerId = newPlayer.id;
            document.getElementById('playerSelect').value = newPlayer.id;
            renderScoringArea();
        }

        function createCatchingData() {
            return {
                poptime: [null, null],
                // Simple evaluation categories - coach-keyed scoring: { coachName: { category: score, ... }, ... }
                evaluation: {},  // 6 categories: setupStance, armStrength, blockingPopups, framing, footworkAgility, highMotor
                notes: []  // Array of { coach: string, text: string, timestamp: string }
            };
        }

        function createBaserunningData() {
            return {
                // Speed metrics
                h1b: { times: [null, null], missed1b: [false, false] },
                '2bh': { times: [null, null], missed3b: [false, false] },
                // Explosiveness
                proagility: [null, null],
                broadjump: [{ feet: null, inches: null }, { feet: null, inches: null }],
                // Your Evaluation scores (by coach)
                evaluation: {},
                notes: []  // Array of { coach: string, text: string, timestamp: string }
            };
        }

        function createIntangiblesData() {
            return {
                notes: []  // Array of { coach: string, text: string, timestamp: string }
            };
        }

        function createInfieldData() {
            return {
                // Simple evaluation categories - coach-keyed scoring: { coachName: { category: score, ... }, ... }
                evaluation: {},  // 6 categories: fieldingMechanics, armStrength, receivingMechanics, miFeed, agility, highMotor
                notes: []
            };
        }

        function createOutfieldData() {
            return {
                // Simple evaluation categories - coach-keyed scoring: { coachName: { category: score, ... }, ... }
                evaluation: {},  // 5 categories: fieldingMechanics, armStrength, rangeAgility, flyBallMechanics, highMotor
                notes: []
            };
        }

        function createThrowingData() {
            return {
                // Throwing Velocity (2 attempts in mph)
                velocity: [null, null],
                notes: []
            };
        }

        function createPitchingData() {
            return {
                // Evaluation categories - coach-keyed scoring
                evaluation: {},  // 2 categories: mechanics, athleticism
                // Number of pitches in arsenal
                numPitches: null,
                // Array of pitches: { type: string, speeds: [null, null], control: null }
                pitches: [],
                notes: []
            };
        }

        function createHittingData() {
            return {
                // Bat Speed (2 attempts in mph)
                batSpeed: [null, null],
                // Evaluation categories - coach-keyed scoring
                evaluation: {},  // 5 categories: balance, batPath, contact, timing, highMotor
                notes: []
            };
        }

        function deletePlayer(id) {
            if (!confirm('Are you sure you want to delete this player?')) return;
            players = players.filter(p => p.id !== id);
            if (selectedPlayerId === id) {
                selectedPlayerId = null;
                document.getElementById('playerSelect').value = '';
            }
            saveData();
            renderPlayerSelect();
            renderAllPlayers();
            renderScoringArea();
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function setPlayerSelectMode(mode) {
            playerSelectMode = mode;

            // Update button styles
            document.getElementById('selectMode-all').className = mode === 'all'
                ? 'px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-medium'
                : 'px-3 py-1 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300';
            document.getElementById('selectMode-groups').className = mode === 'groups'
                ? 'px-3 py-1 rounded-lg bg-blue-600 text-white text-sm font-medium'
                : 'px-3 py-1 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium hover:bg-gray-300';

            renderPlayerSelect();
        }

        function renderPlayerSelect() {
            const select = document.getElementById('playerSelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select a player --</option>';

            if (playerSelectMode === 'groups') {
                // Group mode: organize by groups A, B, C, Pitchers, Catchers, then Unassigned
                const groups = { 'A': [], 'B': [], 'C': [], 'Pitchers': [], 'Catchers': [], 'Unassigned': [] };

                players.forEach(p => {
                    const group = getPlayerGroup(p.name);
                    if (group) {
                        groups[group].push(p);
                    } else {
                        groups['Unassigned'].push(p);
                    }
                    // Also add to Pitchers/Catchers if applicable
                    if (isPlayerInGroup(p.name, 'Pitchers')) {
                        groups['Pitchers'].push(p);
                    }
                    if (isPlayerInGroup(p.name, 'Catchers')) {
                        groups['Catchers'].push(p);
                    }
                });

                // Sort players within each group
                Object.keys(groups).forEach(g => {
                    groups[g].sort((a, b) => a.name.localeCompare(b.name));
                });

                // Add optgroups
                ['A', 'B', 'C', 'Pitchers', 'Catchers', 'Unassigned'].forEach(groupName => {
                    if (groups[groupName].length > 0) {
                        const optgroup = document.createElement('optgroup');
                        if (groupName === 'Unassigned') {
                            optgroup.label = '‚Äî Unassigned ‚Äî';
                        } else if (groupName === 'Pitchers' || groupName === 'Catchers') {
                            optgroup.label = `‚öæ ${groupName}`;
                        } else {
                            optgroup.label = `Group ${groupName}`;
                        }

                        groups[groupName].forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.id;
                            opt.textContent = p.number ? `${p.name} (#${p.number})` : p.name;
                            optgroup.appendChild(opt);
                        });

                        select.appendChild(optgroup);
                    }
                });
            } else {
                // All mode: alphabetical list
                const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
                sortedPlayers.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.number ? `${p.name} (#${p.number})` : p.name;
                    select.appendChild(opt);
                });
            }

            if (currentValue) select.value = currentValue;
        }

        function selectPlayer(playerId) {
            selectedPlayerId = playerId ? parseInt(playerId) : null;
            renderScoringArea();
        }

        function selectCategory(category) {
            selectedCategory = category;

            // Update button styles
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500');
            });
            const activeBtn = document.getElementById(`cat-${category}`);
            if (activeBtn) {
                activeBtn.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
            }

            renderScoringArea();
        }

        function renderScoringArea() {
            const area = document.getElementById('scoringArea');

            if (!selectedPlayerId) {
                area.classList.add('hidden');
                return;
            }

            const player = players.find(p => p.id === selectedPlayerId);
            if (!player) {
                area.classList.add('hidden');
                return;
            }

            area.classList.remove('hidden');

            // Initialize player data structures if missing
            let needsSave = false;
            if (!player.catching) { player.catching = createCatchingData(); needsSave = true; }
            if (!player.baserunning) { player.baserunning = createBaserunningData(); needsSave = true; }
            if (!player.intangibles) { player.intangibles = {}; needsSave = true; }
            if (!player.infield) { player.infield = createInfieldData(); needsSave = true; }
            if (!player.outfield) { player.outfield = createOutfieldData(); needsSave = true; }
            if (!player.throwing) { player.throwing = createThrowingData(); needsSave = true; }
            if (!player.pitching) { player.pitching = createPitchingData(); needsSave = true; }
            if (!player.hitting) { player.hitting = createHittingData(); needsSave = true; }
            if (needsSave) saveData();

            switch (selectedCategory) {
                case 'catching':
                    area.innerHTML = renderCatchingSection(player);
                    break;
                case 'baserunning':
                    area.innerHTML = renderBaserunningSection(player);
                    break;
                case 'intangibles':
                    area.innerHTML = renderIntangiblesSection(player);
                    break;
                case 'infield':
                    area.innerHTML = renderInfieldSection(player);
                    break;
                case 'outfield':
                    area.innerHTML = renderOutfieldSection(player);
                    break;
                case 'throwing':
                    area.innerHTML = renderThrowingSection(player);
                    break;
                case 'pitching':
                    area.innerHTML = renderPitchingSection(player);
                    break;
                case 'hitting':
                    area.innerHTML = renderHittingSection(player);
                    break;
                default:
                    area.innerHTML = '<div class="bg-white rounded-lg shadow-lg p-6 text-center text-gray-500">This category is coming soon!</div>';
            }
        }

        // ============================================
        // CATCHING SECTION
        // ============================================
        function renderCatchingSection(player) {
            if (!player.catching) player.catching = createCatchingData();
            const c = player.catching;

            // Define the 6 evaluation categories
            const catchingCategories = [
                { id: 'setupStance', name: 'Setup/Stance' },
                { id: 'armStrength', name: 'Arm Strength/Accuracy' },
                { id: 'blockingPopups', name: 'Blocking/Popups' },
                { id: 'framing', name: 'Framing' },
                { id: 'footworkAgility', name: 'Footwork/Agility' },
                { id: 'highMotor', name: 'High Motor' }
            ];

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><img src="catcher.jpg" alt="Catcher" class="w-6 h-6 object-contain"> Catching - ${player.name}</h2>

                    <!-- Pop Time -->
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Pop Time (seconds)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            ${[0, 1].map(i => `
                                <div>
                                    <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                    <input type="number" step="0.01" value="${c.poptime[i] || ''}"
                                        onchange="updateCatching(${player.id}, 'poptime', ${i}, this.value)"
                                        class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 2.35">
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            Score: <span class="font-bold">${calculatePopTimeScore(c.poptime)}</span>/5
                            (Avg: ${getAverageTime(c.poptime) || 'N/A'}s)
                        </div>
                    </div>

                    <!-- Your Evaluation -->
                    <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                        <h3 class="font-semibold mb-3">üìã Your Evaluation</h3>
                        <p class="text-xs text-gray-500 mb-3">All coaches evaluate these - scores are averaged | 1=Poor, 2=Below Avg, 3=Average, 4=Above Avg, 5=Excellent</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${catchingCategories.map(cat => {
                                const evaluation = c.evaluation || {};
                                const coachScores = evaluation[currentUser] || {};
                                const value = coachScores[cat.id];
                                return `
                                    <div class="p-3 bg-white rounded-lg border">
                                        <label class="text-sm font-medium text-gray-700">${cat.name}</label>
                                        <div class="flex gap-1 mt-2">
                                            ${[1, 2, 3, 4, 5].map(v => `
                                                <button onclick="updateCatchingEvaluation(${player.id}, '${cat.id}', ${v})"
                                                    class="score-btn flex-1 py-1 rounded ${value == v ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-purple-100'}">
                                                    ${v}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Avg: ${calculateAverageScore(evaluation, cat.id).toFixed(1)} (${countCoachScores(evaluation, cat.id)} coaches)
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            Your Total: <strong>${calculateCatchingEvalTotal(c.evaluation, currentUser)}</strong>/30
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-green-100 rounded-lg">
                        <strong>Catching Total (Averaged):</strong> ${calculateCatchingTotal(player)}/35
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'catching')}
                </div>
            `;
        }

        function updateCatchingEvaluation(playerId, category, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.catching) player.catching = createCatchingData();
            if (!player.catching.evaluation || typeof player.catching.evaluation !== 'object') {
                player.catching.evaluation = {};
            }
            if (!player.catching.evaluation[currentUser]) {
                player.catching.evaluation[currentUser] = {};
            }
            player.catching.evaluation[currentUser][category] = value;
            saveData();
            renderScoringArea();
        }

        function calculateCatchingEvalTotal(evaluation, coach) {
            if (!evaluation || !evaluation[coach]) return 0;
            const coachScores = evaluation[coach];
            const categories = ['setupStance', 'armStrength', 'blockingPopups', 'framing', 'footworkAgility', 'highMotor'];
            let total = 0;
            categories.forEach(cat => {
                total += coachScores[cat] || 0;
            });
            return total;
        }

        function updateCatching(playerId, field, index, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.catching) player.catching = createCatchingData();

            const numVal = value === '' ? null : parseFloat(value);
            player.catching[field][index] = numVal;
            saveData();
            renderScoringArea();
        }

        function calculateCatchingDrillAverage(evaluation, categories) {
            if (!evaluation || typeof evaluation !== 'object') return 0;

            const coaches = Object.keys(evaluation);
            if (coaches.length === 0) return 0;

            let totalScore = 0;
            categories.forEach(cat => {
                let catTotal = 0;
                let catCount = 0;
                coaches.forEach(coach => {
                    if (evaluation[coach] && evaluation[coach][cat]) {
                        catTotal += evaluation[coach][cat];
                        catCount++;
                    }
                });
                if (catCount > 0) {
                    totalScore += catTotal / catCount;
                }
            });

            return Math.round(totalScore * 10) / 10;
        }

        // ============================================
        // BASERUNNING SECTION
        // ============================================
        function renderBaserunningSection(player) {
            if (!player.baserunning) player.baserunning = createBaserunningData();
            const b = player.baserunning;

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">üèÉ Baserunning - ${player.name}</h2>

                    <!-- Speed Metrics -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-blue-700">‚ö° Speed Metrics</h3>

                        <!-- H to 1B -->
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold mb-2">H ‚Üí 1B (2 attempts)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                ${[0, 1].map(i => `
                                    <div>
                                        <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                        <input type="number" step="0.01" value="${b.h1b.times[i] || ''}"
                                            onchange="updateSpeedTime(${player.id}, 'h1b', ${i}, this.value)"
                                            class="w-full px-3 py-2 border rounded-lg" placeholder="seconds">
                                        <label class="flex items-center gap-2 mt-1 text-sm">
                                            <input type="checkbox" ${b.h1b.missed1b[i] ? 'checked' : ''}
                                                onchange="updateSpeedCheckbox(${player.id}, 'h1b', 'missed1b', ${i}, this.checked)">
                                            Missed 1B (+0.5s)
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-2 text-sm">
                                Adjusted Avg: <strong>${getAdjustedAvgH1B(b.h1b)}s</strong> |
                                Score: <strong>${calculateSpeedScore('h1b', getAdjustedAvgH1B(b.h1b))}</strong>/5
                            </div>
                        </div>

                        <!-- 2B to Home -->
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold mb-2">2B ‚Üí Home (2 attempts)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                ${[0, 1].map(i => `
                                    <div>
                                        <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                        <input type="number" step="0.01" value="${b['2bh'].times[i] || ''}"
                                            onchange="updateSpeedTime(${player.id}, '2bh', ${i}, this.value)"
                                            class="w-full px-3 py-2 border rounded-lg" placeholder="seconds">
                                        <label class="flex items-center gap-2 mt-1 text-sm">
                                            <input type="checkbox" ${b['2bh'].missed3b[i] ? 'checked' : ''}
                                                onchange="updateSpeedCheckbox(${player.id}, '2bh', 'missed3b', ${i}, this.checked)">
                                            Missed 3B (+1s)
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-2 text-sm">
                                Adjusted Avg: <strong>${getAdjustedAvg2BH(b['2bh'])}s</strong> |
                                Score: <strong>${calculateSpeedScore('2bh', getAdjustedAvg2BH(b['2bh']))}</strong>/5
                            </div>
                        </div>

                    </div>

                    <!-- Explosiveness -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-orange-700">üí• Explosiveness</h3>

                        <!-- Pro Agility -->
                        <div class="mb-4 p-4 bg-orange-50 rounded-lg">
                            <h4 class="font-semibold mb-2">Pro Agility (2 attempts)</h4>
                            <p class="text-xs text-gray-500 mb-2">5: &lt;4.3s | 4: 4.3-4.6s | 3: 4.7-5.0s | 2: 5.1-5.5s | 1: &gt;5.5s</p>
                            <div class="grid grid-cols-2 gap-4">
                                ${[0, 1].map(i => `
                                    <div>
                                        <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                        <input type="number" step="0.01" value="${b.proagility[i] || ''}"
                                            onchange="updateExplosiveness(${player.id}, 'proagility', ${i}, this.value)"
                                            class="w-full px-3 py-2 border rounded-lg" placeholder="seconds">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-2 text-sm">
                                Avg: <strong>${getAverageTime(b.proagility) || 'N/A'}s</strong> |
                                Score: <strong>${calculateProAgilityScore(b.proagility)}</strong>/5
                            </div>
                        </div>

                        <!-- Broad Jump -->
                        <div class="mb-4 p-4 bg-orange-50 rounded-lg">
                            <h4 class="font-semibold mb-2">Broad Jump (2 attempts)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                ${[0, 1].map(i => {
                                    const jump = b.broadjump[i] || { feet: null, inches: null };
                                    return `
                                    <div>
                                        <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                        <div class="flex gap-2">
                                            <input type="number" min="0" max="15" value="${jump.feet || ''}"
                                                onchange="updateBroadJump(${player.id}, ${i}, 'feet', this.value)"
                                                class="w-1/2 px-3 py-2 border rounded-lg" placeholder="ft">
                                            <input type="number" min="0" max="11" value="${jump.inches || ''}"
                                                onchange="updateBroadJump(${player.id}, ${i}, 'inches', this.value)"
                                                class="w-1/2 px-3 py-2 border rounded-lg" placeholder="in">
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            <div class="mt-2 text-sm">
                                Avg: <strong>${getAverageBroadJump(b.broadjump) || 'N/A'}</strong> |
                                Score: <strong>${calculateBroadJumpScore(b.broadjump)}</strong>/5
                            </div>
                        </div>
                    </div>

                    <!-- Your Evaluation -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-green-700">üìã Your Evaluation</h3>
                        <p class="text-sm text-gray-500 mb-3">All coaches evaluate these - scores are averaged</p>

                        ${renderBaserunningEvaluation(player)}
                    </div>

                    <div class="mt-4 p-3 bg-green-100 rounded-lg">
                        <strong>Baserunning Total:</strong> ${calculateBaserunningTotal(player)}/30
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'baserunning')}
                </div>
            `;
        }

        function renderBaserunningEvaluation(player) {
            const evaluation = player.baserunning?.evaluation || {};
            const myScores = evaluation[currentUser] || {};

            const drills = [
                { id: 'highmotor', name: 'High Motor', max: 5 },
                { id: 'intangibles', name: 'Intangibles', max: 5 }
            ];

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${drills.map(drill => `
                        <div class="p-3 bg-green-50 rounded-lg">
                            <h4 class="font-medium mb-2">${drill.name}</h4>
                            <div class="flex gap-2">
                                ${[1, 2, 3, 4, 5].map(v => `
                                    <button onclick="updateBaserunningEvaluation(${player.id}, '${drill.id}', ${v})"
                                        class="score-btn flex-1 py-2 rounded-lg ${myScores[drill.id] == v ? 'bg-green-600 text-white' : 'bg-white border hover:bg-green-100'}">
                                        ${v}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                Avg: ${calculateAverageScore(evaluation, drill.id).toFixed(1)} (${countCoachScores(evaluation, drill.id)} coaches)
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // INTANGIBLES SECTION
        // ============================================
        function renderIntangiblesSection(player) {
            if (!player.intangibles) player.intangibles = {};
            const intangibles = player.intangibles;
            const myScores = intangibles[currentUser] || {};

            const drills = [
                { id: 'awareness', name: 'Game Situation Awareness', description: 'Knows what to do on the basepath for various situations', max: 5 },
                { id: 'leadership', name: 'Leadership', description: 'Does the right things at the right time, keeps teammates on task, works hard during practice', max: 5 },
                { id: 'enthusiasm', name: 'Enthusiasm', description: 'Cheers for teammates, calls out where to throw the ball, moves quickly from drill to drill', max: 5 }
            ];

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">‚≠ê Intangibles - ${player.name}</h2>
                    <p class="text-sm text-gray-500 mb-4">All coaches evaluate these - scores are averaged</p>

                    <div class="space-y-4">
                        ${drills.map(drill => `
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h3 class="font-semibold mb-1">${drill.name}</h3>
                                <p class="text-xs text-gray-500 mb-3">${drill.description}</p>
                                <div class="flex gap-2">
                                    ${[1, 2, 3, 4, 5].map(v => `
                                        <button onclick="updateIntangibleScore(${player.id}, '${drill.id}', ${v})"
                                            class="score-btn flex-1 py-3 rounded-lg text-lg font-semibold ${myScores[drill.id] == v ? 'bg-yellow-500 text-white' : 'bg-white border hover:bg-yellow-100'}">
                                            ${v}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="text-sm text-gray-600 mt-2">
                                    Your score: <strong>${myScores[drill.id] || 'Not set'}</strong> |
                                    Average: <strong>${calculateAverageScore(intangibles, drill.id).toFixed(1)}</strong>
                                    (${countCoachScores(intangibles, drill.id)} coaches)
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-4 p-3 bg-green-100 rounded-lg">
                        <strong>Intangibles Average Total:</strong> ${calculateIntangiblesTotal(player).toFixed(1)}/15
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'intangibles')}
                </div>
            `;
        }

        // ============================================
        // INFIELD SECTION
        // ============================================
        function renderInfieldSection(player) {
            if (!player.infield) player.infield = createInfieldData();
            const f = player.infield;

            const infieldCategories = [
                { id: 'fieldingMechanics', name: 'Fielding Mechanics' },
                { id: 'armStrength', name: 'Arm Strength/Accuracy' },
                { id: 'receivingMechanics', name: 'Receiving Mechanics' },
                { id: 'miFeed', name: 'MI Feed Mechanics/Accuracy' },
                { id: 'agility', name: 'Agility/Explosiveness' },
                { id: 'highMotor', name: 'High Motor' }
            ];

            // Handle migration from old format
            let evalData = f.evaluation || {};
            if (typeof evalData !== 'object' || Array.isArray(evalData)) evalData = {};
            const myScores = evalData[currentUser] || {};

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <img src="fielding.jpg" alt="Infield" class="w-6 h-6 object-contain"> Infield - ${player.name}
                    </h2>

                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">üìã Your Evaluation</h3>
                        <p class="text-sm text-gray-500 mb-3">All coaches evaluate these - scores are averaged</p>
                    </div>

                    <div class="p-4 bg-green-50 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${infieldCategories.map(cat => `
                                <div class="p-3 bg-white rounded border">
                                    <label class="text-sm font-medium text-gray-700 block mb-2">${cat.name}</label>
                                    <div class="flex gap-1 mb-2">
                                        ${[1, 2, 3, 4, 5].map(v => `
                                            <button onclick="updateInfieldEvaluation(${player.id}, '${cat.id}', ${v})"
                                                class="flex-1 py-2 text-sm rounded font-medium ${myScores[cat.id] == v ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-green-100'}">
                                                ${v}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Avg: ${calculateAverageScore(evalData, cat.id).toFixed(1)} (${countCoachScores(evalData, cat.id)} coaches)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-green-100 rounded-lg">
                        <strong>Infield Total:</strong> ${calculateInfieldTotal(player).toFixed(1)}/30
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'infield')}
                </div>
            `;
        }

        // Update infield evaluation score
        function updateInfieldEvaluation(playerId, category, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.infield) player.infield = createInfieldData();
            if (!player.infield.evaluation || typeof player.infield.evaluation !== 'object') {
                player.infield.evaluation = {};
            }
            if (!player.infield.evaluation[currentUser]) {
                player.infield.evaluation[currentUser] = {};
            }
            player.infield.evaluation[currentUser][category] = value;
            saveData();
            renderScoringArea();
        }

        // ============================================
        // OUTFIELD SECTION
        // ============================================
        function renderOutfieldSection(player) {
            if (!player.outfield) player.outfield = createOutfieldData();
            const o = player.outfield;

            const outfieldCategories = [
                { id: 'fieldingMechanics', name: 'Fielding Mechanics' },
                { id: 'armStrength', name: 'Arm Strength/Accuracy' },
                { id: 'rangeAgility', name: 'Range/Agility' },
                { id: 'flyBallMechanics', name: 'Fly Ball Pos/Trans' },
                { id: 'highMotor', name: 'High Motor' }
            ];

            // Handle migration from old format
            let evalData = o.evaluation || {};
            if (typeof evalData !== 'object' || Array.isArray(evalData)) evalData = {};
            const myScores = evalData[currentUser] || {};

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <img src="fielding.jpg" alt="Outfield" class="w-6 h-6 object-contain"> Outfield - ${player.name}
                    </h2>

                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">üìã Your Evaluation</h3>
                        <p class="text-sm text-gray-500 mb-3">All coaches evaluate these - scores are averaged</p>
                    </div>

                    <div class="p-4 bg-teal-50 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${outfieldCategories.map(cat => `
                                <div class="p-3 bg-white rounded border">
                                    <label class="text-sm font-medium text-gray-700 block mb-2">${cat.name}</label>
                                    <div class="flex gap-1 mb-2">
                                        ${[1, 2, 3, 4, 5].map(v => `
                                            <button onclick="updateOutfieldEvaluation(${player.id}, '${cat.id}', ${v})"
                                                class="flex-1 py-2 text-sm rounded font-medium ${myScores[cat.id] == v ? 'bg-teal-600 text-white' : 'bg-gray-100 hover:bg-teal-100'}">
                                                ${v}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Avg: ${calculateAverageScore(evalData, cat.id).toFixed(1)} (${countCoachScores(evalData, cat.id)} coaches)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-teal-100 rounded-lg">
                        <strong>Outfield Total:</strong> ${calculateOutfieldTotal(player).toFixed(1)}/25
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'outfield')}
                </div>
            `;
        }

        // Update outfield evaluation score
        function updateOutfieldEvaluation(playerId, category, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.outfield) player.outfield = createOutfieldData();
            if (!player.outfield.evaluation || typeof player.outfield.evaluation !== 'object') {
                player.outfield.evaluation = {};
            }
            if (!player.outfield.evaluation[currentUser]) {
                player.outfield.evaluation[currentUser] = {};
            }
            player.outfield.evaluation[currentUser][category] = value;
            saveData();
            renderScoringArea();
        }

        // ============================================
        // THROWING SECTION
        // ============================================
        function renderThrowingSection(player) {
            if (!player.throwing) player.throwing = createThrowingData();
            const t = player.throwing;

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <img src="softball fielding.JPG" alt="Throwing" class="w-6 h-6 object-contain"> Throwing - ${player.name}
                    </h2>

                    <!-- Throwing Velocity (2 attempts) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-red-700">Throwing Velocity (2 attempts)</h3>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-2">5: 63+ | 4: 59-62 | 3: 53-58 | 2: 48-52 | 1: Under 48</p>
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                ${[0, 1].map(i => `
                                    <div>
                                        <label class="text-sm text-gray-600">Attempt ${i + 1} (mph)</label>
                                        <input type="number" step="1" value="${t.velocity?.[i] || ''}"
                                            onchange="updateThrowingVelocity(${player.id}, ${i}, this.value)"
                                            class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 55">
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="text-sm">
                                    Avg: <strong>${getAverageVelocity(t.velocity) || 'N/A'}</strong> mph
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-600">Score</div>
                                    <div class="text-2xl font-bold text-red-600">${calculateVelocityScore(getAverageVelocity(t.velocity))}/5</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-red-100 rounded-lg">
                        <strong>Throwing Total:</strong> ${calculateThrowingTotal(player).toFixed(1)}/5
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'throwing')}
                </div>
            `;
        }

        // ============================================
        // PITCHING SECTION
        // ============================================
        function renderPitchingSection(player) {
            if (!player.pitching) player.pitching = createPitchingData();
            const p = player.pitching;

            const pitchingCategories = [
                { id: 'mechanics', name: 'Pitching Mechanics' },
                { id: 'athleticism', name: 'Athleticism' }
            ];

            const pitchTypes = ['Fastball', 'Curveball', 'Drop', 'Rise', 'Changeup', 'Screw', 'Other'];

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <img src="pitching.jpg" alt="Pitching" class="w-6 h-6 object-contain"> Pitching - ${player.name}
                    </h2>

                    <!-- Your Evaluation -->
                    <div class="mb-6 p-4 bg-pink-50 rounded-lg">
                        <h3 class="font-semibold mb-3">üìã Your Evaluation</h3>
                        <p class="text-xs text-gray-500 mb-3">All coaches evaluate these - scores are averaged | 1=Poor, 2=Below Avg, 3=Average, 4=Above Avg, 5=Excellent</p>
                        <div class="grid grid-cols-2 gap-4">
                            ${pitchingCategories.map(cat => {
                                const evaluation = p.evaluation || {};
                                const coachScores = evaluation[currentUser] || {};
                                const value = coachScores[cat.id];
                                return `
                                    <div class="p-3 bg-white rounded-lg border">
                                        <label class="text-sm font-medium text-gray-700">${cat.name}</label>
                                        <div class="flex gap-1 mt-2">
                                            ${[1, 2, 3, 4, 5].map(v => `
                                                <button onclick="updatePitchingEvaluation(${player.id}, '${cat.id}', ${v})"
                                                    class="score-btn flex-1 py-1 rounded ${value == v ? 'bg-pink-600 text-white' : 'bg-gray-100 hover:bg-pink-100'}">
                                                    ${v}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            Avg: ${calculateAverageScore(evaluation, cat.id).toFixed(1)} (${countCoachScores(evaluation, cat.id)} coaches)
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Number of Pitches -->
                    <div class="mb-6 p-4 bg-pink-50 rounded-lg">
                        <div class="flex items-center gap-4 mb-4">
                            <label class="font-semibold"># of Pitches:</label>
                            <input type="number" min="0" max="10" value="${p.numPitches || ''}"
                                onchange="updatePitchingNumPitches(${player.id}, this.value)"
                                class="w-20 px-3 py-2 border rounded-lg text-center" placeholder="0">
                        </div>

                        <!-- Add Pitch -->
                        <div class="flex items-center gap-2 mb-4">
                            <select id="pitchTypeSelect-${player.id}" class="px-3 py-2 border rounded-lg">
                                <option value="">Select pitch type...</option>
                                ${pitchTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                            <button onclick="addPitch(${player.id})"
                                class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">
                                + Add Pitch
                            </button>
                        </div>

                        <!-- Pitches List -->
                        <div class="space-y-3">
                            ${(p.pitches || []).map((pitch, idx) => `
                                <div class="p-3 bg-white rounded-lg border">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-semibold text-pink-700">${pitch.type}</span>
                                        <button onclick="removePitch(${player.id}, ${idx})"
                                            class="text-red-500 hover:text-red-700 text-sm">‚úï Remove</button>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label class="text-xs text-gray-500">Speed 1 (mph)</label>
                                            <input type="number" step="1" value="${pitch.speeds?.[0] || ''}"
                                                onchange="updatePitchSpeed(${player.id}, ${idx}, 0, this.value)"
                                                class="w-full px-2 py-1 border rounded text-center" placeholder="mph">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Speed 2 (mph)</label>
                                            <input type="number" step="1" value="${pitch.speeds?.[1] || ''}"
                                                onchange="updatePitchSpeed(${player.id}, ${idx}, 1, this.value)"
                                                class="w-full px-2 py-1 border rounded text-center" placeholder="mph">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Control (1-5)</label>
                                            <div class="flex gap-1">
                                                ${[1, 2, 3, 4, 5].map(v => `
                                                    <button onclick="updatePitchControl(${player.id}, ${idx}, ${v})"
                                                        class="flex-1 py-1 rounded text-xs ${pitch.control == v ? 'bg-pink-600 text-white' : 'bg-gray-100 hover:bg-pink-100'}">
                                                        ${v}
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${(p.pitches || []).length === 0 ? '<p class="text-gray-500 text-sm italic">No pitches added yet</p>' : ''}
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-green-100 rounded-lg">
                        <strong>Pitching Total:</strong> ${calculatePitchingTotal(player).toFixed(1)} points
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'pitching')}
                </div>
            `;
        }

        function updatePitchingEvaluation(playerId, category, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.pitching) player.pitching = createPitchingData();
            if (!player.pitching.evaluation) player.pitching.evaluation = {};
            if (!player.pitching.evaluation[currentUser]) player.pitching.evaluation[currentUser] = {};
            player.pitching.evaluation[currentUser][category] = value;
            saveData();
            renderScoringArea();
        }

        function updatePitchingNumPitches(playerId, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.pitching) player.pitching = createPitchingData();
            player.pitching.numPitches = value === '' ? null : parseInt(value);
            saveData();
            renderScoringArea();
        }

        function addPitch(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.pitching) player.pitching = createPitchingData();
            if (!player.pitching.pitches) player.pitching.pitches = [];

            const select = document.getElementById(`pitchTypeSelect-${playerId}`);
            const pitchType = select.value;
            if (!pitchType) {
                alert('Please select a pitch type');
                return;
            }

            player.pitching.pitches.push({
                type: pitchType,
                speeds: [null, null],
                control: null
            });
            select.value = '';
            saveData();
            renderScoringArea();
        }

        function removePitch(playerId, pitchIdx) {
            const player = players.find(p => p.id === playerId);
            if (!player || !player.pitching || !player.pitching.pitches) return;
            player.pitching.pitches.splice(pitchIdx, 1);
            saveData();
            renderScoringArea();
        }

        function updatePitchSpeed(playerId, pitchIdx, attemptIdx, value) {
            const player = players.find(p => p.id === playerId);
            if (!player || !player.pitching || !player.pitching.pitches) return;
            if (!player.pitching.pitches[pitchIdx]) return;
            if (!player.pitching.pitches[pitchIdx].speeds) player.pitching.pitches[pitchIdx].speeds = [null, null];
            player.pitching.pitches[pitchIdx].speeds[attemptIdx] = value === '' ? null : parseInt(value);
            saveData();
            renderScoringArea();
        }

        function updatePitchControl(playerId, pitchIdx, value) {
            const player = players.find(p => p.id === playerId);
            if (!player || !player.pitching || !player.pitching.pitches) return;
            if (!player.pitching.pitches[pitchIdx]) return;
            player.pitching.pitches[pitchIdx].control = value;
            saveData();
            renderScoringArea();
        }

        function calculatePitchingTotal(player) {
            const p = player.pitching || {};
            let total = 0;

            // Evaluation categories (10 points max averaged across coaches)
            const categories = ['mechanics', 'athleticism'];
            if (p.evaluation) {
                const coaches = Object.keys(p.evaluation);
                if (coaches.length > 0) {
                    categories.forEach(cat => {
                        let catTotal = 0;
                        let catCount = 0;
                        coaches.forEach(coach => {
                            if (p.evaluation[coach] && p.evaluation[coach][cat]) {
                                catTotal += p.evaluation[coach][cat];
                                catCount++;
                            }
                        });
                        if (catCount > 0) total += catTotal / catCount;
                    });
                }
            }

            // Add pitch control scores (averaged)
            if (p.pitches && p.pitches.length > 0) {
                let controlTotal = 0;
                let controlCount = 0;
                p.pitches.forEach(pitch => {
                    if (pitch.control) {
                        controlTotal += pitch.control;
                        controlCount++;
                    }
                });
                if (controlCount > 0) {
                    total += controlTotal / controlCount;  // Average control score
                }
            }

            return Math.round(total * 10) / 10;
        }

        // ============================================
        // HITTING SECTION
        // ============================================
        function renderHittingSection(player) {
            if (!player.hitting) player.hitting = createHittingData();
            const h = player.hitting;

            const hittingCategories = [
                { id: 'balance', name: 'Balance' },
                { id: 'batPath', name: 'Bat Path' },
                { id: 'contact', name: 'Contact' },
                { id: 'timing', name: 'Timing' },
                { id: 'highMotor', name: 'High Motor' }
            ];

            // Handle migration from old format
            let evalData = h.evaluation || {};
            if (typeof evalData !== 'object' || Array.isArray(evalData)) evalData = {};
            const myScores = evalData[currentUser] || {};

            return `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <img src="hitting.jpg" alt="Hitting" class="w-6 h-6 object-contain"> Hitting - ${player.name}
                    </h2>

                    <!-- Bat Speed -->
                    <div class="mb-6 p-4 bg-orange-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Bat Speed (mph)</h3>
                        <p class="text-xs text-gray-500 mb-2">5: 70+ | 4: 63-69 | 3: 55-62 | 2: 48-54 | 1: Under 48</p>
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            ${[0, 1].map(i => `
                                <div>
                                    <label class="text-sm text-gray-600">Attempt ${i + 1}</label>
                                    <input type="number" step="1" value="${h.batSpeed?.[i] || ''}"
                                        onchange="updateBatSpeed(${player.id}, ${i}, this.value)"
                                        class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., 65">
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-sm">
                                Avg: <strong>${getAverageBatSpeed(h.batSpeed) || 'N/A'}</strong> mph
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Score</div>
                                <div class="text-2xl font-bold text-orange-600">${calculateBatSpeedScore(h.batSpeed)}/5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Evaluation -->
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">üìã Your Evaluation</h3>
                        <p class="text-sm text-gray-500 mb-3">All coaches evaluate these - scores are averaged</p>
                    </div>

                    <div class="p-4 bg-orange-50 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${hittingCategories.map(cat => `
                                <div class="p-3 bg-white rounded border">
                                    <label class="text-sm font-medium text-gray-700 block mb-2">${cat.name}</label>
                                    <div class="flex gap-1 mb-2">
                                        ${[1, 2, 3, 4, 5].map(v => `
                                            <button onclick="updateHittingEvaluation(${player.id}, '${cat.id}', ${v})"
                                                class="flex-1 py-2 text-sm rounded font-medium ${myScores[cat.id] == v ? 'bg-orange-600 text-white' : 'bg-gray-100 hover:bg-orange-100'}">
                                                ${v}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Avg: ${calculateAverageScore(evalData, cat.id).toFixed(1)} (${countCoachScores(evalData, cat.id)} coaches)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-orange-100 rounded-lg">
                        <strong>Hitting Total:</strong> ${calculateHittingTotal(player).toFixed(1)}/30
                    </div>

                    <!-- Notes Section -->
                    ${renderNotesSection(player, 'hitting')}
                </div>
            `;
        }

        // Update bat speed
        function updateBatSpeed(playerId, index, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.hitting) player.hitting = createHittingData();
            if (!player.hitting.batSpeed) player.hitting.batSpeed = [null, null];
            player.hitting.batSpeed[index] = value === '' ? null : parseInt(value);
            saveData();
            renderScoringArea();
        }

        // Update hitting evaluation score
        function updateHittingEvaluation(playerId, category, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.hitting) player.hitting = createHittingData();
            if (!player.hitting.evaluation || typeof player.hitting.evaluation !== 'object') {
                player.hitting.evaluation = {};
            }
            if (!player.hitting.evaluation[currentUser]) {
                player.hitting.evaluation[currentUser] = {};
            }
            player.hitting.evaluation[currentUser][category] = value;
            saveData();
            renderScoringArea();
        }

        // Get average bat speed
        function getAverageBatSpeed(batSpeed) {
            if (!batSpeed) return null;
            const valid = batSpeed.filter(v => v !== null && v !== undefined);
            if (valid.length === 0) return null;
            const avg = valid.reduce((a, b) => a + b, 0) / valid.length;
            return Math.round(avg);
        }

        // Calculate bat speed score based on average
        function calculateBatSpeedScore(batSpeed) {
            const avg = getAverageBatSpeed(batSpeed);
            if (avg === null) return 0;
            const cfg = scoringConfig.batspeed || { t5: 70, t4: 63, t3: 55, t2: 48, t1: 48 };
            if (avg >= cfg.t5) return 5;
            if (avg >= cfg.t4) return 4;
            if (avg >= cfg.t3) return 3;
            if (avg >= cfg.t2) return 2;
            return 1;
        }

        // Calculate hitting total
        function calculateHittingTotal(player) {
            const h = player.hitting || {};
            let total = 0;

            // Bat speed score (5 max)
            total += calculateBatSpeedScore(h.batSpeed);

            // Evaluation categories (25 max - 5 categories √ó 5)
            const hittingCategories = ['balance', 'batPath', 'contact', 'timing', 'highMotor'];
            total += calculateFieldingDrillAverage(h.evaluation || {}, hittingCategories);

            return Math.round(total * 10) / 10;
        }

        // ============================================
        // NOTES SECTION
        // ============================================
        function renderNotesSection(player, category) {
            let notes = [];
            if (category === 'catching' && player.catching) {
                notes = player.catching.notes || [];
            } else if (category === 'baserunning' && player.baserunning) {
                notes = player.baserunning.notes || [];
            } else if (category === 'intangibles') {
                notes = player.intangibles?.notes || [];
            } else if (category === 'infield' && player.infield) {
                notes = player.infield.notes || [];
            } else if (category === 'outfield' && player.outfield) {
                notes = player.outfield.notes || [];
            } else if (category === 'throwing' && player.throwing) {
                notes = player.throwing.notes || [];
            } else if (category === 'pitching' && player.pitching) {
                notes = player.pitching.notes || [];
            } else if (category === 'hitting' && player.hitting) {
                notes = player.hitting.notes || [];
            }

            const categoryColors = {
                catching: 'purple',
                baserunning: 'blue',
                intangibles: 'yellow',
                infield: 'green',
                outfield: 'teal',
                throwing: 'red',
                pitching: 'pink',
                hitting: 'orange'
            };
            const color = categoryColors[category] || 'gray';

            return `
                <div class="mt-6 p-4 bg-${color}-50 rounded-lg border border-${color}-200">
                    <h3 class="font-semibold mb-3 flex items-center gap-2">
                        üìù Coach Notes
                    </h3>

                    <!-- Existing Notes -->
                    <div class="space-y-2 mb-4 max-h-48 overflow-y-auto">
                        ${notes.length === 0 ?
                            '<p class="text-gray-500 text-sm italic">No notes yet</p>' :
                            notes.map((note, idx) => `
                                <div class="bg-white p-3 rounded-lg border text-sm">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <span class="font-medium text-${color}-700">${note.coach}:</span>
                                            <span class="text-gray-700">${note.text}</span>
                                        </div>
                                        ${note.coach === currentUser ? `
                                            <button onclick="deleteNote(${player.id}, '${category}', ${idx})"
                                                class="text-red-500 hover:text-red-700 ml-2 text-xs">‚úï</button>
                                        ` : ''}
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">${note.timestamp}</div>
                                </div>
                            `).join('')
                        }
                    </div>

                    <!-- Add Note Form -->
                    <div class="flex gap-2">
                        <input type="text" id="note-${category}-${player.id}"
                            placeholder="Add a note..."
                            class="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-${color}-500"
                            onkeypress="if(event.key==='Enter') addNote(${player.id}, '${category}')">
                        <button onclick="addNote(${player.id}, '${category}')"
                            class="px-4 py-2 bg-${color}-600 text-white rounded-lg hover:bg-${color}-700 text-sm">
                            Add Note
                        </button>
                    </div>
                </div>
            `;
        }

        function addNote(playerId, category) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const input = document.getElementById(`note-${category}-${playerId}`);
            const text = input.value.trim();
            if (!text) return;

            const note = {
                coach: currentUser,
                text: text,
                timestamp: new Date().toLocaleString()
            };

            // Initialize data structures if needed
            if (category === 'catching') {
                if (!player.catching) player.catching = createCatchingData();
                if (!player.catching.notes) player.catching.notes = [];
                player.catching.notes.push(note);
            } else if (category === 'baserunning') {
                if (!player.baserunning) player.baserunning = createBaserunningData();
                if (!player.baserunning.notes) player.baserunning.notes = [];
                player.baserunning.notes.push(note);
            } else if (category === 'intangibles') {
                if (!player.intangibles) player.intangibles = createIntangiblesData();
                if (!player.intangibles.notes) player.intangibles.notes = [];
                player.intangibles.notes.push(note);
            } else if (category === 'infield') {
                if (!player.infield) player.infield = createInfieldData();
                if (!player.infield.notes) player.infield.notes = [];
                player.infield.notes.push(note);
            } else if (category === 'outfield') {
                if (!player.outfield) player.outfield = createOutfieldData();
                if (!player.outfield.notes) player.outfield.notes = [];
                player.outfield.notes.push(note);
            } else if (category === 'throwing') {
                if (!player.throwing) player.throwing = createThrowingData();
                if (!player.throwing.notes) player.throwing.notes = [];
                player.throwing.notes.push(note);
            } else if (category === 'pitching') {
                if (!player.pitching) player.pitching = createPitchingData();
                if (!player.pitching.notes) player.pitching.notes = [];
                player.pitching.notes.push(note);
            } else if (category === 'hitting') {
                if (!player.hitting) player.hitting = createHittingData();
                if (!player.hitting.notes) player.hitting.notes = [];
                player.hitting.notes.push(note);
            }

            input.value = '';
            saveData();
            renderScoringArea();
        }

        function deleteNote(playerId, category, noteIndex) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            let notes;
            if (category === 'catching' && player.catching) {
                notes = player.catching.notes;
            } else if (category === 'baserunning' && player.baserunning) {
                notes = player.baserunning.notes;
            } else if (category === 'intangibles' && player.intangibles) {
                notes = player.intangibles.notes;
            } else if (category === 'infield' && player.infield) {
                notes = player.infield.notes;
            } else if (category === 'outfield' && player.outfield) {
                notes = player.outfield.notes;
            } else if (category === 'throwing' && player.throwing) {
                notes = player.throwing.notes;
            } else if (category === 'pitching' && player.pitching) {
                notes = player.pitching.notes;
            } else if (category === 'hitting' && player.hitting) {
                notes = player.hitting.notes;
            }

            if (notes && notes[noteIndex] && notes[noteIndex].coach === currentUser) {
                notes.splice(noteIndex, 1);
                saveData();
                renderScoringArea();
            }
        }

        // ============================================
        // UPDATE FUNCTIONS
        // ============================================
        function updateSpeedTime(playerId, drill, index, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.baserunning) player.baserunning = createBaserunningData();

            player.baserunning[drill].times[index] = value === '' ? null : parseFloat(value);
            saveData();
            renderScoringArea();
        }

        function updateSpeedCheckbox(playerId, drill, field, index, checked) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.baserunning) player.baserunning = createBaserunningData();

            player.baserunning[drill][field][index] = checked;
            saveData();
            renderScoringArea();
        }

        function updateExplosiveness(playerId, drill, index, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.baserunning) player.baserunning = createBaserunningData();

            player.baserunning[drill][index] = value === '' ? null : parseFloat(value);
            saveData();
            renderScoringArea();
        }

        function updateBroadJump(playerId, index, field, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.baserunning) player.baserunning = createBaserunningData();

            // Ensure broadjump array has proper structure
            if (!player.baserunning.broadjump || !Array.isArray(player.baserunning.broadjump)) {
                player.baserunning.broadjump = [{ feet: null, inches: null }, { feet: null, inches: null }];
            }
            if (!player.baserunning.broadjump[index] || typeof player.baserunning.broadjump[index] !== 'object') {
                player.baserunning.broadjump[index] = { feet: null, inches: null };
            }

            player.baserunning.broadjump[index][field] = value === '' ? null : parseInt(value);
            saveData();
            renderScoringArea();
        }

        function updateBaserunningEvaluation(playerId, drillId, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.baserunning) player.baserunning = createBaserunningData();
            if (!player.baserunning.evaluation) player.baserunning.evaluation = {};
            if (!player.baserunning.evaluation[currentUser]) player.baserunning.evaluation[currentUser] = {};

            player.baserunning.evaluation[currentUser][drillId] = value;
            saveData();
            renderScoringArea();
        }

        function updateIntangibleScore(playerId, drillId, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.intangibles) player.intangibles = {};
            if (!player.intangibles[currentUser]) player.intangibles[currentUser] = {};

            player.intangibles[currentUser][drillId] = value;
            saveData();
            renderScoringArea();
        }

        // ============================================
        // THROWING UPDATE FUNCTIONS
        // ============================================
        function updateThrowingVelocity(playerId, attemptIdx, value) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            if (!player.throwing) player.throwing = createThrowingData();
            if (!player.throwing.velocity || !Array.isArray(player.throwing.velocity)) {
                player.throwing.velocity = [null, null];
            }
            player.throwing.velocity[attemptIdx] = value === '' ? null : parseFloat(value);
            saveData();
            renderScoringArea();
        }

        function getAverageVelocity(velocities) {
            if (!velocities || !Array.isArray(velocities)) return null;
            const valid = velocities.filter(v => v !== null && !isNaN(v));
            if (valid.length === 0) return null;
            return Math.round(valid.reduce((sum, v) => sum + v, 0) / valid.length);
        }

        // ============================================
        // FIELDING & THROWING CALCULATION FUNCTIONS
        // ============================================
        // Calculate average across coaches for a fielding drill
        // drillData = { coach1: { cat1: score, cat2: score }, coach2: { ... } }
        // categories = ['footwork', 'technique', ...]
        function calculateFieldingDrillAverage(drillData, categories) {
            if (!drillData || typeof drillData !== 'object') return 0;
            let total = 0;
            for (const cat of categories) {
                total += calculateAverageScore(drillData, cat);
            }
            return total;
        }

        function calculateVelocityScore(velocity) {
            if (velocity === null || velocity === undefined || velocity === '') return 0;
            const v = parseFloat(velocity);
            if (isNaN(v)) return 0;
            if (v >= 63) return 5;
            if (v >= 59) return 4;
            if (v >= 53) return 3;
            if (v >= 48) return 2;
            return 1;
        }

        function calculateInfieldTotal(player) {
            const f = player.infield || {};
            const infieldCategories = ['fieldingMechanics', 'armStrength', 'receivingMechanics', 'miFeed', 'agility', 'highMotor'];

            // 6 categories √ó 5 max each = 30 max
            return calculateFieldingDrillAverage(f.evaluation || {}, infieldCategories);
        }

        function calculateOutfieldTotal(player) {
            const o = player.outfield || {};
            const outfieldCategories = ['fieldingMechanics', 'armStrength', 'rangeAgility', 'flyBallMechanics', 'highMotor'];

            // 5 categories √ó 5 max each = 25 max
            return calculateFieldingDrillAverage(o.evaluation || {}, outfieldCategories);
        }

        function calculateThrowingTotal(player) {
            const t = player.throwing || {};
            return calculateVelocityScore(getAverageVelocity(t.velocity));
        }

        // ============================================
        // CALCULATION FUNCTIONS
        // ============================================
        function getBestTime(times) {
            const valid = times.filter(t => t !== null && !isNaN(t));
            if (valid.length === 0) return null;
            return Math.min(...valid).toFixed(2);
        }

        function getAverageTime(times) {
            const valid = times.filter(t => t !== null && !isNaN(t));
            if (valid.length === 0) return null;
            const avg = valid.reduce((sum, t) => sum + t, 0) / valid.length;
            return avg.toFixed(2);
        }

        function getBestDistance(distances) {
            const valid = distances.filter(d => d !== null && !isNaN(d));
            if (valid.length === 0) return null;
            return Math.max(...valid).toFixed(1);
        }

        function getAdjustedBestH1B(data) {
            let best = null;
            for (let i = 0; i < 2; i++) {
                if (data.times[i] !== null) {
                    let adjusted = data.times[i] + (data.missed1b[i] ? 0.5 : 0);
                    if (best === null || adjusted < best) best = adjusted;
                }
            }
            return best ? best.toFixed(2) : 'N/A';
        }

        function getAdjustedAvgH1B(data) {
            const adjusted = [];
            for (let i = 0; i < 2; i++) {
                if (data.times[i] !== null) {
                    adjusted.push(data.times[i] + (data.missed1b[i] ? 0.5 : 0));
                }
            }
            if (adjusted.length === 0) return 'N/A';
            const avg = adjusted.reduce((sum, t) => sum + t, 0) / adjusted.length;
            return avg.toFixed(2);
        }

        function getAdjustedBest2BH(data) {
            let best = null;
            for (let i = 0; i < 2; i++) {
                if (data.times[i] !== null) {
                    let adjusted = data.times[i] + (data.missed3b[i] ? 1 : 0);
                    if (best === null || adjusted < best) best = adjusted;
                }
            }
            return best ? best.toFixed(2) : 'N/A';
        }

        function getAdjustedAvg2BH(data) {
            const adjusted = [];
            for (let i = 0; i < 2; i++) {
                if (data.times[i] !== null) {
                    adjusted.push(data.times[i] + (data.missed3b[i] ? 1 : 0));
                }
            }
            if (adjusted.length === 0) return 'N/A';
            const avg = adjusted.reduce((sum, t) => sum + t, 0) / adjusted.length;
            return avg.toFixed(2);
        }

        function calculateSpeedScore(drill, time) {
            if (time === 'N/A' || time === null) return 0;
            const t = parseFloat(time);
            const config = scoringConfig[drill];
            if (!config) return 0;

            // For time-based drills, lower is better
            // Using <= so hitting the threshold exactly gives the higher score
            if (t <= config.t5) return 5;
            if (t <= config.t4) return 4;
            if (t <= config.t3) return 3;
            if (t <= config.t2) return 2;
            return 1;
        }

        function calculatePopTimeScore(times) {
            const avg = getAverageTime(times);
            if (!avg) return 0;
            return calculateSpeedScore('poptime', avg);
        }

        function calculateProAgilityScore(times) {
            const avg = getAverageTime(times);
            if (!avg) return 0;
            const t = parseFloat(avg);
            const cfg = scoringConfig.proagility;
            // Using <= so hitting the threshold exactly gives the higher score
            if (t <= cfg.t5) return 5;
            if (t <= cfg.t4) return 4;
            if (t <= cfg.t3) return 3;
            if (t <= cfg.t2) return 2;
            return 1;
        }

        function getBestBroadJump(jumps) {
            if (!jumps || !Array.isArray(jumps)) return null;
            let bestTotal = null;
            let bestFeet = null;
            let bestInches = null;

            jumps.forEach(jump => {
                if (jump && typeof jump === 'object' && jump.feet !== null) {
                    const totalInches = (jump.feet * 12) + (jump.inches || 0);
                    if (bestTotal === null || totalInches > bestTotal) {
                        bestTotal = totalInches;
                        bestFeet = jump.feet;
                        bestInches = jump.inches || 0;
                    }
                } else if (typeof jump === 'number') {
                    // Handle legacy format (just feet as decimal)
                    const totalInches = jump * 12;
                    if (bestTotal === null || totalInches > bestTotal) {
                        bestTotal = totalInches;
                        bestFeet = Math.floor(jump);
                        bestInches = Math.round((jump - Math.floor(jump)) * 12);
                    }
                }
            });

            if (bestTotal === null) return null;
            return `${bestFeet}' ${bestInches}"`;
        }

        function getBroadJumpInFeet(jumps) {
            if (!jumps || !Array.isArray(jumps)) return null;
            let best = null;

            jumps.forEach(jump => {
                if (jump && typeof jump === 'object' && jump.feet !== null) {
                    const totalFeet = jump.feet + ((jump.inches || 0) / 12);
                    if (best === null || totalFeet > best) {
                        best = totalFeet;
                    }
                } else if (typeof jump === 'number') {
                    // Handle legacy format
                    if (best === null || jump > best) {
                        best = jump;
                    }
                }
            });

            return best;
        }

        function getAverageBroadJumpInFeet(jumps) {
            if (!jumps || !Array.isArray(jumps)) return null;
            const valid = [];

            jumps.forEach(jump => {
                if (jump && typeof jump === 'object' && jump.feet !== null) {
                    valid.push(jump.feet + ((jump.inches || 0) / 12));
                } else if (typeof jump === 'number') {
                    valid.push(jump);
                }
            });

            if (valid.length === 0) return null;
            return valid.reduce((sum, v) => sum + v, 0) / valid.length;
        }

        function getAverageBroadJump(jumps) {
            const avgFeet = getAverageBroadJumpInFeet(jumps);
            if (avgFeet === null) return null;
            const feet = Math.floor(avgFeet);
            const inches = Math.round((avgFeet - feet) * 12);
            return `${feet}' ${inches}"`;
        }

        function calculateBroadJumpScore(jumps) {
            const avg = getAverageBroadJumpInFeet(jumps);
            if (!avg) return 0;
            const d = avg;
            const config = scoringConfig.broadjump;

            // Helper to convert threshold to feet (handles both old number format and new {feet, inches} format)
            const toFeet = (val) => {
                if (typeof val === 'object' && val !== null) {
                    return (val.feet || 0) + ((val.inches || 0) / 12);
                }
                return val || 0;
            };

            // For broad jump, higher is better
            // Using >= so hitting the threshold exactly gives the higher score
            if (d >= toFeet(config.t5)) return 5;
            if (d >= toFeet(config.t4)) return 4;
            if (d >= toFeet(config.t3)) return 3;
            if (d >= toFeet(config.t2)) return 2;
            return 1;
        }

        function sumScores(arr) {
            return arr.filter(v => v !== null && !isNaN(v)).reduce((sum, v) => sum + parseInt(v), 0);
        }

        function calculateAverageScore(coachScores, drillId) {
            if (!coachScores || typeof coachScores !== 'object') return 0;
            // Skip if it's an array (old format)
            if (Array.isArray(coachScores)) return 0;
            const scores = [];
            Object.values(coachScores).forEach(coach => {
                if (coach && typeof coach === 'object' && coach[drillId] !== undefined && coach[drillId] !== null) {
                    scores.push(coach[drillId]);
                }
            });
            if (scores.length === 0) return 0;
            return scores.reduce((sum, s) => sum + s, 0) / scores.length;
        }

        function countCoachScores(coachScores, drillId) {
            if (!coachScores || typeof coachScores !== 'object') return 0;
            // Skip if it's an array (old format)
            if (Array.isArray(coachScores)) return 0;
            let count = 0;
            Object.values(coachScores).forEach(coach => {
                if (coach && typeof coach === 'object' && coach[drillId] !== undefined && coach[drillId] !== null) count++;
            });
            return count;
        }

        function calculateCatchingTotal(player) {
            const c = player.catching || {};
            let total = 0;
            // Pop Time score (5 points max)
            total += calculatePopTimeScore(c.poptime || []);
            // Evaluation categories (30 points max averaged across coaches)
            const catchingCategories = ['setupStance', 'armStrength', 'blockingPopups', 'framing', 'footworkAgility', 'highMotor'];
            total += calculateCatchingDrillAverage(c.evaluation || {}, catchingCategories);
            return Math.round(total * 10) / 10;
        }

        function calculateBaserunningTotal(player) {
            const b = player.baserunning || {};
            let total = 0;

            // Speed metrics (10 points max) - using averages
            total += calculateSpeedScore('h1b', getAdjustedAvgH1B(b.h1b || { times: [null, null], missed1b: [false, false] }));
            total += calculateSpeedScore('2bh', getAdjustedAvg2BH(b['2bh'] || { times: [null, null], missed3b: [false, false] }));

            // Explosiveness (10 points max)
            total += calculateProAgilityScore(b.proagility || []);
            total += calculateBroadJumpScore(b.broadjump || []);

            // Your Evaluation (10 points max averaged)
            const evaluation = b.evaluation || {};
            const evalDrills = ['highmotor', 'intangibles'];
            evalDrills.forEach(drill => {
                total += calculateAverageScore(evaluation, drill);
            });

            return Math.round(total * 10) / 10;
        }

        function calculateIntangiblesTotal(player) {
            const intangibles = player.intangibles || {};
            const drills = ['awareness', 'leadership', 'enthusiasm'];
            let total = 0;
            drills.forEach(drill => {
                total += calculateAverageScore(intangibles, drill);
            });
            return total;
        }

        // ============================================
        // REPORT GENERATION
        // ============================================
        function showReportModal() {
            const modal = document.getElementById('reportModal');
            const select = document.getElementById('reportPlayerSelect');

            // Populate player dropdown
            select.innerHTML = '<option value="">-- Choose a player --</option>' +
                players.map(p => `<option value="${p.id}">${p.name} (#${p.number || 'N/A'})</option>`).join('');

            modal.classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        // ============================================
        // USER GUIDE FUNCTIONS
        // ============================================
        function showUserGuideModal() {
            const modal = document.getElementById('userGuideModal');
            const content = document.getElementById('userGuideContent');
            content.innerHTML = getUserGuideHTML();
            modal.classList.remove('hidden');
        }

        function closeUserGuideModal() {
            document.getElementById('userGuideModal').classList.add('hidden');
        }

        function getUserGuideHTML() {
            // Get current thresholds for display
            const cfg = scoringConfig;
            const bj = cfg.broadjump;
            const formatBJ = (t) => `${t.feet}'${t.inches}"`;

            return `
                <style>
                    .guide-section { margin-bottom: 24px; }
                    .guide-section h2 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; margin-bottom: 16px; }
                    .guide-section h3 { color: #1e3a8a; margin-top: 16px; margin-bottom: 8px; }
                    .guide-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
                    .guide-table th, .guide-table td { padding: 8px 12px; text-align: left; border: 1px solid #e5e7eb; }
                    .guide-table th { background: #f3f4f6; font-weight: 600; }
                    .guide-table tr:nth-child(even) { background: #f9fafb; }
                    .threshold-table { font-size: 0.9em; }
                    .threshold-table td { text-align: center; }
                    .note-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 12px 0; }
                    .tip-box { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; margin: 12px 0; }
                </style>

                <div class="guide-section">
                    <h2>üìã Getting Started</h2>
                    <h3>Logging In</h3>
                    <ol>
                        <li>Open the application in your web browser</li>
                        <li>Select your name from the dropdown</li>
                        <li>Enter the password: <code>nick2026</code></li>
                        <li>Click "Login"</li>
                    </ol>
                    <p>Your login stays active until you log out or clear your browser data.</p>
                </div>

                <div class="guide-section">
                    <h2>‚ûï Adding Players</h2>
                    <ol>
                        <li>Click the <strong>"Options"</strong> button at the top</li>
                        <li>Enter the player's name and jersey number</li>
                        <li>Click "Add Player" - the player will appear in the list</li>
                    </ol>
                </div>

                <div class="guide-section">
                    <h2>üìä Scoring Players</h2>
                    <p>Click on any player's name to expand their scoring sections.</p>
                    <p><strong>Total possible: 135 points</strong> (excluding Catching/Pitching which are position-specific)</p>

                    <h3>Catching (35 points max) - Catchers Only</h3>
                    <table class="guide-table">
                        <tr><th>Metric</th><th>How to Score</th></tr>
                        <tr><td><strong>Pop Time</strong></td><td>Enter time in seconds for 2 attempts. Average is scored 1-5.</td></tr>
                    </table>
                    <p><strong>Coach Evaluations</strong> (each coach enters their own 1-5 scores, averaged):</p>
                    <ul>
                        <li>Setup/Stance</li>
                        <li>Arm Strength/Accuracy</li>
                        <li>Blocking/Popups</li>
                        <li>Framing</li>
                        <li>Footwork/Agility</li>
                        <li>High Motor</li>
                    </ul>

                    <h3>Pitching - Pitchers Only</h3>
                    <table class="guide-table">
                        <tr><th>Metric</th><th>How to Score</th></tr>
                        <tr><td><strong>Mechanics</strong></td><td>Coach evaluation 1-5 (averaged)</td></tr>
                        <tr><td><strong>Athleticism</strong></td><td>Coach evaluation 1-5 (averaged)</td></tr>
                        <tr><td><strong># of Pitches</strong></td><td>Number of different pitch types</td></tr>
                        <tr><td><strong>Pitch Speeds</strong></td><td>Enter speeds for each pitch type (2 attempts each)</td></tr>
                        <tr><td><strong>Control</strong></td><td>Score 1-5 per pitch type</td></tr>
                    </table>

                    <h3>Baserunning (20 points max)</h3>
                    <p><strong>Timed Runs</strong> (scored 1-5 based on average time):</p>
                    <table class="guide-table">
                        <tr><th>Run</th><th>Attempts</th><th>Penalty Checkbox</th></tr>
                        <tr><td><strong>H‚Üí1B</strong></td><td>2</td><td>"Missed 1B" adds 0.5 seconds</td></tr>
                        <tr><td><strong>2B‚ÜíH</strong></td><td>2</td><td>"Missed 3B" adds 1 second</td></tr>
                    </table>

                    <p><strong>Explosiveness:</strong></p>
                    <table class="guide-table">
                        <tr><th>Metric</th><th>How to Enter</th></tr>
                        <tr><td><strong>Pro Agility</strong></td><td>Enter time in seconds for 2 attempts (scored on average)</td></tr>
                        <tr><td><strong>Broad Jump</strong></td><td>Enter feet and inches for 2 attempts (scored on average)</td></tr>
                    </table>

                    <h3>Hitting (30 points max)</h3>
                    <table class="guide-table">
                        <tr><th>Metric</th><th>How to Score</th></tr>
                        <tr><td><strong>Bat Speed</strong></td><td>Enter mph for 2 attempts. Scored: 70+=5, 63-69=4, 55-62=3, 48-54=2, &lt;48=1</td></tr>
                    </table>
                    <p><strong>Coach Evaluations</strong> (each coach enters their own 1-5 scores, averaged):</p>
                    <ul>
                        <li>Balance</li>
                        <li>Bat Path</li>
                        <li>Contact</li>
                        <li>Timing</li>
                        <li>High Motor</li>
                    </ul>

                    <h3>Infield (30 points max)</h3>
                    <p><strong>Coach Evaluations</strong> (each coach enters their own 1-5 scores, averaged):</p>
                    <ul>
                        <li>Fielding Mechanics</li>
                        <li>Arm Strength/Accuracy</li>
                        <li>Receiving Mechanics</li>
                        <li>Middle Infield Feed Mechanics</li>
                        <li>Agility/Explosiveness</li>
                        <li>High Motor</li>
                    </ul>

                    <h3>Outfield (25 points max)</h3>
                    <p><strong>Coach Evaluations</strong> (each coach enters their own 1-5 scores, averaged):</p>
                    <ul>
                        <li>Fielding Mechanics</li>
                        <li>Arm Strength/Accuracy</li>
                        <li>Range/Agility</li>
                        <li>Fly Ball Positioning/Transition</li>
                        <li>High Motor</li>
                    </ul>

                    <h3>Throwing (5 points max)</h3>
                    <table class="guide-table">
                        <tr><th>Metric</th><th>How to Score</th></tr>
                        <tr><td><strong>Throwing Velocity</strong></td><td>Enter mph for 2 attempts. Scored: 63+=5, 59-62=4, 53-58=3, 48-52=2, &lt;48=1</td></tr>
                    </table>

                    <h3>Intangibles (15 points max)</h3>
                    <p>Each coach enters their own 1-5 scores (averaged across coaches):</p>
                    <ul>
                        <li>Game Situation Awareness</li>
                        <li>Leadership</li>
                        <li>Enthusiasm</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h2>üìù Adding Notes</h2>
                    <p>Each category has a <strong>Notes</strong> section at the bottom.</p>
                    <ol>
                        <li>Type your note in the text box</li>
                        <li>Click <strong>"Add Note"</strong></li>
                        <li>Your name and timestamp are automatically recorded</li>
                    </ol>
                    <div class="note-box">
                        <strong>Note:</strong> You can only delete notes that you created.
                    </div>
                </div>

                <div class="guide-section">
                    <h2>üìà Generating Reports</h2>
                    <ol>
                        <li>Click <strong>"Options"</strong> then <strong>"Generate Reports"</strong></li>
                        <li>Choose:
                            <ul>
                                <li><strong>Individual Player:</strong> Select from dropdown</li>
                                <li><strong>All Players:</strong> Click "Generate All Reports" for ranked summary</li>
                            </ul>
                        </li>
                        <li>Click <strong>"Export Report"</strong> to download as HTML</li>
                    </ol>
                </div>

                <div class="guide-section">
                    <h2>‚öôÔ∏è Scoring Thresholds</h2>
                    <p>Current thresholds (can be customized via "Scoring Thresholds" button):</p>

                    <h3>Time-Based Drills (lower is better)</h3>
                    <table class="guide-table threshold-table">
                        <tr><th>Drill</th><th>5 pts</th><th>4 pts</th><th>3 pts</th><th>2 pts</th><th>1 pt</th></tr>
                        <tr><td><strong>Pop Time</strong></td><td>‚â§${cfg.poptime.t5}s</td><td>‚â§${cfg.poptime.t4}s</td><td>‚â§${cfg.poptime.t3}s</td><td>‚â§${cfg.poptime.t2}s</td><td>>${cfg.poptime.t2}s</td></tr>
                        <tr><td><strong>H‚Üí1B</strong></td><td>‚â§${cfg.h1b.t5}s</td><td>‚â§${cfg.h1b.t4}s</td><td>‚â§${cfg.h1b.t3}s</td><td>‚â§${cfg.h1b.t2}s</td><td>>${cfg.h1b.t2}s</td></tr>
                        <tr><td><strong>2B‚ÜíH</strong></td><td>‚â§${cfg['2bh'].t5}s</td><td>‚â§${cfg['2bh'].t4}s</td><td>‚â§${cfg['2bh'].t3}s</td><td>‚â§${cfg['2bh'].t2}s</td><td>>${cfg['2bh'].t2}s</td></tr>
                        <tr><td><strong>Pro Agility</strong></td><td>‚â§${cfg.proagility.t5}s</td><td>‚â§${cfg.proagility.t4}s</td><td>‚â§${cfg.proagility.t3}s</td><td>‚â§${cfg.proagility.t2}s</td><td>>${cfg.proagility.t2}s</td></tr>
                    </table>

                    <h3>Broad Jump (higher is better)</h3>
                    <table class="guide-table threshold-table">
                        <tr><th>5 pts</th><th>4 pts</th><th>3 pts</th><th>2 pts</th><th>1 pt</th></tr>
                        <tr><td>‚â•${formatBJ(bj.t5)}</td><td>‚â•${formatBJ(bj.t4)}</td><td>‚â•${formatBJ(bj.t3)}</td><td>‚â•${formatBJ(bj.t2)}</td><td><${formatBJ(bj.t2)}</td></tr>
                    </table>

                    <h3>Velocity-Based (higher is better)</h3>
                    <table class="guide-table threshold-table">
                        <tr><th>Metric</th><th>5 pts</th><th>4 pts</th><th>3 pts</th><th>2 pts</th><th>1 pt</th></tr>
                        <tr><td><strong>Throwing Velocity</strong></td><td>‚â•63 mph</td><td>‚â•59 mph</td><td>‚â•53 mph</td><td>‚â•48 mph</td><td>&lt;48 mph</td></tr>
                        <tr><td><strong>Bat Speed</strong></td><td>‚â•70 mph</td><td>‚â•63 mph</td><td>‚â•55 mph</td><td>‚â•48 mph</td><td>&lt;48 mph</td></tr>
                    </table>
                </div>

                <div class="guide-section">
                    <h2>üîÑ Data Syncing</h2>
                    <ul>
                        <li>All scores <strong>automatically save</strong> to Google Sheets</li>
                        <li>Changes sync within 1 second of entering data</li>
                        <li>You'll see the last sync time at the top of the screen</li>
                        <li>Multiple coaches can score simultaneously - data merges automatically</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h2>üì• Exporting Data</h2>
                    <p>Click <strong>"Options"</strong> then <strong>"Export CSV"</strong> to download all data.</p>
                    <p>The CSV includes:</p>
                    <ul>
                        <li><strong>All Players</strong> - Ranked by total score with category breakdowns</li>
                        <li><strong>Catchers</strong> - Detailed catching stats + totals</li>
                        <li><strong>Pitchers</strong> - Detailed pitching stats + pitch-by-pitch data</li>
                        <li><strong>Coach Notes</strong> - All notes organized by player and category</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h2>üí° Tips</h2>
                    <div class="tip-box">
                        <ol>
                            <li><strong>Score as you go</strong> - Don't wait until the end; data saves automatically</li>
                            <li><strong>Use notes</strong> for observations that don't fit in scores (attitude, coachability, etc.)</li>
                            <li><strong>Check the sync indicator</strong> to make sure your data is saving</li>
                            <li><strong>Generate reports</strong> at the end of tryouts to review all players ranked by score</li>
                            <li><strong>Export CSV</strong> includes all coach notes for offline review</li>
                        </ol>
                    </div>
                </div>

                <div class="guide-section">
                    <h2>‚ùì Troubleshooting</h2>
                    <table class="guide-table">
                        <tr><th>Problem</th><th>Solution</th></tr>
                        <tr><td>Can't log in</td><td>Make sure password is exactly <code>nick2026</code></td></tr>
                        <tr><td>Data not saving</td><td>Check your internet connection; look for sync indicator</td></tr>
                        <tr><td>Can't see other coaches' scores</td><td>Refresh the page to pull latest data</td></tr>
                        <tr><td>Report shows "N/A"</td><td>That metric hasn't been scored yet</td></tr>
                    </table>
                </div>

                <div class="guide-section">
                    <h2>üìû Questions?</h2>
                    <p>Contact Nick for technical support.</p>
                </div>
            `;
        }

        function exportUserGuideHTML() {
            const guideHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GC Softball Tryouts 2026 - Coach User Guide</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #d97706; border-bottom: 3px solid #d97706; padding-bottom: 10px; }
        h2 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; margin-top: 30px; }
        h3 { color: #1e3a8a; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #e5e7eb; }
        th { background: #f3f4f6; font-weight: 600; }
        tr:nth-child(even) { background: #f9fafb; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .note-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0; }
        .tip-box { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; margin: 15px 0; }
        ul, ol { margin: 10px 0; padding-left: 25px; }
        li { margin: 5px 0; }
        @media print { body { max-width: 100%; } }
    </style>
</head>
<body>
    <h1>üìñ GC Softball Tryouts 2026 - Coach User Guide</h1>
    ${document.getElementById('userGuideContent').innerHTML}
    <hr>
    <p style="text-align: center; color: #6b7280; font-size: 0.9em;">
        Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
    </p>
</body>
</html>`;

            const blob = new Blob([guideHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'GC_Softball_Tryouts_User_Guide.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printUserGuide() {
            const content = document.getElementById('userGuideContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>GC Softball Tryouts - Coach User Guide</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #d97706; border-bottom: 3px solid #d97706; padding-bottom: 10px; }
        h2 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; margin-top: 30px; }
        h3 { color: #1e3a8a; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #ccc; }
        th { background: #f3f4f6; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
        .note-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0; }
        .tip-box { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üìñ GC Softball Tryouts 2026 - Coach User Guide</h1>
    ${content}
</body>
</html>`);
            printWindow.document.close();
            printWindow.print();
        }

        function generateReport() {
            const playerId = parseInt(document.getElementById('reportPlayerSelect').value);
            if (!playerId) {
                document.getElementById('reportContent').innerHTML =
                    '<p class="text-gray-500 text-center">Select a player to generate their summary report</p>';
                return;
            }

            const player = players.find(p => p.id === playerId);
            if (!player) return;

            document.getElementById('reportContent').innerHTML = generatePlayerReportHTML(player);
        }

        function generateAllReports() {
            if (players.length === 0) {
                document.getElementById('reportContent').innerHTML =
                    '<p class="text-gray-500 text-center">No players to generate reports for</p>';
                return;
            }

            const sortedPlayers = [...players].sort((a, b) => {
                const totalA = calculateCatchingTotal(a) + calculateBaserunningTotal(a) + calculateHittingTotal(a) + calculateIntangiblesTotal(a) + calculateInfieldTotal(a) + calculateOutfieldTotal(a) + calculateThrowingTotal(a);
                const totalB = calculateCatchingTotal(b) + calculateBaserunningTotal(b) + calculateHittingTotal(b) + calculateIntangiblesTotal(b) + calculateInfieldTotal(b) + calculateOutfieldTotal(b) + calculateThrowingTotal(b);
                return totalB - totalA;
            });

            document.getElementById('reportContent').innerHTML = sortedPlayers.map((player, idx) =>
                `<div class="mb-8 ${idx > 0 ? 'border-t-4 border-gray-300 pt-8' : ''}">${generatePlayerReportHTML(player, idx + 1)}</div>`
            ).join('');
        }

        function generatePlayerReportHTML(player, rank = null) {
            const c = player.catching || {};
            const b = player.baserunning || {};
            const intang = player.intangibles || {};
            const inf = player.infield || {};
            const outf = player.outfield || {};
            const t = player.throwing || {};
            const h = player.hitting || {};

            const catchingTotal = calculateCatchingTotal(player);
            const baserunningTotal = calculateBaserunningTotal(player);
            const hittingTotal = calculateHittingTotal(player);
            const intangiblesTotal = calculateIntangiblesTotal(player);
            const infieldTotal = calculateInfieldTotal(player);
            const outfieldTotal = calculateOutfieldTotal(player);
            const throwingTotal = calculateThrowingTotal(player);
            const grandTotal = catchingTotal + baserunningTotal + hittingTotal + intangiblesTotal + infieldTotal + outfieldTotal + throwingTotal;

            // Get all notes
            const catchingNotes = c.notes || [];
            const baserunningNotes = b.notes || [];
            const hittingNotes = h.notes || [];
            const intangiblesNotes = intang.notes || [];
            const infieldNotes = inf.notes || [];
            const outfieldNotes = outf.notes || [];
            const throwingNotes = t.notes || [];

            return `
                <div class="report-player border-2 border-gray-200 rounded-lg p-6 bg-white print:break-inside-avoid">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${player.name}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-green-600">${grandTotal.toFixed(1)}</div>
                            <div class="text-sm text-gray-500">Total Points</div>
                        </div>
                    </div>

                    <!-- Score Summary Bar -->
                    <div class="grid grid-cols-7 gap-2 mb-6">
                        <div class="bg-purple-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-purple-700">${catchingTotal}</div>
                            <div class="text-xs text-purple-600">Catching</div>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-blue-700">${baserunningTotal.toFixed(1)}</div>
                            <div class="text-xs text-blue-600">Baserunning</div>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-orange-700">${hittingTotal.toFixed(1)}</div>
                            <div class="text-xs text-orange-600">Hitting</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-green-700">${infieldTotal.toFixed(1)}</div>
                            <div class="text-xs text-green-600">Infield</div>
                        </div>
                        <div class="bg-teal-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-teal-700">${outfieldTotal.toFixed(1)}</div>
                            <div class="text-xs text-teal-600">Outfield</div>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-red-700">${throwingTotal.toFixed(1)}</div>
                            <div class="text-xs text-red-600">Throwing</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-yellow-700">${intangiblesTotal.toFixed(1)}</div>
                            <div class="text-xs text-yellow-600">Intangibles</div>
                        </div>
                    </div>

                    <!-- Catching Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-purple-700 border-b border-purple-200 pb-1 mb-2">Catching Details</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                            <div><span class="text-gray-500">Pop Time (Avg):</span> ${getAverageTime(c.poptime || []) || 'N/A'}s (${calculatePopTimeScore(c.poptime || [])}/5)</div>
                            <div><span class="text-gray-500">Setup/Stance:</span> ${calculateAverageScore(c.evaluation || {}, 'setupStance').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Arm Strength/Accuracy:</span> ${calculateAverageScore(c.evaluation || {}, 'armStrength').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Blocking/Popups:</span> ${calculateAverageScore(c.evaluation || {}, 'blockingPopups').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Framing:</span> ${calculateAverageScore(c.evaluation || {}, 'framing').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Footwork/Agility:</span> ${calculateAverageScore(c.evaluation || {}, 'footworkAgility').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">High Motor:</span> ${calculateAverageScore(c.evaluation || {}, 'highMotor').toFixed(1)}/5</div>
                        </div>
                        ${catchingNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-purple-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${catchingNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Baserunning Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-blue-700 border-b border-blue-200 pb-1 mb-2">Baserunning Details</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                            <div><span class="text-gray-500">H‚Üí1B (Avg):</span> ${getAdjustedAvgH1B(b.h1b || { times: [null, null], missed1b: [false, false] }) || 'N/A'}s (${calculateSpeedScore('h1b', getAdjustedAvgH1B(b.h1b || { times: [null, null], missed1b: [false, false] }))}/5)</div>
                            <div><span class="text-gray-500">2B‚ÜíH (Avg):</span> ${getAdjustedAvg2BH(b['2bh'] || { times: [null, null], missed3b: [false, false] }) || 'N/A'}s (${calculateSpeedScore('2bh', getAdjustedAvg2BH(b['2bh'] || { times: [null, null], missed3b: [false, false] }))}/5)</div>
                            <div><span class="text-gray-500">Pro Agility (Avg):</span> ${getAverageTime(b.proagility || []) || 'N/A'}s (${calculateProAgilityScore(b.proagility || [])}/5)</div>
                            <div><span class="text-gray-500">Broad Jump (Avg):</span> ${getAverageBroadJump(b.broadjump || []) || 'N/A'} (${calculateBroadJumpScore(b.broadjump || [])}/5)</div>
                        </div>
                        <div class="mt-2 text-sm">
                            <span class="text-gray-500">Your Evaluation (Avg):</span>
                            High Motor: ${calculateAverageScore(b.evaluation || {}, 'highmotor').toFixed(1)} |
                            Intangibles: ${calculateAverageScore(b.evaluation || {}, 'intangibles').toFixed(1)}
                        </div>
                        ${baserunningNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-blue-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${baserunningNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Hitting Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-orange-700 border-b border-orange-200 pb-1 mb-2">Hitting Details</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div><span class="text-gray-500">Bat Speed (Avg):</span> ${getAverageBatSpeed(h.batSpeed) || 'N/A'} mph (${calculateBatSpeedScore(h.batSpeed)}/5)</div>
                            <div><span class="text-gray-500">Balance:</span> ${calculateAverageScore(h.evaluation || {}, 'balance').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Bat Path:</span> ${calculateAverageScore(h.evaluation || {}, 'batPath').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Contact:</span> ${calculateAverageScore(h.evaluation || {}, 'contact').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Timing:</span> ${calculateAverageScore(h.evaluation || {}, 'timing').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">High Motor:</span> ${calculateAverageScore(h.evaluation || {}, 'highMotor').toFixed(1)}/5</div>
                        </div>
                        ${hittingNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-orange-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${hittingNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Infield Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-green-700 border-b border-green-200 pb-1 mb-2">Infield Details</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div><span class="text-gray-500">Fielding Mechanics:</span> ${calculateAverageScore(inf.evaluation || {}, 'fieldingMechanics').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Arm Strength/Accuracy:</span> ${calculateAverageScore(inf.evaluation || {}, 'armStrength').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Receiving Mechanics:</span> ${calculateAverageScore(inf.evaluation || {}, 'receivingMechanics').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">MI Feed Mechanics:</span> ${calculateAverageScore(inf.evaluation || {}, 'miFeed').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Agility/Explosiveness:</span> ${calculateAverageScore(inf.evaluation || {}, 'agility').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">High Motor:</span> ${calculateAverageScore(inf.evaluation || {}, 'highMotor').toFixed(1)}/5</div>
                        </div>
                        ${infieldNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-green-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${infieldNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Outfield Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-teal-700 border-b border-teal-200 pb-1 mb-2">Outfield Details</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div><span class="text-gray-500">Fielding Mechanics:</span> ${calculateAverageScore(outf.evaluation || {}, 'fieldingMechanics').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Arm Strength/Accuracy:</span> ${calculateAverageScore(outf.evaluation || {}, 'armStrength').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Range/Agility:</span> ${calculateAverageScore(outf.evaluation || {}, 'rangeAgility').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Fly Ball Pos/Trans:</span> ${calculateAverageScore(outf.evaluation || {}, 'flyBallMechanics').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">High Motor:</span> ${calculateAverageScore(outf.evaluation || {}, 'highMotor').toFixed(1)}/5</div>
                        </div>
                        ${outfieldNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-teal-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${outfieldNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Throwing Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-red-700 border-b border-red-200 pb-1 mb-2">Throwing Details</h4>
                        <div class="text-sm">
                            <div><span class="text-gray-500">Velocity (Avg):</span> ${getAverageVelocity(t.velocity) || 'N/A'} mph (${calculateVelocityScore(getAverageVelocity(t.velocity))}/5)</div>
                        </div>
                        ${throwingNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-red-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${throwingNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Intangibles Details -->
                    <div class="mb-4">
                        <h4 class="font-semibold text-yellow-700 border-b border-yellow-200 pb-1 mb-2">Intangibles Details</h4>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <div><span class="text-gray-500">Awareness:</span> ${calculateAverageScore(intang, 'awareness').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Leadership:</span> ${calculateAverageScore(intang, 'leadership').toFixed(1)}/5</div>
                            <div><span class="text-gray-500">Enthusiasm:</span> ${calculateAverageScore(intang, 'enthusiasm').toFixed(1)}/5</div>
                        </div>
                        ${intangiblesNotes.length > 0 ? `
                            <div class="mt-2 p-2 bg-yellow-50 rounded text-sm">
                                <strong>Notes:</strong>
                                ${intangiblesNotes.map(n => `<div class="ml-2"><em>${n.coach}:</em> ${n.text}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <div class="text-xs text-gray-400 text-right mt-4">
                        Report generated: ${new Date().toLocaleString()}
                    </div>
                </div>
            `;
        }

        function exportCurrentReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            if (!reportContent || reportContent.includes('Select a player')) {
                alert('Please generate a report first');
                return;
            }

            const html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GC Softball Tryouts Report</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        @media print {
            .report-player { page-break-inside: avoid; }
        }
        body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">GC Softball Tryouts 2026</h1>
            <p class="text-gray-600">Player Summary Report</p>
            <p class="text-sm text-gray-500">Generated: ${new Date().toLocaleString()}</p>
        </div>
        <div class="space-y-6">
            ${reportContent}
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GC_Tryouts_Report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // ALL PLAYERS VIEW
        // ============================================
        function setPlayerFilter(filter) {
            playerViewFilter = filter;
            // Update button styles
            document.getElementById('filter-all').className = filter === 'all'
                ? 'px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm'
                : 'px-3 py-1 rounded-lg bg-gray-100 text-gray-700 text-sm hover:bg-gray-200';
            document.getElementById('filter-catchers').className = filter === 'catchers'
                ? 'px-3 py-1 rounded-lg bg-purple-600 text-white text-sm'
                : 'px-3 py-1 rounded-lg bg-purple-100 text-purple-700 text-sm hover:bg-purple-200';
            document.getElementById('filter-pitchers').className = filter === 'pitchers'
                ? 'px-3 py-1 rounded-lg bg-pink-600 text-white text-sm'
                : 'px-3 py-1 rounded-lg bg-pink-100 text-pink-700 text-sm hover:bg-pink-200';
            renderAllPlayers();
        }

        function renderAllPlayers() {
            const list = document.getElementById('playersList');

            if (players.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">No players added yet. Use the Options menu to add players.</p>';
                return;
            }

            // Filter players based on view
            let filteredPlayers = [...players];
            if (playerViewFilter === 'catchers') {
                filteredPlayers = players.filter(p => CATCHERS.includes(p.name));
            } else if (playerViewFilter === 'pitchers') {
                filteredPlayers = players.filter(p => PITCHERS.includes(p.name));
            }

            // Sort by total score
            const sortedPlayers = filteredPlayers.sort((a, b) => {
                const totalA = calculateBaserunningTotal(a) + calculateIntangiblesTotal(a) + calculateInfieldTotal(a) + calculateOutfieldTotal(a) + calculateThrowingTotal(a) + calculateHittingTotal(a) +
                    (playerViewFilter === 'catchers' ? calculateCatchingTotal(a) : 0) +
                    (playerViewFilter === 'pitchers' ? calculatePitchingTotal(a) : 0);
                const totalB = calculateBaserunningTotal(b) + calculateIntangiblesTotal(b) + calculateInfieldTotal(b) + calculateOutfieldTotal(b) + calculateThrowingTotal(b) + calculateHittingTotal(b) +
                    (playerViewFilter === 'catchers' ? calculateCatchingTotal(b) : 0) +
                    (playerViewFilter === 'pitchers' ? calculatePitchingTotal(b) : 0);
                return totalB - totalA;
            });

            // Build headers based on filter
            let headers = `
                <th class="px-3 py-2 text-left">Rank</th>
                <th class="px-3 py-2 text-left">Name</th>`;

            if (playerViewFilter === 'catchers') {
                headers += `<th class="px-3 py-2 text-center bg-purple-50">Catching</th>`;
            }
            if (playerViewFilter === 'pitchers') {
                headers += `<th class="px-3 py-2 text-center bg-pink-50">Pitching</th>`;
            }

            headers += `
                <th class="px-3 py-2 text-center">Baserunning</th>
                <th class="px-3 py-2 text-center">Hitting</th>
                <th class="px-3 py-2 text-center">Infield</th>
                <th class="px-3 py-2 text-center">Outfield</th>
                <th class="px-3 py-2 text-center">Throwing</th>
                <th class="px-3 py-2 text-center">Intangibles</th>
                <th class="px-3 py-2 text-center">Total</th>
                <th class="px-3 py-2 text-center">Actions</th>`;

            // Calculate max total based on filter
            let maxTotal = 135; // Baserunning 30 + Hitting 30 + Infield 30 + Outfield 25 + Throwing 5 + Intangibles 15
            if (playerViewFilter === 'catchers') maxTotal += 35;
            if (playerViewFilter === 'pitchers') maxTotal += 15; // Approximate pitching max

            list.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>${headers}</tr>
                        </thead>
                        <tbody>
                            ${sortedPlayers.map((p, idx) => {
                                const catching = calculateCatchingTotal(p);
                                const pitching = calculatePitchingTotal(p);
                                const baserunning = calculateBaserunningTotal(p);
                                const hitting = calculateHittingTotal(p);
                                const infield = calculateInfieldTotal(p);
                                const outfield = calculateOutfieldTotal(p);
                                const throwing = calculateThrowingTotal(p);
                                const intangibles = calculateIntangiblesTotal(p);

                                let total = baserunning + hitting + infield + outfield + throwing + intangibles;
                                if (playerViewFilter === 'catchers') total += catching;
                                if (playerViewFilter === 'pitchers') total += pitching;

                                let cells = `
                                    <td class="px-3 py-2 font-bold">${idx + 1}</td>
                                    <td class="px-3 py-2">${p.name}</td>`;

                                if (playerViewFilter === 'catchers') {
                                    cells += `<td class="px-3 py-2 text-center bg-purple-50">${catching}/35</td>`;
                                }
                                if (playerViewFilter === 'pitchers') {
                                    cells += `<td class="px-3 py-2 text-center bg-pink-50">${pitching.toFixed(1)}</td>`;
                                }

                                cells += `
                                    <td class="px-3 py-2 text-center">${baserunning.toFixed(1)}/30</td>
                                    <td class="px-3 py-2 text-center">${hitting.toFixed(1)}/30</td>
                                    <td class="px-3 py-2 text-center">${infield.toFixed(1)}/30</td>
                                    <td class="px-3 py-2 text-center">${outfield.toFixed(1)}/25</td>
                                    <td class="px-3 py-2 text-center">${throwing.toFixed(1)}/5</td>
                                    <td class="px-3 py-2 text-center">${intangibles.toFixed(1)}/15</td>
                                    <td class="px-3 py-2 text-center font-bold">${total.toFixed(1)}</td>
                                    <td class="px-3 py-2 text-center">
                                        <button onclick="deletePlayer(${p.id})" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                                    </td>`;

                                return `<tr class="border-b hover:bg-gray-50">${cells}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${filteredPlayers.length === 0 ? '<p class="text-gray-500 text-center py-4">No players found for this filter.</p>' : ''}
            `;
        }

        // ============================================
        // GOOGLE SHEETS SYNC
        // ============================================
        async function uploadToSheets() {
            if (GOOGLE_SCRIPT_URL.includes('YOUR_NEW')) {
                alert('Please configure your Google Apps Script URL first.');
                return;
            }

            if (isSyncing) return;
            isSyncing = true;
            showSaveStatus('‚è≥ Uploading to Google Sheets...');

            try {
                const formData = new FormData();
                formData.append('data', JSON.stringify(players));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    showSaveStatus('‚úì Uploaded to Google Sheets!');
                    alert(`Successfully uploaded ${players.length} player(s)!`);
                } else {
                    showSaveStatus('‚ö†Ô∏è Upload failed');
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                showSaveStatus('‚ö†Ô∏è Upload failed');
                alert('Error uploading: ' + error.message);
            } finally {
                isSyncing = false;
            }
        }

        async function autoUploadToSheets() {
            if (GOOGLE_SCRIPT_URL.includes('YOUR_NEW')) return;

            // If already syncing, don't start another sync - it will be handled by pendingChanges
            if (isSyncing) {
                console.log('üì§ Sync in progress, changes will be uploaded after');
                return;
            }

            isSyncing = true;
            pendingChanges = false;  // Reset pending flag before upload
            const uploadStartTime = Date.now();
            showSaveStatus('‚è≥ Auto-syncing...');

            try {
                const dataToSend = JSON.stringify(players);
                console.log('üì§ Uploading to Sheets:', dataToSend.length, 'chars');

                const formData = new FormData();
                formData.append('data', dataToSend);

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('üì§ Upload response:', result);

                // Check if new changes happened during upload
                if (pendingChanges || lastSaveTimestamp > uploadStartTime) {
                    console.log('üì§ Changes occurred during upload, re-uploading...');
                    showSaveStatus('‚è≥ Re-syncing new changes...');
                    isSyncing = false;
                    // Schedule immediate re-upload
                    setTimeout(() => autoUploadToSheets(), 100);
                    return;
                }

                showSaveStatus(result.success ? '‚úì Auto-synced' : '‚ö†Ô∏è Sync failed');
            } catch (error) {
                console.error('Auto-upload error:', error);
                showSaveStatus('‚ö†Ô∏è Sync failed');
                // If failed and there are pending changes, retry
                if (pendingChanges) {
                    setTimeout(() => autoUploadToSheets(), 2000);
                }
            } finally {
                isSyncing = false;
            }
        }

        async function downloadFromSheets() {
            if (GOOGLE_SCRIPT_URL.includes('YOUR_NEW')) {
                alert('Please configure your Google Apps Script URL first.');
                return;
            }

            if (isSyncing) return;
            isSyncing = true;
            showSaveStatus('‚è≥ Downloading...');

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();

                if (Array.isArray(data) && data.length > 0) {
                    if (confirm(`Found ${data.length} player(s). Replace local data?`)) {
                        players = data;
                        saveData();
                        renderPlayerSelect();
                        renderAllPlayers();
                        renderScoringArea();
                        showSaveStatus('‚úì Downloaded!');
                        alert(`Downloaded ${players.length} player(s)!`);
                    }
                } else {
                    showSaveStatus('No data found');
                    alert('No player data found in Google Sheets.');
                }
            } catch (error) {
                console.error('Download error:', error);
                showSaveStatus('‚ö†Ô∏è Download failed');
                alert('Error downloading: ' + error.message);
            } finally {
                isSyncing = false;
            }
        }

        async function autoDownloadFromSheets() {
            if (GOOGLE_SCRIPT_URL.includes('YOUR_NEW')) {
                loadData();
                return;
            }

            try {
                showSaveStatus('‚è≥ Loading from Sheets...');
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const rawText = await response.text();
                console.log('üì• Raw response length:', rawText.length, 'chars');

                const data = JSON.parse(rawText);
                console.log('üì• Downloaded from Sheets:', data);

                if (Array.isArray(data) && data.length > 0) {
                    // Log catching data specifically
                    data.forEach(p => {
                        if (p.catching && p.catching.evaluation && Object.keys(p.catching.evaluation).length > 0) {
                            console.log(`üì• ${p.name} catching evaluation:`, JSON.stringify(p.catching.evaluation, null, 2));
                        }
                    });
                    players = data;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
                    showSaveStatus('‚úì Loaded from Sheets');
                } else {
                    loadData();
                    showSaveStatus('Using local data');
                }
            } catch (error) {
                console.error('Auto-download error:', error);
                loadData();
                showSaveStatus('‚ö†Ô∏è Using local data');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showSaveStatus(message) {
            const status = document.getElementById('saveStatus');
            status.textContent = message;
            setTimeout(() => {
                status.textContent = 'üîÑ Auto-syncing with Google Sheets';
            }, 3000);
        }

        function toggleSection(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        function exportData() {
            let csv = '';

            // =====================
            // ALL PLAYERS SECTION (ordered by score, no catching/pitching)
            // =====================
            csv += '--- ALL PLAYERS (Ranked by Score) ---\n';
            csv += 'Rank,Name,Grand Total,';
            // Baserunning columns
            csv += 'H-1B Avg,H-1B Score,2B-H Avg,2B-H Score,Pro Agility Avg,Pro Agility Score,Broad Jump Avg,Broad Jump Score,Baserunning Total,';
            // Hitting columns
            csv += 'Bat Speed Avg,Bat Speed Score,Balance,Bat Path,Contact,Timing,Hit High Motor,Hitting Total,';
            // Infield columns
            csv += 'IF Fielding Mech,IF Arm Str/Acc,Receiving Mech,MI Feed Mech,IF Agility/Expl,IF High Motor,Infield Total,';
            // Outfield columns
            csv += 'OF Fielding Mech,OF Arm Str/Acc,Range/Agility,Fly Ball Pos/Trans,OF High Motor,Outfield Total,';
            // Throwing columns
            csv += 'Velocity Avg,Throwing Score,';
            // Intangibles columns
            csv += 'Awareness,Leadership,Enthusiasm,Intangibles Total\n';

            const sortedAll = [...players].sort((a, b) => {
                const totalA = calculateBaserunningTotal(a) + calculateHittingTotal(a) + calculateInfieldTotal(a) + calculateOutfieldTotal(a) + calculateThrowingTotal(a) + calculateIntangiblesTotal(a);
                const totalB = calculateBaserunningTotal(b) + calculateHittingTotal(b) + calculateInfieldTotal(b) + calculateOutfieldTotal(b) + calculateThrowingTotal(b) + calculateIntangiblesTotal(b);
                return totalB - totalA;
            });

            sortedAll.forEach((p, idx) => {
                const baserunningTotal = calculateBaserunningTotal(p);
                const hittingTotal = calculateHittingTotal(p);
                const infieldTotal = calculateInfieldTotal(p);
                const outfieldTotal = calculateOutfieldTotal(p);
                const throwingTotal = calculateThrowingTotal(p);
                const intangiblesTotal = calculateIntangiblesTotal(p);
                const grandTotal = baserunningTotal + hittingTotal + infieldTotal + outfieldTotal + throwingTotal + intangiblesTotal;

                // Baserunning details
                const b = p.baserunning || {};
                const h1b = b.h1b || { times: [null, null], missed1b: [false, false] };
                const tbh = b['2bh'] || { times: [null, null], missed3b: [false, false] };
                const exp = b.explosiveness || {};
                const h1bAvg = getAdjustedAvgH1B(h1b);
                const h1bScore = calculateSpeedScore('h1b', h1bAvg);
                const tbhAvg = getAdjustedAvg2BH(tbh);
                const tbhScore = calculateSpeedScore('2bh', tbhAvg);
                const proAgility = exp.proAgility || [null, null];
                const proAgAvg = getAverageTime(proAgility) || '';
                const proAgScore = calculateProAgilityScore(proAgility);
                const broadJump = exp.broadJump || [null, null];
                const bjAvg = getAverageBroadJump(broadJump);
                const bjAvgStr = bjAvg ? `${bjAvg.feet}'${bjAvg.inches}"` : '';
                const bjScore = calculateBroadJumpScore(broadJump);

                // Hitting details
                const h = p.hitting || {};
                const batSpeed = h.batSpeed || [null, null];
                const bsAvg = getAverageBatSpeed(batSpeed);
                const bsAvgStr = bsAvg !== null ? bsAvg.toFixed(1) : '';
                const bsScore = calculateBatSpeedScore(batSpeed);
                const hitBalance = calculateAverageScore(h.evaluation || {}, 'balance').toFixed(1);
                const hitBatPath = calculateAverageScore(h.evaluation || {}, 'batPath').toFixed(1);
                const hitContact = calculateAverageScore(h.evaluation || {}, 'contact').toFixed(1);
                const hitTiming = calculateAverageScore(h.evaluation || {}, 'timing').toFixed(1);
                const hitHighMotor = calculateAverageScore(h.evaluation || {}, 'highMotor').toFixed(1);

                // Infield details
                const inf = p.infield || {};
                const infFieldingMech = calculateAverageScore(inf.evaluation || {}, 'fieldingMechanics').toFixed(1);
                const infArmStr = calculateAverageScore(inf.evaluation || {}, 'armStrength').toFixed(1);
                const infReceiving = calculateAverageScore(inf.evaluation || {}, 'receivingMechanics').toFixed(1);
                const infMiFeed = calculateAverageScore(inf.evaluation || {}, 'miFeedMechanics').toFixed(1);
                const infAgility = calculateAverageScore(inf.evaluation || {}, 'agilityExplosiveness').toFixed(1);
                const infHighMotor = calculateAverageScore(inf.evaluation || {}, 'highMotor').toFixed(1);

                // Outfield details
                const outf = p.outfield || {};
                const outfFieldingMech = calculateAverageScore(outf.evaluation || {}, 'fieldingMechanics').toFixed(1);
                const outfArmStr = calculateAverageScore(outf.evaluation || {}, 'armStrength').toFixed(1);
                const outfRange = calculateAverageScore(outf.evaluation || {}, 'rangeAgility').toFixed(1);
                const outfFlyBall = calculateAverageScore(outf.evaluation || {}, 'flyBallTransition').toFixed(1);
                const outfHighMotor = calculateAverageScore(outf.evaluation || {}, 'highMotor').toFixed(1);

                // Throwing details
                const t = p.throwing || {};
                const velocity = t.velocity || [null, null];
                const vAvg = getAverageVelocity(velocity);
                const vAvgStr = vAvg !== null ? vAvg.toFixed(1) : '';

                // Intangibles details
                const intang = p.intangibles || {};
                const awareness = calculateAverageScore(intang.evaluation || {}, 'awareness').toFixed(1);
                const leadership = calculateAverageScore(intang.evaluation || {}, 'leadership').toFixed(1);
                const enthusiasm = calculateAverageScore(intang.evaluation || {}, 'enthusiasm').toFixed(1);

                csv += `${idx + 1},"${p.name}",${grandTotal.toFixed(1)},`;
                csv += `${h1bAvg},${h1bScore},${tbhAvg},${tbhScore},${proAgAvg},${proAgScore},${bjAvgStr},${bjScore},${baserunningTotal.toFixed(1)},`;
                csv += `${bsAvgStr},${bsScore},${hitBalance},${hitBatPath},${hitContact},${hitTiming},${hitHighMotor},${hittingTotal.toFixed(1)},`;
                csv += `${infFieldingMech},${infArmStr},${infReceiving},${infMiFeed},${infAgility},${infHighMotor},${infieldTotal.toFixed(1)},`;
                csv += `${outfFieldingMech},${outfArmStr},${outfRange},${outfFlyBall},${outfHighMotor},${outfieldTotal.toFixed(1)},`;
                csv += `${vAvgStr},${throwingTotal.toFixed(1)},`;
                csv += `${awareness},${leadership},${enthusiasm},${intangiblesTotal.toFixed(1)}\n`;
            });

            // =====================
            // CATCHERS SECTION
            // =====================
            csv += '\n\n--- CATCHERS (Ranked by Total with Catching) ---\n';
            csv += 'Rank,Name,Pop Time Avg,Pop Time Score,Setup/Stance,Arm Str/Acc,Block/Popups,Framing,Foot/Agility,High Motor,Catching Total,Baserunning,Hitting,Infield,Outfield,Throwing,Intangibles,Grand Total\n';

            const catchers = players.filter(p => CATCHERS.includes(p.name)).sort((a, b) => {
                const totalA = calculateCatchingTotal(a) + calculateBaserunningTotal(a) + calculateHittingTotal(a) + calculateInfieldTotal(a) + calculateOutfieldTotal(a) + calculateThrowingTotal(a) + calculateIntangiblesTotal(a);
                const totalB = calculateCatchingTotal(b) + calculateBaserunningTotal(b) + calculateHittingTotal(b) + calculateInfieldTotal(b) + calculateOutfieldTotal(b) + calculateThrowingTotal(b) + calculateIntangiblesTotal(b);
                return totalB - totalA;
            });

            catchers.forEach((p, idx) => {
                const c = p.catching || {};
                const popTimeAvg = getAverageTime(c.poptime || []) || 'N/A';
                const popTimeScore = calculatePopTimeScore(c.poptime || []);
                const setupStance = calculateAverageScore(c.evaluation || {}, 'setupStance').toFixed(1);
                const armStrength = calculateAverageScore(c.evaluation || {}, 'armStrength').toFixed(1);
                const blockingPopups = calculateAverageScore(c.evaluation || {}, 'blockingPopups').toFixed(1);
                const framing = calculateAverageScore(c.evaluation || {}, 'framing').toFixed(1);
                const footworkAgility = calculateAverageScore(c.evaluation || {}, 'footworkAgility').toFixed(1);
                const highMotor = calculateAverageScore(c.evaluation || {}, 'highMotor').toFixed(1);
                const catchingTotal = calculateCatchingTotal(p);
                const baserunning = calculateBaserunningTotal(p);
                const hitting = calculateHittingTotal(p);
                const infield = calculateInfieldTotal(p);
                const outfield = calculateOutfieldTotal(p);
                const throwing = calculateThrowingTotal(p);
                const intangibles = calculateIntangiblesTotal(p);
                const grandTotal = catchingTotal + baserunning + hitting + infield + outfield + throwing + intangibles;

                csv += `${idx + 1},"${p.name}",${popTimeAvg},${popTimeScore},${setupStance},${armStrength},${blockingPopups},${framing},${footworkAgility},${highMotor},${catchingTotal.toFixed(1)},${baserunning.toFixed(1)},${hitting.toFixed(1)},${infield.toFixed(1)},${outfield.toFixed(1)},${throwing.toFixed(1)},${intangibles.toFixed(1)},${grandTotal.toFixed(1)}\n`;
            });

            // =====================
            // PITCHERS SECTION
            // =====================
            csv += '\n\n--- PITCHERS (Ranked by Total with Pitching) ---\n';
            csv += 'Rank,Name,Mechanics,Athleticism,# Pitches,Pitching Total,Baserunning,Hitting,Infield,Outfield,Throwing,Intangibles,Grand Total\n';

            const pitchers = players.filter(p => PITCHERS.includes(p.name)).sort((a, b) => {
                const totalA = calculatePitchingTotal(a) + calculateBaserunningTotal(a) + calculateHittingTotal(a) + calculateInfieldTotal(a) + calculateOutfieldTotal(a) + calculateThrowingTotal(a) + calculateIntangiblesTotal(a);
                const totalB = calculatePitchingTotal(b) + calculateBaserunningTotal(b) + calculateHittingTotal(b) + calculateInfieldTotal(b) + calculateOutfieldTotal(b) + calculateThrowingTotal(b) + calculateIntangiblesTotal(b);
                return totalB - totalA;
            });

            pitchers.forEach((p, idx) => {
                const pt = p.pitching || {};
                const mechanics = calculateAverageScore(pt.evaluation || {}, 'mechanics').toFixed(1);
                const athleticism = calculateAverageScore(pt.evaluation || {}, 'athleticism').toFixed(1);
                const numPitches = pt.numPitches || 0;
                const pitchingTotal = calculatePitchingTotal(p);
                const baserunning = calculateBaserunningTotal(p);
                const hitting = calculateHittingTotal(p);
                const infield = calculateInfieldTotal(p);
                const outfield = calculateOutfieldTotal(p);
                const throwing = calculateThrowingTotal(p);
                const intangibles = calculateIntangiblesTotal(p);
                const grandTotal = pitchingTotal + baserunning + hitting + infield + outfield + throwing + intangibles;

                csv += `${idx + 1},"${p.name}",${mechanics},${athleticism},${numPitches},${pitchingTotal.toFixed(1)},${baserunning.toFixed(1)},${hitting.toFixed(1)},${infield.toFixed(1)},${outfield.toFixed(1)},${throwing.toFixed(1)},${intangibles.toFixed(1)},${grandTotal.toFixed(1)}\n`;
            });

            // =====================
            // PITCHER PITCH-BY-PITCH DETAILS
            // =====================
            csv += '\n\n--- PITCHER PITCH DETAILS ---\n';

            pitchers.forEach(p => {
                const pt = p.pitching || {};
                csv += `\n"${p.name}" Pitches:\n`;
                csv += 'Pitch Type,Speed 1 (mph),Speed 2 (mph),Control (1-5)\n';

                if (pt.pitches && pt.pitches.length > 0) {
                    pt.pitches.forEach(pitch => {
                        const speed1 = pitch.speeds?.[0] || '';
                        const speed2 = pitch.speeds?.[1] || '';
                        const control = pitch.control || '';
                        csv += `"${pitch.type}",${speed1},${speed2},${control}\n`;
                    });
                } else {
                    csv += '(No pitches recorded)\n';
                }
            });

            // =====================
            // BASERUNNING DETAILS
            // =====================
            csv += '\n\n--- BASERUNNING DETAILS ---\n';
            csv += 'Name,H-1B Att1,H-1B Att2,H-1B Avg,H-1B Score,2B-H Att1,2B-H Att2,2B-H Avg,2B-H Score,Pro Agility 1,Pro Agility 2,Pro Agility Avg,Pro Agility Score,Broad Jump 1,Broad Jump 2,Broad Jump Avg,Broad Jump Score,Total\n';

            sortedAll.forEach(p => {
                const b = p.baserunning || {};
                const h1b = b.h1b || { times: [null, null], missed1b: [false, false] };
                const tbh = b['2bh'] || { times: [null, null], missed3b: [false, false] };
                const exp = b.explosiveness || {};

                const h1bTimes = h1b.times || [null, null];
                const h1bMissed = h1b.missed1b || [false, false];
                const h1bAdj1 = h1bTimes[0] !== null ? (h1bTimes[0] + (h1bMissed[0] ? 0.5 : 0)) : '';
                const h1bAdj2 = h1bTimes[1] !== null ? (h1bTimes[1] + (h1bMissed[1] ? 0.5 : 0)) : '';
                const h1bAvg = getAdjustedAvgH1B(h1b);
                const h1bScore = calculateSpeedScore('h1b', h1bAvg);

                const tbhTimes = tbh.times || [null, null];
                const tbhMissed = tbh.missed3b || [false, false];
                const tbhAdj1 = tbhTimes[0] !== null ? (tbhTimes[0] + (tbhMissed[0] ? 1 : 0)) : '';
                const tbhAdj2 = tbhTimes[1] !== null ? (tbhTimes[1] + (tbhMissed[1] ? 1 : 0)) : '';
                const tbhAvg = getAdjustedAvg2BH(tbh);
                const tbhScore = calculateSpeedScore('2bh', tbhAvg);

                const proAgility = exp.proAgility || [null, null];
                const proAg1 = proAgility[0] !== null ? proAgility[0] : '';
                const proAg2 = proAgility[1] !== null ? proAgility[1] : '';
                const proAgAvg = getAverageTime(proAgility) || '';
                const proAgScore = calculateProAgilityScore(proAgility);

                const broadJump = exp.broadJump || [null, null];
                const formatBJValue = (val) => {
                    if (!val) return '';
                    if (typeof val === 'object') return `${val.feet || 0}'${val.inches || 0}"`;
                    return val;
                };
                const bj1 = formatBJValue(broadJump[0]);
                const bj2 = formatBJValue(broadJump[1]);
                const bjAvg = getAverageBroadJump(broadJump);
                const bjAvgStr = bjAvg ? `${bjAvg.feet}'${bjAvg.inches}"` : '';
                const bjScore = calculateBroadJumpScore(broadJump);

                const total = calculateBaserunningTotal(p);

                csv += `"${p.name}",${h1bAdj1},${h1bAdj2},${h1bAvg},${h1bScore},${tbhAdj1},${tbhAdj2},${tbhAvg},${tbhScore},${proAg1},${proAg2},${proAgAvg},${proAgScore},${bj1},${bj2},${bjAvgStr},${bjScore},${total.toFixed(1)}\n`;
            });

            // =====================
            // HITTING DETAILS
            // =====================
            csv += '\n\n--- HITTING DETAILS ---\n';
            csv += 'Name,Bat Speed 1,Bat Speed 2,Bat Speed Avg,Bat Speed Score,Balance,Bat Path,Contact,Timing,High Motor,Total\n';

            sortedAll.forEach(p => {
                const h = p.hitting || {};
                const batSpeed = h.batSpeed || [null, null];
                const bs1 = batSpeed[0] !== null ? batSpeed[0] : '';
                const bs2 = batSpeed[1] !== null ? batSpeed[1] : '';
                const bsAvg = getAverageBatSpeed(batSpeed);
                const bsAvgStr = bsAvg !== null ? bsAvg.toFixed(1) : '';
                const bsScore = calculateBatSpeedScore(batSpeed);

                const balance = calculateAverageScore(h.evaluation || {}, 'balance').toFixed(1);
                const batPath = calculateAverageScore(h.evaluation || {}, 'batPath').toFixed(1);
                const contact = calculateAverageScore(h.evaluation || {}, 'contact').toFixed(1);
                const timing = calculateAverageScore(h.evaluation || {}, 'timing').toFixed(1);
                const highMotor = calculateAverageScore(h.evaluation || {}, 'highMotor').toFixed(1);

                const total = calculateHittingTotal(p);

                csv += `"${p.name}",${bs1},${bs2},${bsAvgStr},${bsScore},${balance},${batPath},${contact},${timing},${highMotor},${total.toFixed(1)}\n`;
            });

            // =====================
            // INFIELD DETAILS
            // =====================
            csv += '\n\n--- INFIELD DETAILS ---\n';
            csv += 'Name,Fielding Mech,Arm Str/Acc,Receiving Mech,MI Feed Mech,Agility/Expl,High Motor,Total\n';

            sortedAll.forEach(p => {
                const inf = p.infield || {};
                const fieldingMechanics = calculateAverageScore(inf.evaluation || {}, 'fieldingMechanics').toFixed(1);
                const armStrength = calculateAverageScore(inf.evaluation || {}, 'armStrength').toFixed(1);
                const receivingMechanics = calculateAverageScore(inf.evaluation || {}, 'receivingMechanics').toFixed(1);
                const miFeedMechanics = calculateAverageScore(inf.evaluation || {}, 'miFeedMechanics').toFixed(1);
                const agilityExplosiveness = calculateAverageScore(inf.evaluation || {}, 'agilityExplosiveness').toFixed(1);
                const highMotor = calculateAverageScore(inf.evaluation || {}, 'highMotor').toFixed(1);

                const total = calculateInfieldTotal(p);

                csv += `"${p.name}",${fieldingMechanics},${armStrength},${receivingMechanics},${miFeedMechanics},${agilityExplosiveness},${highMotor},${total.toFixed(1)}\n`;
            });

            // =====================
            // OUTFIELD DETAILS
            // =====================
            csv += '\n\n--- OUTFIELD DETAILS ---\n';
            csv += 'Name,Fielding Mech,Arm Str/Acc,Range/Agility,Fly Ball Pos/Trans,High Motor,Total\n';

            sortedAll.forEach(p => {
                const outf = p.outfield || {};
                const fieldingMechanics = calculateAverageScore(outf.evaluation || {}, 'fieldingMechanics').toFixed(1);
                const armStrength = calculateAverageScore(outf.evaluation || {}, 'armStrength').toFixed(1);
                const rangeAgility = calculateAverageScore(outf.evaluation || {}, 'rangeAgility').toFixed(1);
                const flyBallTransition = calculateAverageScore(outf.evaluation || {}, 'flyBallTransition').toFixed(1);
                const highMotor = calculateAverageScore(outf.evaluation || {}, 'highMotor').toFixed(1);

                const total = calculateOutfieldTotal(p);

                csv += `"${p.name}",${fieldingMechanics},${armStrength},${rangeAgility},${flyBallTransition},${highMotor},${total.toFixed(1)}\n`;
            });

            // =====================
            // THROWING DETAILS
            // =====================
            csv += '\n\n--- THROWING DETAILS ---\n';
            csv += 'Name,Velocity 1,Velocity 2,Velocity Avg,Score\n';

            sortedAll.forEach(p => {
                const t = p.throwing || {};
                const velocity = t.velocity || [null, null];
                const v1 = velocity[0] !== null ? velocity[0] : '';
                const v2 = velocity[1] !== null ? velocity[1] : '';
                const vAvg = getAverageVelocity(velocity);
                const vAvgStr = vAvg !== null ? vAvg.toFixed(1) : '';
                const score = calculateThrowingTotal(p);

                csv += `"${p.name}",${v1},${v2},${vAvgStr},${score.toFixed(1)}\n`;
            });

            // =====================
            // INTANGIBLES DETAILS
            // =====================
            csv += '\n\n--- INTANGIBLES DETAILS ---\n';
            csv += 'Name,Awareness,Leadership,Enthusiasm,Total\n';

            sortedAll.forEach(p => {
                const intang = p.intangibles || {};
                const awareness = calculateAverageScore(intang.evaluation || {}, 'awareness').toFixed(1);
                const leadership = calculateAverageScore(intang.evaluation || {}, 'leadership').toFixed(1);
                const enthusiasm = calculateAverageScore(intang.evaluation || {}, 'enthusiasm').toFixed(1);

                const total = calculateIntangiblesTotal(p);

                csv += `"${p.name}",${awareness},${leadership},${enthusiasm},${total.toFixed(1)}\n`;
            });

            // =====================
            // COACH NOTES SECTION
            // =====================
            csv += '\n\n--- COACH NOTES ---\n';
            csv += 'Player,Category,Coach,Note\n';

            players.forEach(p => {
                // Catching notes
                const catchingNotes = p.catching?.notes || [];
                catchingNotes.forEach(n => {
                    csv += `"${p.name}","Catching","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Baserunning notes
                const baserunningNotes = p.baserunning?.notes || [];
                baserunningNotes.forEach(n => {
                    csv += `"${p.name}","Baserunning","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Hitting notes
                const hittingNotes = p.hitting?.notes || [];
                hittingNotes.forEach(n => {
                    csv += `"${p.name}","Hitting","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Infield notes
                const infieldNotes = p.infield?.notes || [];
                infieldNotes.forEach(n => {
                    csv += `"${p.name}","Infield","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Outfield notes
                const outfieldNotes = p.outfield?.notes || [];
                outfieldNotes.forEach(n => {
                    csv += `"${p.name}","Outfield","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Throwing notes
                const throwingNotes = p.throwing?.notes || [];
                throwingNotes.forEach(n => {
                    csv += `"${p.name}","Throwing","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Pitching notes
                const pitchingNotes = p.pitching?.notes || [];
                pitchingNotes.forEach(n => {
                    csv += `"${p.name}","Pitching","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });

                // Intangibles notes
                const intangiblesNotes = p.intangibles?.notes || [];
                intangiblesNotes.forEach(n => {
                    csv += `"${p.name}","Intangibles","${n.coach}","${(n.text || '').replace(/"/g, '""')}"\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gc_softball_tryouts.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL player data? This cannot be undone.')) {
                players = [];
                selectedPlayerId = null;
                localStorage.removeItem(STORAGE_KEY);
                renderPlayerSelect();
                renderAllPlayers();
                renderScoringArea();
                showSaveStatus('Data cleared');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            checkSession();
            selectCategory('catching');
        });
    </script>
</body>
</html>
